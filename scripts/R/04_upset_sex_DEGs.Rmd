---
title: "Upset Plot gene level among pairwise DEGs"
author: "Kimberly Olney"
date: "11/02/2022"
output: html_document
---

# Setup
```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = ".")
```
# Library packages
```{r packages}
library(UpSetR)
library(ComplexUpset)
library(ggplot2movies)
```
# Function to create tables
```{r}
fromList <- function (input) {
  # Same as original fromList()...
  elements <- unique(unlist(input))
  data <- unlist(lapply(input, function(x) {
      x <- as.vector(match(elements, x))
      }))
  data[is.na(data)] <- as.integer(0)
  data[data != 0] <- as.integer(1)
  data <- data.frame(matrix(data, ncol = length(input), byrow = F))
  data <- data[which(rowSums(data) != 0), ]
  names(data) <- names(input)
  # ... Except now it conserves your original value names!
  row.names(data) <- elements
  return(data)
  }
```
# User defined variables
```{r set_variables}
source(here::here("scripts/R", "file_paths_and_colours.R"))
condition <- c("All_samples")
tool <- "star"
# save contrast names
allComparisons <- c("LBDvsControl", 
                    "LBDvsAD", 
                    "LBDvsPA", 
                    "ADvsControl", 
                    "PAvsControl", 
                    "ADvsPA")
allComparisons # check
```
# Read in DEGs
Read table with all genes (FDRq = 1).
```{r read_DEG_table}
coef <- 1
condition <- c("XX_females")

for (i in allComparisons) {
  filepath <- paste0(
    "../../results/",
    tool,
    "/DEGs/",
    i,"_", condition,
    "_gene_DEGs_FDRq1.00.txt"
  )
  assign(paste0(i,"_", condition),
         read.delim(
           filepath,
           header = TRUE,
           sep = "\t",
           stringsAsFactors = FALSE
         ))
  # increment
  coef <- coef + 1
}

coef <- 1
condition <- c("XY_males")

for (i in allComparisons) {
  filepath <- paste0(
    "../../results/",
    tool,
    "/DEGs/",
    i,"_", condition,
    "_gene_DEGs_FDRq1.00.txt"
  )
  assign(paste0(i,"_", condition),
         read.delim(
           filepath,
           header = TRUE,
           sep = "\t",
           stringsAsFactors = FALSE
         ))
  # increment
  coef <- coef + 1
}
```

# Subset lists
```{r}
LBDvsControl_XX_females_up <- subset(LBDvsControl_XX_females, logFC > 0 & adj.P.Val <= 0.05)
LBDvsControl_XX_females_down <- subset(LBDvsControl_XX_females, logFC < 0 & adj.P.Val <= 0.05)


LBDvsControl_XY_males_up <- subset(LBDvsControl_XY_males, logFC > 0 & adj.P.Val <= 0.05)
LBDvsControl_XY_males_down <- subset(LBDvsControl_XY_males, logFC < 0 & adj.P.Val <= 0.05)
```

# Upset LBD vs Control
```{r}
list_input <- list("female down-regulated" = LBDvsControl_XX_females_down$gene_name,
                   "female up-regulated" = LBDvsControl_XX_females_up$gene_name,
                   "male down-regulated" = LBDvsControl_XY_males_down$gene_name,
                   "male up-regulated" = LBDvsControl_XY_males_up$gene_name)
data <- fromList(list_input)

upset_gene <- upset(data, set_sizes = FALSE,
      c('female down-regulated',
        'male down-regulated',
        'female up-regulated',
        'male up-regulated'),
      themes=upset_modify_themes(
        list('intersections_matrix'=theme(text=element_text(size=25),
                                          plot.margin = margin(0, 0, 0, 0, "cm")),
          'overall_sizes' = theme(axis.text.x = element_text(size =25), 
                                  plot.margin = margin(0, 0, 0, 0, "cm")))),

  queries=list(
    upset_query(set='female down-regulated', fill='blue'),
    upset_query(set='male down-regulated', fill='blue'),
    upset_query(set='female up-regulated', fill='red'),
    upset_query(set='male up-regulated', fill='red'),
    upset_query(intersect = c('female down-regulated','male down-regulated'), 
                color='blue',fill='blue', only_components = 
                  c('intersections_matrix', 'Intersection size')),
    upset_query(intersect = c('female up-regulated','male up-regulated'), 
                color='red',fill='red', only_components = 
                  c('intersections_matrix', 'Intersection size'))
  ),
  intersections = list(c('female down-regulated', 'male down-regulated'), 
                       'female down-regulated', 
                       'male down-regulated',
                       c('female up-regulated', 'male up-regulated'), 
                       'female up-regulated', 
                       'male up-regulated',
                       c('female up-regulated', 'male down-regulated'), 
                       c('female down-regulated', 'male up-regulated')
  ),
  base_annotations=list(
    'Intersection size'=(
        intersection_size(
        size=1,
        text = list(size = 7),
        text_mapping = aes(),
        bar_number_threshold=1,  # show all numbers on top of bars
        width=0.3,   # reduce width of the bars
        mapping=aes(fill='bars_color')
      )
      + scale_fill_manual(values=c('grey'), guide='none')
      + scale_y_continuous(expand=expansion(mult=c(0, 0.1)))
      + theme(axis.text.y = element_text(size = 25),
              axis.title.y = element_text(size = 25),
          panel.grid.major=element_blank(),
          panel.grid.minor=element_blank(),
          plot.margin = margin(0, 0, 0, 0, "cm"), 
          axis.line=element_line(colour='black')))),
  matrix=intersection_matrix(
      geom=geom_point(
        shape='circle filled',
        size=5,
        stroke=0.45)) +
        theme(axis.text.y = element_text(size = 25),
              axis.title.y = element_text(size = 25), 
              plot.margin = margin(0, 0, 0, 0, "cm")),
    sort_sets=FALSE,
  sort_intersections=FALSE)
upset_gene
```
```{r}
upset_gene
path <-
  paste0(
    "../../results/",
    tool,
    "/upset/",
    "LBDvsControl_bt_sexes_upset_plot"
  )
saveToPDF(paste0(path, ".pdf"), width = 10, height = 6)
dev.off()
```
# Output gene lists of shared and unique
```{r}
# Binary table with colnames:
write.table(
  data,
  paste0("../../results/",
  tool,
  "/upset/", 
  "Upset_LBDvsControl_bt_sexes_gene_list_binary_results.txt"),
  sep = "\t",
  quote = FALSE
)
```
# AdjPval 1.00 Find shared and unique DEGs between male and female
```{r}
# rename GeneName to gene_name to merge data sets and find intersections
FandM_df <-
  merge(LBDvsControl_XX_females, LBDvsControl_XY_males, by = "gene_name", all = T)

shared_gene_name <-
  intersect(LBDvsControl_XX_females$gene_name,
            LBDvsControl_XY_males$gene_name)
uniqueToFemale <-
  setdiff(LBDvsControl_XX_females$gene_name,
          LBDvsControl_XY_males$gene_name)
df <- subset(LBDvsControl_XX_females, gene_name %in% uniqueToFemale)
table(df$seqnames)
uniqueToMale <-
  setdiff(LBDvsControl_XY_males$gene_name,
          LBDvsControl_XX_females$gene_name)
df <- subset(LBDvsControl_XY_males, gene_name %in% uniqueToMale)
table(df$seqnames)
# Venn diagram to see total DEGs between mouse and pig
x = list(females = LBDvsControl_XX_females$gene_name,
         males = LBDvsControl_XY_males$gene_name)
library(ggvenn)
MandF_venn <- ggvenn(
  x,
  fill_color = c("orange", "olivedrab"),
  stroke_size = 2,
  set_name_size = 6, 
  text_size =6, 
)
MandF_venn
```

## correlation plot - all
```{r}
FandM_df[is.na(FandM_df)] <- 0
FandM_df <- subset(FandM_df, adj.P.Val.x <= 0.05 | adj.P.Val.y <= 0.05)
FandM_df_sub <- subset(FandM_df, 
                               (logFC.x < -0.25 & logFC.y < -0.5) | 
                               (logFC.x > 1 & logFC.y > 0.5) | 
                               (logFC.x > .5 & logFC.y <= 0) |
                              (logFC.x <= 0 & logFC.y > 0.5))

upfemales_downmales <- subset(FandM_df, (logFC.x > 0 & logFC.y <= 0) & adj.P.Val.x <= 0.05)
upmales_downfemales <- subset(FandM_df, (logFC.x <= 0 & logFC.y > 0) & adj.P.Val.y <= 0.05)
sharedup <- subset(FandM_df, logFC.x > 0 & logFC.y > 0)
shareddown <- subset(FandM_df, logFC.x < 0 & logFC.y < 0)

write.table(
  upfemales_downmales,
  paste0("../../results/",
  tool,
  "/correlation/", 
  "LBDvsControl_upF_downM.txt"),
  sep = "\t",
  quote = FALSE,
  row.names = FALSE
)

write.table(
  upmales_downfemales,
  paste0("../../results/",
  tool,
  "/correlation/", 
  "LBDvsControl_upM_downF.txt"),
  sep = "\t",
  quote = FALSE,
  row.names = FALSE
)

write.table(
  sharedup,
  paste0("../../results/",
  tool,
  "/correlation/", 
  "LBDvsControl_sharedUP.txt"),
  sep = "\t",
  quote = FALSE,
  row.names = FALSE
)

write.table(
  shareddown,
  paste0("../../results/",
  tool,
  "/correlation/", 
  "LBDvsControl_sharedDOWN.txt"),
  sep = "\t",
  quote = FALSE,
  row.names = FALSE
)
```

```{r}
corr_plot_adjPval_1 <- ggplot(data = FandM_df, aes(x = logFC.x, y = logFC.y, text = paste(gene_name))) +
   annotate(
    "rect",
    xmin = 0,
    xmax = 2.5,
    ymin = 1.25,
    ymax = 0,
    fill = "lightpink3",
    alpha = .5
  ) +  annotate(
    "rect",
    xmin = 0,
    xmax = -1.5,
    ymin = 0,
    ymax = -1.5,
    fill = "cadetblue3",
    alpha = .5) +
#  geom_abline(color = "gray40") +
    geom_text_repel(
    data = FandM_df_sub, 
    aes(
    x = logFC.x, 
    y = logFC.y,
    label = gene_name
    ),
    color = "black",
    fontface = "italic",
    size = 7, 
    max.overlaps = getOption("ggrepel.max.overlaps", default = 15)
    ) +
  geom_point(size = 2) + 
  theme_bw() +
  theme(plot.title = element_text(size = 30)) +
  theme(legend.position = "none") +
  theme(axis.title.x = element_text(size = 26),
        axis.text.x = element_text(size = 26)) +
  theme(axis.title.y = element_text(size = 26),
        axis.text.y = element_text(size = 26)) +
  labs(
  title = "DEGs shared and unique between the sexes",
  x = expression(paste("XX female ", log[2](DLB/control))),
  y = expression(paste("XY male ", log[2](DLB/control))))+
  scale_y_continuous(breaks = seq(-1.5, 1.25, by = .5), limits = c(-1.5, 1.25), expand = c(0,0)) +
  scale_x_continuous(breaks = seq(-1.5, 2.25, by = .5), limits = c(-1.5, 2.5), expand = c(0,0))
corr_plot_adjPval_1
```
```{r}
corr_plot_adjPval_1
path <-
  paste0(
    "../../results/",
    tool,
    "/correlation/",
    "LBDvsControl_bt_sexes"
  )
saveToPDF(paste0(path, ".pdf"), width = 14.75, height = 13)
```


## up in females, down or not expressed in males
```{r}
upfemales_downmales <- subset(FandM_df, (logFC.x >= 0 & logFC.y <= 0) & adj.P.Val.x <= 0.05)
color_values <- vector()
max <- nrow(upfemales_downmales)

for(i in 1:max){
  if (upfemales_downmales$seqnames.x[i] == "chrX"){
      color_values <- c(color_values, 1) # 1 when logFC > 0 and FDRq < 0.05
    }
    else if (upfemales_downmales$seqnames.y[i] == "chrX"){
      color_values <- c(color_values, 2) # 2 when logFC < 0 and FDRq < 0.05
    }
  else{
    color_values <- c(color_values, 3) # 3 when FDRq >= 0.05
  }
}

upfemales_downmales$color_p0.05 <- factor(color_values)

X_linked <- subset(upfemales_downmales, seqnames.x == "chrX" | seqnames.y == "chrX")
Y_linked <- subset(upfemales_downmales, seqnames.x == "chrY" | seqnames.y == "chrY")
sub <- subset(upfemales_downmales, !(gene_name %in% c(Y_linked$gene_name, X_linked$gene_name)))
```

```{r}
up_female_corr_plot <- ggplot(data = upfemales_downmales, aes(x = logFC.x, y = logFC.y, color = color_p0.05, shape = color_p0.05, text = paste(gene_name))) +
     annotate(
    "rect",
    xmin = 0,
    xmax = 1.25,
    ymin = -1,
    ymax = 0,
    fill = "orange",
    alpha = .2
  ) +
  scale_shape_manual(values = c(4, 17,19)) +
    scale_color_manual(values = c("purple", "darkgreen", "black")) +  
  # geom_abline(color = "gray40") +
    geom_text_repel(
    data = sub, 
    aes(
    x = logFC.x, 
    y = logFC.y,
    label = gene_name
    ),
    color = "black",
    fontface = "italic",
    size = 6, 
    max.overlaps = getOption("ggrepel.max.overlaps", default = 5)
    ) +
  geom_text_repel(
    data = X_linked,
    aes(
      x = logFC.x,
      y = logFC.y,
      label = gene_name
    ),
    color = "purple",
    fontface = "italic",
    size = 6,
  #  nudge_x = .05,
   # nudge_y = -.005,
    max.overlaps = getOption("ggrepel.max.overlaps", default = 10)
  ) +
    geom_text_repel(
    data = Y_linked,
    aes(
      x = logFC.x,
      y = logFC.y,
      label = gene_name
    ),
    color = "darkgreen",
    fontface = "italic",
    size = 6,
   # nudge_x = .05,
   # nudge_y = -.005,
    max.overlaps = getOption("ggrepel.max.overlaps", default = 10)
  ) +
  geom_point(size = 2) + 
  theme_bw() +
  theme(plot.title = element_text(size = 30)) +
  theme(legend.position = "none") +
  theme(axis.title.x = element_text(size = 26),
        axis.text.x = element_text(size = 26)) +
  theme(axis.title.y = element_text(size = 26),
        axis.text.y = element_text(size = 26)) +
  labs(
  title = "",
  x = expression(paste("female ", log[2](FC))),
  y = expression(paste("male ", log[2](FC))))
up_female_corr_plot
```
```{r}
up_female_corr_plot
path <-
  paste0(
    "../../results/",
    tool,
    "/correlation/",
    "up_female_down_male_corr"
  )
saveToPDF(paste0(path, ".pdf"), width = 10.45, height = 5.5)
dev.off()
```
## up in males, down or not expressed females
```{r}
upmales_downfemales <- subset(FandM_df, (logFC.x <= 0 & logFC.y >= 0) & adj.P.Val.y <= 0.05)
color_values <- vector()
max <- nrow(upmales_downfemales)

for(i in 1:max){
  if (upmales_downfemales$seqnames.x[i] == "chrX"){
      color_values <- c(color_values, 1) # 1 when logFC > 0 and FDRq < 0.05
    }
    else if (upmales_downfemales$seqnames.y[i] == "chrY"){
      color_values <- c(color_values, 2) # 2 when logFC < 0 and FDRq < 0.05
    }
  else{
    color_values <- c(color_values, 3) # 3 when FDRq >= 0.05
  }
}

upmales_downfemales$color_p0.05 <- factor(color_values)

X_linked <- subset(upmales_downfemales, seqnames.x == "chrX" | seqnames.y == "chrX")
Y_linked <- subset(upmales_downfemales, seqnames.x == "chrY" | seqnames.y == "chrY")
sub <- subset(upmales_downfemales, !(gene_name %in% c(Y_linked$gene_name, X_linked$gene_name)))
table(upmales_downfemales$seqnames.x)
```

```{r}
up_male_corr_plot <- ggplot(data = upmales_downfemales, aes(x = logFC.x, y = logFC.y, color = color_p0.05, shape = color_p0.05, text = paste(gene_name))) +
     annotate(
    "rect",
    xmin = 0,
    xmax = -.75,
    ymin = 0,
    ymax = .8,
    fill = "olivedrab",
    alpha = .2
  ) +
  scale_shape_manual(values = c(4, 17,19)) +
    scale_color_manual(values = c("purple", "darkgreen", "black")) +  
  # geom_abline(color = "gray40") +
    geom_text_repel(
    data = sub, 
    aes(
    x = logFC.x, 
    y = logFC.y,
    label = gene_name
    ),
    color = "black",
    fontface = "italic",
    size = 6, 
    max.overlaps = getOption("ggrepel.max.overlaps", default = 5)
    ) +
  geom_text_repel(
    data = X_linked,
    aes(
      x = logFC.x,
      y = logFC.y,
      label = gene_name
    ),
    color = "purple",
    fontface = "italic",
    size = 6,
  #  nudge_x = .05,
   # nudge_y = -.005,
    max.overlaps = getOption("ggrepel.max.overlaps", default = 10)
  ) +
    geom_text_repel(
    data = Y_linked,
    aes(
      x = logFC.x,
      y = logFC.y,
      label = gene_name
    ),
    color = "darkgreen",
    fontface = "italic",
    size = 6,
   # nudge_x = .05,
   # nudge_y = -.005,
    max.overlaps = getOption("ggrepel.max.overlaps", default = 10)
  ) +
  geom_point(size = 2) + 
  theme_bw() +
  theme(plot.title = element_text(size = 30)) +
  theme(legend.position = "none") +
  theme(axis.title.x = element_text(size = 26),
        axis.text.x = element_text(size = 26)) +
  theme(axis.title.y = element_text(size = 26),
        axis.text.y = element_text(size = 26)) +
  labs(
  title = "",
  x = expression(paste("female ", log[2](FC))),
  y = expression(paste("male ", log[2](FC))))
up_male_corr_plot
```
```{r}
up_male_corr_plot
path <-
  paste0(
    "../../results/",
    tool,
    "/correlation/",
    "up_male_down_female_corr"
  )
saveToPDF(paste0(path, ".pdf"), width = 10.45, height = 5.5)
dev.off()
```
# AD vs control
```{r}
ADvsControl_XX_females_up <- subset(ADvsControl_XX_females, logFC > 0 & adj.P.Val <= 0.05)
ADvsControl_XX_females_down <- subset(ADvsControl_XX_females, logFC < 0 & adj.P.Val <= 0.05)


ADvsControl_XY_males_up <- subset(ADvsControl_XY_males, logFC > 0 & adj.P.Val <= 0.05)
ADvsControl_XY_males_down <- subset(ADvsControl_XY_males, logFC < 0 & adj.P.Val <= 0.05)
```

# Upset disease vs control
```{r}
list_input <- list("female down-regulated" = ADvsControl_XX_females_down$gene_name,
                   "female up-regulated" = ADvsControl_XX_females_up$gene_name,
                   "male down-regulated" = ADvsControl_XY_males_down$gene_name,
                   "male up-regulated" = ADvsControl_XY_males_up$gene_name)
data <- fromList(list_input)

upset_gene <- upset(data, set_sizes=FALSE,
      c('female down-regulated','female up-regulated','male down-regulated', 'male up-regulated'),
  queries=list(
    upset_query(set='female down-regulated', fill='blue'),
    upset_query(set='female up-regulated', fill='red'),
    upset_query(set='male down-regulated', fill='blue'),
    upset_query(set='male up-regulated', fill='red')
  ),
  base_annotations=list(
    'Intersection size'=(
        intersection_size(
        bar_number_threshold=1,  # show all numbers on top of bars
        width=0.5,   # reduce width of the bars
      )
      # add some space on the top of the bars
      + scale_y_continuous(expand=expansion(mult=c(0, 0.5)))
      + theme(
          # hide grid lines
          panel.grid.major=element_blank(),
          panel.grid.minor=element_blank(),
          # show axis lines
          axis.line=element_line(colour='black')
      )
    )
  ),
  stripes=upset_stripes(
    geom=geom_segment(size=12),  # make the stripes larger
    colors=c('grey95', 'white')
  ),
  # to prevent connectors from getting the colorured
  # use `fill` instead of `color`, together with `shape='circle filled'`
  matrix=intersection_matrix(
      geom=geom_point(
        shape='circle filled',
        size=3,
        stroke=0.45
      )
  ),
  sort_sets='descending',
  sort_intersections='descending'
)
upset_gene
```
