---
title: "BRETIGEA deconvolution"
author: "Kimberly Olney"
date: "5/05/2023"
output: html_document
---
Brain cell type proportion analysis using BRETIGEA
The goal of BRETIGEA cell type specifity measure, which is fully described in the manuscript, is to measure whether a gene is expressed in only one cell type relative to the others.
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source(here::here("scripts/R", "file_paths_and_colours.R"))
```
# Install packages
```{r install, eval=FALSE}
install.packages("BRETIGEA")
```
# Load libraries
```{r load}
set.seed(28)
library(BRETIGEA, quietly = TRUE)
library(knitr) 
```
# Relative cell type proportion estimation
To run the brain cell type proportion estimation analysis and extract the matrix of surrogate proportion variables for each of the major six brain cell types (astrocytes, endothelial cells, microglia, neurons, oligodendrocytes, and OPCs), run this:
```{r}
dge.filtered.norm <- readRDS(paste0("../../rObjects/dge.filtered.norm.rds"))
lcpm <- edgeR::cpm(dge.filtered.norm$counts, log = TRUE)
rownames(lcpm) <- dge.filtered.norm$genes$gene_name
ct_res = brainCells(lcpm, nMarker = 50)
```
# Merge with metadata 
```{r}
info <- dge.filtered.norm$samples
ct <- as.data.frame(ct_res)
ct$NPID <- rownames(ct)
info_ct <- merge(ct, info, by = "NPID")
plot(info_ct$TYP, info_ct$neu)
```
# Plot
```{r}
metadata_continuous <-
  data.frame(
    info_ct$neu,
    info_ct$ast,
    info_ct$end,
    info_ct$mic, 
    info_ct$oli, 
    info_ct$opc 
  )

column_variables <-
  c(
    "neurons",
    "astrocytes",
    "endothelial",
    "microglia",
    "oligodendrocytes",
    "oligodendrocyte precursor"
  )
my_comparisons <-
  list(
    c("CONTROL", "PA"),
    c("CONTROL", "AD"),
    c("CONTROL", "LBD"),
    c("PA", "AD"),
    c("PA", "LBD"),
    c("AD", "LBD")
  )

violin_plot_fun <- function(i, j) {
  ggplot(info_ct, aes(TYPE, i, fill = TYPE)) +
    geom_violin() +
    geom_boxplot(width = 0.1, outlier.shape = NA, color = "black") + 
    geom_jitter(shape=16, position=position_jitter(0.2), alpha = .2, size = .75) +
    theme_bw() + 
    ggtitle(j) +
    xlab("Disease group") +
    ylab(j) +
    stat_compare_means(comparisons = my_comparisons, method="wilcox.test") +
    scale_fill_manual(values=alpha(TypeColors), 0.01) +
    theme(legend.position = "none")
}
violin_plots <-
  Map(violin_plot_fun, i = metadata_continuous, j = column_variables)
violin_plots

plotnames = imap(violin_plots, ~paste0("../../results/star/cell_type_enrichment/BRITGEA/TYPE.", .y, ".pdf")) %>%
  flatten()
plotnames
walk2(plotnames, violin_plots, ~ggsave(filename = .x, plot = .y, 
                                    height = 4, width = 5.5))
```
Calculate pairwise comparisons between group levels with corrections for multiple testing.
```{r wilcox}
# Pairwise wilcoxon test for cell type zscores and group
df <- Matrix(0, 6, 6)
rownames(df) <- colnames(info_ct)[2:7]
colnames(df) <- c("CONTROL_vs_PA","CONTROL_vs_AD","CONTROL_vs_LBD",
                  "PA_vs_AD","PA_vs_LBD","AD_vs_LBD")
for (i in colnames(info_ct)[2:7]) {
  pwt <- pairwise.wilcox.test(info_ct[[i]], 
                              info_ct$TYPE,
                              p.adjust.method = "BH")
  pwt <- pwt$p.value
  df[i,"CONTROL_vs_PA"] <- pwt["PA","CONTROL"]
  df[i,"CONTROL_vs_AD"] <- pwt["AD","CONTROL"]
  df[i,"CONTROL_vs_LBD"] <- pwt["LBD","CONTROL"]
  df[i,"PA_vs_AD"] <- pwt["AD","PA"]
  df[i,"PA_vs_LBD"] <- pwt["LBD","PA"]
  df[i,"AD_vs_LBD"] <- pwt["LBD","AD"]
}
pwt <- df
remove(df)
pwt <- as.data.frame(as.matrix(pwt))
write.table(pwt, 
  paste0(
    "../../results/star/cell_type_enrichment/BRITGEA/TYPE.pairwise_Wilcox_zscore_BH.tsv"
  ),
  sep = "\t",
  quote = FALSE,
  row.names = TRUE
)
```

# nMarker parameter
Note that the above analysis uses nMarker = 50 marker genes. A notable trade-off in the selection of the number of marker genes to include in the analysis is that the more marker genes you use, the more likely you are to average out any cell type-specific expression changes that may occur across groups in your sample. On the other hand, the fewer marker genes you use, the higher-quality these marker genes will tend to be in terms of strength of cell type specificity. We have chose nMarker = 50 because it has been a reasonable number in our experince, but the goals of your analysis may differ and you may want to choose a different number of marker genes for each cell type.
Note that only marker genes which have been measured in your data set will be used by the cell type proportion estimates, so if your data set has fewer gene measurements (e.g., in a proteomics data set), that may be a reason to use fewer marker genes.

# Correlation 
Comparing these cell type proportion estimates to the independent immunohistochemistry quantifications of two marker genes (IBA1 and GFAP), you can see that the correlation is strong.
```{r}
cor_mic = cor.test(ct_res[, "mic"], as.numeric(aba_pheno_data$ihc_iba1_ffpe), method = "spearman")
print(cor_mic)

cor_ast = cor.test(ct_res[, "ast"], as.numeric(aba_pheno_data$ihc_gfap_ffpe), method = "spearman")
print(cor_ast)
```
# Cell proportion PCA
The default cell type proportion estimation method is singular value decomposition, but if you want to use PCA, that is an option as well.
species can be either human, mouse, or combined
```{r}
ct_res = brainCells(lcpm, nMarker = 50, species = "combined", method = "PCA")
```

#--------
```{r}
brain_cells_adjusted = adjustBrainCells(lcpm, nMarker = 50, species = "combined")
adj_exp <- brain_cells_adjusted$expression
```
