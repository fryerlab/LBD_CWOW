---
title: "Variance in expression data"
author: "Kimberly Olney, Ph.D."
date: "01/06/2023"
output:
  html_document:
    df_print: paged
  pdf_document: default
params:
  args: myarg
---
# Setup
```{r setup}
knitr::opts_knit$set(root.dir = ".")
```

```{r libraries, message=FALSE, warning=FALSE}
library('variancePartition')
library('edgeR')
library('BiocParallel')
library('Hmisc')
```

# User defined variables
```{r set_variables}
source(here::here("scripts/R", "file_paths_and_colours.R"))
source(here::here("scripts/R", "gtf_path.R"))
condition <- c("All_samples")
min_expression <- "min_exp1"
tool = c("star")
typeOfCount <-  c(".bamReadsPerGene.out.tab")
```
# Read in DGE object & metadata
```{r}
dge.filtered.norm <- readRDS(paste0("../../rObjects/", condition, "_", min_expression, ".dge.filtered.norm.rds"))
# some samples are missing RIN values. 
# Replace NA with median RIN. 
# This is necessary to be able include RIN as a covariate in voom
# fill missing values of marks2 with median
dge.filtered.norm$samples$RIN <- impute(dge.filtered.norm$samples$RIN, median)
# one sample is missing VaD information
dge.filtered.norm$samples$VaD <- impute(dge.filtered.norm$samples$VaD, median)
dge.filtered.norm$samples$flowcell_and_lane <- factor(dge.filtered.norm$samples$flowcell_and_lane)
dge.filtered.norm$samples$APOE <- factor(dge.filtered.norm$samples$APOE, levels = c("E2E3", "E3E3", "E2E4", "E3E4", "E4E4"))

info <- as.data.frame(dge.filtered.norm$samples)
genes <- dge.filtered.norm$genes
log2cpm.norm <- edgeR::cpm(dge.filtered.norm, log = TRUE)

# add a new column with TYPE + sex inferred
dge.filtered.norm$samples$TYPE_sex_inferred <- paste0(dge.filtered.norm$samples$TYPE, "_", dge.filtered.norm$samples$sex_inferred)
dge.filtered.norm$samples$TYPE_sex_inferred <- factor(dge.filtered.norm$samples$TYPE_sex_inferred, 
                                                      levels = c("CONTROL_male", "CONTROL_female", 
                                                                 "AD_male", "AD_female", 
                                                                 "PA_male", "PA_female", 
                                                                 "LBD_male", "LBD_female"))
```

# Design matrix
```{r}
design <-
  model.matrix(~ 0 +
      TYPE_sex_inferred +
      scale(RIN) + 
      APOE +
      flowcell_and_lane + 
      scale(PCT_CODING_BASES) + 
      scale(PCT_INTERGENIC_BASES) + 
      scale(PCT_INTRONIC_BASES),
    dge.filtered.norm$samples
  )

colnames(design) <-
  c("CONTROL_male", 
    "CONTROL_female", 
    "AD_male", 
    "AD_female", 
    "PA_male",
    "PA_female", 
    "LBD_male",
    "LBD_female",
    "RIN",
    "APOEE3E3",
    "APOEE2E4",
    "APOEE3E4",
    "APOEE4E4",
    "Batch1",
    "Batch2",
    "Batch3",
    "Batch4",
    "Batch5",
    "Batch6",
    "Batch7",
    "PCT_CODING_BASES",
    "PCT_INTERGENIC_BASES",
    "PCT_INTRONIC_BASES"
  )
```
# Voom
When the library sizes are quite variable between samples, then the voom approach is theoretically more powerful than limma-trend. 
If the data are very noisy, one can apply the same between-array normalization methods as would be used for microarrays, for example:
```{r voom}
form <- (~ 0 +
      TYPE_sex_inferred +
      scale(RIN) + 
      APOE +
      flowcell_and_lane + 
      scale(PCT_CODING_BASES) + 
      scale(PCT_INTERGENIC_BASES) + 
      scale(PCT_INTRONIC_BASES)
)
voom_with_weights_and_covariates <-
  variancePartition::voomWithDreamWeights(
    counts = dge.filtered.norm$counts,
    formula = form,
    data = dge.filtered.norm$samples,
    BPPARAM = BiocParallel::SnowParam(cores),
    plot = TRUE
  )
path <-
  paste0("../../results/",
         tool,
         "/voom/",
         condition,
         "_",
         min_expression,
         "_gene_mean_voom_with_weights_and_covariates_TYPE_SEX")
saveToPDF(paste0(path, ".pdf"), width = 6, height = 4)

voomCounts_covariates <- voom_with_weights_and_covariates$E
voomCountsMatrix <- voom_with_weights_and_covariates$E
```


```{r}
# fits linear model for each gene given a series of arrays
fit <- lmFit(voom_with_weights_and_covariates, design)
coef.fit <- fit$coefficients

colnames(design)
contrasts <- makeContrasts(
  LBDvsControl = (LBD_male + LBD_female)/2 - (CONTROL_male + CONTROL_female)/2,
  LBDvsAD = (LBD_male + LBD_female)/2 - (AD_male + AD_female)/2,
  LBDvsPA = (LBD_male + LBD_female)/2 - (PA_male + PA_female)/2,
  ADvsControl = (AD_male + AD_female)/2 - (CONTROL_male + CONTROL_female)/2,
  PAvsControl = (PA_male + PA_female)/2 - (CONTROL_male + CONTROL_female)/2,
  ADvsPA = (AD_male + AD_female)/2 - (PA_male + PA_female)/2,
  male_LBDvsControl = LBD_male - CONTROL_male,
  male_LBDvsAD = LBD_male  - AD_male,
  male_LBDvsPA = LBD_male - PA_male,
  male_ADvsControl = AD_male - CONTROL_male,
  male_PAvsControl = PA_male - CONTROL_male,
  male_ADvsPA = AD_male  - PA_male,
  female_LBDvsControl = LBD_female - CONTROL_female,
  female_LBDvsAD = LBD_female  - AD_female,
  female_LBDvsPA = LBD_female - PA_female,
  female_ADvsControl = AD_female - CONTROL_female,
  female_PAvsControl = PA_female - CONTROL_female,
  female_ADvsPA = AD_female  - PA_female,
  male_LBD_vs_female_LBD = LBD_male - LBD_female, 
  female_LBD_vs_male_LBD = LBD_female - LBD_male, 
  male_AD_vs_female_AD = AD_male - AD_female, 
  female_AD_vs_male_AD = AD_female - AD_male, 
  male_PA_vs_female_PA = PA_male - PA_female, 
  female_PA_vs_male_PA = PA_female - PA_male, 
  male_Control_vs_female_Control = CONTROL_male - CONTROL_female, 
  female_Control_vs_male_Control = CONTROL_female - CONTROL_male, 
  ADvsControl_interaction_female = ((AD_female - AD_male) - (CONTROL_female - CONTROL_male)),
  ADvsControl_interaction_male = ((AD_male - AD_female) - (CONTROL_male - CONTROL_female)),
  PAvsControl_interaction_female = ((PA_female - PA_male) - (CONTROL_female - CONTROL_male)),
  PAvsControl_interaction_male = ((PA_male - PA_female) - (CONTROL_male - CONTROL_female)),
  LBDvsControl_interaction_female = ((LBD_female - LBD_male) - (CONTROL_female - CONTROL_male)),
  LBDvsControl_interaction_male = ((LBD_male - LBD_female) - (CONTROL_male - CONTROL_female)),
  levels = colnames(design))
contrasts

help(makeContrasts)

# save contrast names
allComparisons <- colnames(contrasts)
allComparisons # check

# run contrast analysis
vfit <- contrasts.fit(fit, contrasts = contrasts)

# Compute differential expression based on the empirical Bayes moderation of the
# standard errors towards a common value.
# The logCPM values can then be used in any standard limma pipeline, using the trend=TRUE
# argument when running eBayes or treat. For example:
veBayesFit <- eBayes(vfit, trend = TRUE, robust=TRUE)
plotSA(veBayesFit, main = "Final Model: Mean-variance Trend")

# Rather than worry about the normalization too much, better to explore the data. E.g. try a BCV plot to look for dispersion outliers, or try robust=TRUE with eBayes() to downweight dispersion outliers. 

#disp <- estimateDisp(dge.filtered.norm, design, robust=TRUE)
#plotBCV(disp)
```

# DEGs summary
```{r}
pval <- 0.05
lfc.cutoff <- 0.25

sumTable <- 
  summary(decideTests(
    veBayesFit,  # object
    adjust.method = "BH", # by default the method = "separate"
    p.value = pval,
    lfc = lfc.cutoff  # numeric, minimum absolute log2-fold change required
  ))

print(paste0(" FDRq < ", pval,
             " & absolute log2-fold change > ", lfc.cutoff))
sumTable
```
# Add gene information to DEGs
reformat genes table to only include relevant information
```{r}
genes_relevant <- select(genes, 1:4,10:12)
```
Check AD vs Control
```{r}
ADvsControl <- topTable(
  veBayesFit, 
  coef = "LBDvsControl_interaction_female", # female_AD_vs_male_AD, female_Control_vs_male_Control,  ADvsControl, ADvsControl_interaction_female, ADvsControl_interaction_male, female_ADvsControl, male_ADvsControl
  n = Inf, 
  p.value = 1,
  lfc = 0, 
  sort.by = "P", 
  genelist = genes_relevant, 
  confint = TRUE # column of confidence interval 
    )
subset(ADvsControl, gene_name == "IL3RA") 
# within AD female_AD_vs_male_AD 8.913649 up in females 
# within controls female_Control_vs_male_Control 8.391023 up in females 
# AD vs Control all samples 0.3 up in AD, FDRq = 0.03883119 (not regressing out the effect of sex)
# ADvsControl_interaction_female 0.522 up and not significant, FDRq = 0.9996765
# female_ADvsControl 0.5883286 up FDRq = 0.008118471	
# male_ADvsControl 0.06570235 no significant 
# regressing out sex 0.4828615 FDRq = 0.0005156221
```
# Save objects
```{r}
saveRDS(veBayesFit, file = paste0("../../rObjects/", condition, "_", min_expression,"_BIC_sex_interaction.veBayesFit.rds"))
saveRDS(voomCounts_covariates, file = paste0("../../rObjects/", condition, "_", min_expression,"_BIC_sex_interaction.voomCountsMatrix.rds"))
```
# Output DEG tables
```{r}
coef <- 1

for (i in allComparisons) {
  vTopTableAll <- topTable(
    veBayesFit, 
    coef = coef,  
    n = Inf, 
    p.value = 1,
    lfc = 0, 
    sort.by = "P", 
    genelist = genes_relevant, 
    confint = TRUE # column of confidence interval 
    )
    saveRDS(vTopTableAll, file = 
            paste0("../../rObjects/", condition, "_", 
                   i,"_gene_table.rds"))
  path <- paste0("../../results/", tool, "/DEGs/", condition, "_BIC_sex_interaction_", 
  i, "_gene_DEGs_FDRq1.00.txt", sep = "") 
  write.table(
    vTopTableAll,
    path,
    sep = "\t",
    row.names = FALSE,
    quote = FALSE
  )
  # p < 0.05, log2fc > 0
  vTopTable1 <-
    topTable( 
      veBayesFit,  
      coef = coef,  
      n = Inf, 
      p.value = pval,
      lfc = lfc.cutoff,
      genelist = genes_relevant, 
      confint = TRUE # column of confidence interval 
    )
  path <- paste0("../../results/", tool, "/DEGs/", condition, "_BIC_sex_interaction_", 
  i, "_gene_DEGs_FDRq0.05_logFC_0.25.txt", sep = "") 
  write.table(
    vTopTable1,
    path,
    sep = "\t",
    row.names = FALSE,
    quote = FALSE
  )
  # increment 
  coef <- coef + 1
}
remove(coef)
```

```{r}
sessionInfo()
```



