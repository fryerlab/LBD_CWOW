---
title: "Upset and correlations among pairwise DEGs"
author: "Kimberly Olney"
date: "01/06/2023"
output: html_document
---

# Setup
```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = ".")
```
# Library packages
```{r packages}
library(UpSetR)
library(ComplexUpset)
library(ggplot2movies)
library(ggvenn)
library(forcats)
```
# Function to create tables
```{r}
fromList <- function (input) {
  # Same as original fromList()...
  elements <- unique(unlist(input))
  data <- unlist(lapply(input, function(x) {
      x <- as.vector(match(elements, x))
      }))
  data[is.na(data)] <- as.integer(0)
  data[data != 0] <- as.integer(1)
  data <- data.frame(matrix(data, ncol = length(input), byrow = F))
  data <- data[which(rowSums(data) != 0), ]
  names(data) <- names(input)
  # ... Except now it conserves your original value names!
  row.names(data) <- elements
  return(data)
}

makePaddedDataFrame <- function(l, ...) {
  maxlen <- max(sapply(l, length))
  data.frame(lapply(l, na.pad, len = maxlen), ...)
}
```
# User defined variables
```{r set_variables}
source(here::here("scripts/R", "file_paths_and_colours.R"))
condition <- c("All_samples")
tool <- "star"
min_expression <- "min_exp50"
# save contrast names
allComparisons <- c("LBDvsControl", 
                    "LBDvsAD", 
                    "LBDvsPA", 
                    "ADvsControl", 
                    "PAvsControl", 
                    "ADvsPA")
allComparisons # check
```
# Read in DEGs
Read table with all genes (FDRq = 1).
```{r read_DEG_table}
# sex as a covariate
coef <- 1
for (i in allComparisons) {
  filepath <- paste0(
    "../../results/",
    tool,
    "/DEGs/", condition, "_", min_expression, "_",
    i,
    "_gene_DEGs_FDRq1.00.txt"
  )
  assign(paste0(i),
         read.delim(
           filepath,
           header = TRUE,
           sep = "\t",
           stringsAsFactors = FALSE
         ))
  # increment
  coef <- coef + 1
}

# XX females only 
coef <- 1
condition <- c("XX_females")
for (i in allComparisons) {
  filepath <- paste0(
    "../../results/",
    tool,
    "/DEGs/", condition, "_", min_expression, "_",
    i,
    "_gene_DEGs_FDRq1.00.txt"
  )
  assign(paste0(i,"_", condition),
         read.delim(
           filepath,
           header = TRUE,
           sep = "\t",
           stringsAsFactors = FALSE
         ))
  # increment
  coef <- coef + 1
}

# XY males only 
coef <- 1
condition <- c("XY_males")
for (i in allComparisons) {
  filepath <- paste0(
    "../../results/",
    tool,
    "/DEGs/",condition, "_", min_expression, "_",
    i,
    "_gene_DEGs_FDRq1.00.txt"
  )
  assign(paste0(i,"_", condition),
         read.delim(
           filepath,
           header = TRUE,
           sep = "\t",
           stringsAsFactors = FALSE
         ))
  # increment
  coef <- coef + 1
}
```
# Shard and uniquely expressed genes within each sex
```{r}
shared_expression <- intersect(ADvsControl_XX_females$gene_id, ADvsControl_XY_males$gene_id)
x <- list(Females= sample(ADvsControl_XX_females$gene_name), Males = sample(ADvsControl_XY_males$gene_name))
ggvenn(x, 
  fill_color = c("orange", "#0073C2FF"),
  stroke_size = 0.5, set_name_size = 4
  )

unique_exp_females <- setdiff(ADvsControl_XX_females$gene_name, ADvsControl_XY_males$gene_name)
unique_exp_males <- setdiff(ADvsControl_XY_males$gene_name, ADvsControl_XX_females$gene_name)

unique_exp_females_df <- subset(ADvsControl_XX_females, gene_name %in% unique_exp_females)
unique_exp_females_df <- data.frame(unique_exp_females_df$seqnames, unique_exp_females_df$gene_name)
table(unique_exp_females_df$unique_exp_females_df.seqnames)

unique_exp_males_df <- subset(ADvsControl_XY_males, gene_name %in% unique_exp_males)
unique_exp_males_df <- data.frame(unique_exp_males_df$seqnames, unique_exp_males_df$gene_name)
table(unique_exp_males_df$unique_exp_males_df.seqnames)
```
# Save DEG tables
```{r}
saveRDS(LBDvsControl_XX_females, paste0("../../rObjects/LBDvsControl_", min_expression, "_XX_females.rds"))
saveRDS(LBDvsControl_XY_males, paste0("../../rObjects/LBDvsControl_", min_expression, "_XY_males.rds"))

saveRDS(ADvsControl_XX_females, paste0("../../rObjects/ADvsControl_", min_expression, "_XX_females.rds"))
saveRDS(ADvsControl_XY_males, paste0("../../rObjects/ADvsControl_", min_expression, "_XY_males.rds"))

saveRDS(PAvsControl_XX_females, paste0("../../rObjects/PAvsControl_", min_expression, "_XX_females.rds"))
saveRDS(PAvsControl_XY_males, paste0("../../rObjects/PAvsControl_", min_expression, "_XY_males.rds"))
```

# DEGs by FDRq <= 0.05
```{r}
# sex as a covariate
LBDvsControl_up <- subset(LBDvsControl, logFC > 0 & adj.P.Val <= 0.05)
LBDvsControl_down <- subset(LBDvsControl, logFC < 0 & adj.P.Val <= 0.05)
ADvsControl_up <- subset(ADvsControl, logFC > 0 & adj.P.Val <= 0.05)
ADvsControl_down <- subset(ADvsControl, logFC < 0 & adj.P.Val <= 0.05)
PAvsControl_up <- subset(PAvsControl, logFC > 0 & adj.P.Val <= 0.05)
PAvsControl_down <- subset(PAvsControl, logFC < 0 & adj.P.Val <= 0.05)

# XX females
LBDvsControl_XX_females_up <- subset(LBDvsControl_XX_females, logFC > 0 & adj.P.Val <= 0.05)
LBDvsControl_XX_females_down <- subset(LBDvsControl_XX_females, logFC < 0 & adj.P.Val <= 0.05)
ADvsControl_XX_females_up <- subset(ADvsControl_XX_females, logFC > 0 & adj.P.Val <= 0.05)
ADvsControl_XX_females_down <- subset(ADvsControl_XX_females, logFC < 0 & adj.P.Val <= 0.05)
PAvsControl_XX_females_up <- subset(PAvsControl_XX_females, logFC > 0 & adj.P.Val <= 0.05)
PAvsControl_XX_females_down <- subset(PAvsControl_XX_females, logFC < 0 & adj.P.Val <= 0.05)

# XY males
LBDvsControl_XY_males_up <- subset(LBDvsControl_XY_males, logFC > 0 & adj.P.Val <= 0.05)
LBDvsControl_XY_males_down <- subset(LBDvsControl_XY_males, logFC < 0 & adj.P.Val <= 0.05)
ADvsControl_XY_males_up <- subset(ADvsControl_XY_males, logFC > 0 & adj.P.Val <= 0.05)
ADvsControl_XY_males_down <- subset(ADvsControl_XY_males, logFC < 0 & adj.P.Val <= 0.05)
PAvsControl_XY_males_up <- subset(PAvsControl_XY_males, logFC > 0 & adj.P.Val <= 0.05)
PAvsControl_XY_males_down <- subset(PAvsControl_XY_males, logFC < 0 & adj.P.Val <= 0.05)
```

# Upset of DEGs
### LBD vs Control bt the sexes 
```{r}
list_input <- list("female down-regulated" = LBDvsControl_XX_females_down$gene_name,
                   "female up-regulated" = LBDvsControl_XX_females_up$gene_name,
                   "male down-regulated" = LBDvsControl_XY_males_down$gene_name,
                   "male up-regulated" = LBDvsControl_XY_males_up$gene_name)
data <- fromList(list_input)

upset_gene <- upset(data, set_sizes = FALSE,
      c('female down-regulated',
        'male down-regulated',
        'female up-regulated',
        'male up-regulated'),
      themes=upset_modify_themes(
        list('intersections_matrix'=theme(text=element_text(size=10),
              plot.margin = margin(0, 0, 0, 0, "cm")),
          'overall_sizes' = theme(axis.text.x = element_text(size =10), 
               plot.margin = margin(0, 0, 0, 0, "cm")))),
  queries=list(
    upset_query(set='female down-regulated', fill='blue'),
    upset_query(set='male down-regulated', fill='blue'),
    upset_query(set='female up-regulated', fill='red'),
    upset_query(set='male up-regulated', fill='red'),
    upset_query(intersect = c('female down-regulated','male down-regulated'), 
               fill='blue', only_components = 
                  c('intersections_matrix', 'Intersection size')),
    upset_query(intersect = c('female up-regulated','male up-regulated'), 
                fill='red', only_components = 
                  c('intersections_matrix', 'Intersection size'))
  ),
  intersections = list(c('female down-regulated', 'male down-regulated'), 
                       'female down-regulated', 
                       'male down-regulated',
                       c('female up-regulated', 'male up-regulated'), 
                       'female up-regulated', 
                       'male up-regulated',
                       c('female up-regulated', 'male down-regulated'), 
                       c('female down-regulated', 'male up-regulated')
  ),
  base_annotations=list(
    'Intersection size'=(
        intersection_size(
        size=2,
        text = list(size = 3),
        text_mapping = aes(),
        bar_number_threshold=3,  # show all numbers on top of bars
        width=0.3,   # reduce width of the bars
        mapping=aes(fill='bars_color')
      )
      + scale_fill_manual(values=c('grey'), guide='none')
      + scale_y_continuous(expand=expansion(mult=c(0, 0.5)))
      + theme(axis.text.y = element_text(size = 10),
              axis.title.y = element_text(size = 10),
          panel.grid.major=element_blank(),
          panel.grid.minor=element_blank(),
          plot.margin = margin(0, 0, 0, 0, "cm"), 
          axis.line=element_line(colour='black')))),
  matrix=intersection_matrix(
      geom=geom_point(
        shape='circle filled',
        size=2,
        stroke=0.45)) +
        theme(axis.text.y = element_text(size = 10),
              axis.title.y = element_text(size = 10), 
              plot.margin = margin(0, 0, 0, 0, "cm")),
    sort_sets=FALSE,
  sort_intersections=FALSE)
upset_gene

# save
path <- paste0("../../results/", tool, 
               "/upset/LBDvsControl_gene_bt_sexes_FDRq0.05")
saveToPDF(paste0(path, ".pdf"), width = 5, height = 4)

# Binary table with colnames:
write.table(
  data,
  paste0("../../results/",
  tool,
  "/upset/", 
  "LBDvsControl_gene_bt_sexes_list_binary_results.txt"),
  sep = "\t",
  quote = FALSE
)
```

```{r}
female_down_regulated <-
  subset(
    data,
    `female down-regulated` == 1 &
      `female up-regulated` == 0  &
      `male down-regulated` == 0 &
      `male up-regulated` == 0
  )

female_up_regulated <-
  subset(
    data,
    `female down-regulated` == 0 &
      `female up-regulated` == 1  &
      `male down-regulated` == 0 &
      `male up-regulated` == 0
  )

male_down_regulated <-
  subset(
    data,
    `female down-regulated` == 0 &
      `female up-regulated` == 0  &
      `male down-regulated` == 1 &
      `male up-regulated` == 0
  )

male_up_regulated <-
  subset(
    data,
    `female down-regulated` == 0 &
      `female up-regulated` == 0  &
      `male down-regulated` == 0 &
      `male up-regulated` == 1
  )

na.pad <- function(x, len) {
  x[1:len]
}

df <-
  makePaddedDataFrame(
    list(
      "female down-regulated" = row.names(female_down_regulated),
      "female up-regulated" = row.names(female_up_regulated),
      "male down-regulated" = row.names(male_down_regulated),
      "male up-regulated" = row.names(male_up_regulated)
    )
  )
df[is.na(df)] <- ""
write.table(
  df,
  paste0("../../results/",
  tool,
  "/upset/", 
  "LBDvsControl_gene_bt_sexes_list_gene_names.txt"
), row.names = FALSE, quote = FALSE, sep = "\t")
```

### LBD vs Control with sex as a covariate 
```{r}
list_input <- list("sex covariate down-regulated" = LBDvsControl_down$gene_name,
                   "sex covariate up-regulated" = LBDvsControl_up$gene_name,
                   "female down-regulated" = LBDvsControl_XX_females_down$gene_name,
                   "female up-regulated" = LBDvsControl_XX_females_up$gene_name,
                   "male down-regulated" = LBDvsControl_XY_males_down$gene_name,
                   "male up-regulated" = LBDvsControl_XY_males_up$gene_name)
data <- fromList(list_input)

upset_gene <- upset(data, set_sizes = FALSE,
      c('sex covariate down-regulated',
        'female down-regulated',
        'male down-regulated',
        'sex covariate up-regulated',
        'female up-regulated',
        'male up-regulated'),
      themes=upset_modify_themes(
        list('intersections_matrix'=theme(text=element_text(size=10),
              plot.margin = margin(0, 0, 0, 0, "cm")),
          'overall_sizes' = theme(axis.text.x = element_text(size =10), 
              plot.margin = margin(0, 0, 0, 0, "cm")))),
  queries=list(
    upset_query(set='sex covariate down-regulated', fill='blue'),
    upset_query(set='female down-regulated', fill='blue'),
    upset_query(set='male down-regulated', fill='blue'),
    upset_query(set='sex covariate up-regulated', fill='red'),
    upset_query(set='female up-regulated', fill='red'),
    upset_query(set='male up-regulated', fill='red')
  ),
  intersections = list(c('sex covariate down-regulated','female down-regulated', 'male down-regulated'), 
                       c('sex covariate down-regulated', 'female down-regulated'), 
                       c('sex covariate down-regulated', 'male down-regulated'), 
                       c('female down-regulated', 'male down-regulated'), 
                       'sex covariate down-regulated',
                       'female down-regulated', 
                       'male down-regulated',
                       c('sex covariate up-regulated','female up-regulated', 'male up-regulated'), 
                       c('sex covariate up-regulated', 'female up-regulated'), 
                       c('sex covariate up-regulated', 'male up-regulated'), 
                       c('female up-regulated', 'male up-regulated'), 
                       'sex covariate up-regulated',
                       'female up-regulated', 
                       'male up-regulated',
                       c('female up-regulated', 'male down-regulated'), 
                       c('female down-regulated', 'male up-regulated')
  ),
  base_annotations=list(
    'Intersection size'=(
        intersection_size(
        size=2,
        text = list(size = 3),
        text_mapping = aes(),
        bar_number_threshold=3,  # show all numbers on top of bars
        width=0.3,   # reduce width of the bars
        mapping=aes(fill='bars_color')
      )
      + scale_fill_manual(values=c('grey'), guide='none')
      + scale_y_continuous(expand=expansion(mult=c(0, 0.5)))
      + theme(axis.text.y = element_text(size = 10),
              axis.title.y = element_text(size = 10),
          panel.grid.major=element_blank(),
          panel.grid.minor=element_blank(),
          plot.margin = margin(0, 0, 0, 0, "cm"), 
          axis.line=element_line(colour='black')))),
  matrix=intersection_matrix(
      geom=geom_point(
        shape='circle filled',
        size=2,
        stroke=0.45)) +
        theme(axis.text.y = element_text(size = 10),
              axis.title.y = element_text(size = 10), 
              plot.margin = margin(0, 0, 0, 0, "cm")),
    sort_sets=FALSE,
  sort_intersections=FALSE)
upset_gene

# save
path <- paste0("../../results/", tool, 
               "/upset/LBDvsControl_gene_sex_covariate_FDRq0.05")
saveToPDF(paste0(path, ".pdf"), width = 6, height = 4)

upset(data, intersect = c('sex covariate down-regulated',
        'female down-regulated',
        'male down-regulated',
        'sex covariate up-regulated',
        'female up-regulated',
        'male up-regulated'))

path <- paste0("../../results/", tool,
               "/upset/LBDvsControl_gene_sex_covariate_FDRq0.05_simple")
saveToPDF(paste0(path, ".pdf"), width = 9, height = 6)

# Binary table with colnames:
write.table(
  data,
  paste0("../../results/",
  tool,
  "/upset/", 
  "LBDvsControl_gene_sex_covariate_list_binary_results.txt"),
  sep = "\t",
  quote = FALSE
)
```

### LBD DEGs specific to each sex 
```{r}
# merge the male and female data frames 
# this will get the logFC for the female and male only analysis
LBD_FandM <-
  merge(LBDvsControl_XX_females,
        LBDvsControl_XY_males,
        by = "gene_name",
        all = T)
# remove unnecessary columns 
LBD_FandM <- LBD_FandM[-c(3:5,7,8,11,12,14:21,24,25,27)]
colnames(LBD_FandM) = c("gene_name", "chr", "gene_id", "female_logFC", "female_AveExpr", "female_adj.P.Val", "male_logFC", "male_AveExpr", "male_adj.P.Val")
# uniquely up or down in the females 
# not DE in the male only or sex as a covariate
LBD_uniquely_up_females <-
  subset(data,
    `female up-regulated` == 1 &
    `female down-regulated` == 0 &
    `male down-regulated` == 0 &
    `sex covariate down-regulated` == 0 &
    `sex covariate up-regulated` == 0 & 
    `male up-regulated` == 0
  )
LBD_uniquely_down_females <-
  subset(data,
    `female down-regulated` == 1 &
    `female up-regulated` == 0 &
    `male down-regulated` == 0 &
    `sex covariate down-regulated` == 0 &
    `sex covariate up-regulated` == 0 & 
    `male up-regulated` == 0
  )

# combine with LBD df to get fold change information 
LBD_uniquely_up_females_df <-
  subset(LBD_FandM, gene_name %in% rownames(LBD_uniquely_up_females))

# further sort
# up in females and not also up in males, at least less than logFC of 0.025
LBD_uniquely_up_females_df_subset <-
  subset(LBD_uniquely_up_females_df, female_logFC > 0.25 & male_logFC <= 0.0)
write.table(
  LBD_uniquely_up_females_df_subset,
  paste0(
    "../../results/",
    tool,
    "/upset/",
    "LBD_uniquely_up_females.txt"
  ),
  sep = "\t",
  quote = FALSE,
  row.names = FALSE
)
# repeat for down regulated 
LBD_uniquely_down_females_df <-
  subset(LBD_FandM, gene_name %in% rownames(LBD_uniquely_down_females))
# further sort
LBD_uniquely_down_females_df_subset <-
  subset(LBD_uniquely_down_females_df, female_logFC < -0.25 & male_logFC >= 0)
write.table(
  LBD_uniquely_down_females_df_subset,
  paste0(
    "../../results/",
    tool,
    "/upset/",
    "LBD_uniquely_down_females.txt"
  ),
  sep = "\t",
  quote = FALSE,
  row.names = FALSE
)

# repeat for males
LBD_uniquely_up_males <-
  subset(data,
    `male up-regulated` == 1 &
    `female down-regulated` == 0 &
    `male down-regulated` == 0 &
    `sex covariate down-regulated` == 0 &
    `sex covariate up-regulated` == 0 & 
    `female up-regulated` == 0
  )
LBD_uniquely_down_males <-
  subset(data,
    `male down-regulated` == 1 &
    `female up-regulated` == 0 &
    `female down-regulated` == 0 &
    `sex covariate down-regulated` == 0 &
    `sex covariate up-regulated` == 0 & 
    `male up-regulated` == 0
  )

LBD_uniquely_up_males_df <-
  subset(LBD_FandM, gene_name %in% rownames(LBD_uniquely_up_males))
LBD_uniquely_up_males_df_subset <-
  subset(LBD_uniquely_up_males_df, male_logFC > 0.25 & female_logFC <= 0)
write.table(
  LBD_uniquely_up_males_df_subset,
  paste0(
    "../../results/",
    tool,
    "/upset/",
    "LBD_uniquely_up_males.txt"
  ),
  sep = "\t",
  quote = FALSE,
  row.names = FALSE
)

LBD_uniquely_down_males_df <-
  subset(LBD_FandM, gene_name %in% rownames(LBD_uniquely_down_males))
LBD_uniquely_down_males_df_subset <-
  subset(LBD_uniquely_down_males_df, male_logFC < -0.25 & female_logFC >= 0)
write.table(
  LBD_uniquely_down_males_df_subset,
  paste0(
    "../../results/",
    tool,
    "/upset/",
    "LBD_uniquely_down_males.txt"
  ),
  sep = "\t",
  quote = FALSE,
  row.names = FALSE
)
remove(data)
```

### AD vs Control bt the sexes
```{r}
list_input <- list("female down-regulated" = ADvsControl_XX_females_down$gene_name,
                   "female up-regulated" = ADvsControl_XX_females_up$gene_name,
                   "male down-regulated" = ADvsControl_XY_males_down$gene_name,
                   "male up-regulated" = ADvsControl_XY_males_up$gene_name)
data <- fromList(list_input)

upset_gene <- upset(data, set_sizes = FALSE,
      c('female down-regulated',
        'male down-regulated',
        'female up-regulated',
        'male up-regulated'),
      themes=upset_modify_themes(
        list('intersections_matrix'=theme(text=element_text(size=10),
              plot.margin = margin(0, 0, 0, 0, "cm")),
          'overall_sizes' = theme(axis.text.x = element_text(size =10), 
              plot.margin = margin(0, 0, 0, 0, "cm")))),
  queries=list(
    upset_query(set='female down-regulated', fill='blue'),
    upset_query(set='male down-regulated', fill='blue'),
    upset_query(set='female up-regulated', fill='red'),
    upset_query(set='male up-regulated', fill='red'),
    upset_query(intersect = c('female down-regulated','male down-regulated'), 
               fill='blue', only_components = 
                  c('intersections_matrix', 'Intersection size')),
    upset_query(intersect = c('female up-regulated','male up-regulated'), 
                fill='red', only_components = 
                  c('intersections_matrix', 'Intersection size'))
  ),
  intersections = list(c('female down-regulated', 'male down-regulated'), 
                       'female down-regulated', 
                       'male down-regulated',
                       c('female up-regulated', 'male up-regulated'), 
                       'female up-regulated', 
                       'male up-regulated',
                       c('female up-regulated', 'male down-regulated'), 
                       c('female down-regulated', 'male up-regulated')
  ),
  base_annotations=list(
    'Intersection size'=(
        intersection_size(
        size=2,
        text = list(size = 3),
        text_mapping = aes(),
        bar_number_threshold=3,  # show all numbers on top of bars
        width=0.3,   # reduce width of the bars
        mapping=aes(fill='bars_color')
      )
      + scale_fill_manual(values=c('grey'), guide='none')
      + scale_y_continuous(expand=expansion(mult=c(0, 0.5)))
      + theme(axis.text.y = element_text(size = 10),
              axis.title.y = element_text(size = 10),
          panel.grid.major=element_blank(),
          panel.grid.minor=element_blank(),
          plot.margin = margin(0, 0, 0, 0, "cm"), 
          axis.line=element_line(colour='black')))),
  matrix=intersection_matrix(
      geom=geom_point(
        shape='circle filled',
        size=2,
        stroke=0.45)) +
        theme(axis.text.y = element_text(size = 10),
              axis.title.y = element_text(size = 10), 
              plot.margin = margin(0, 0, 0, 0, "cm")),
    sort_sets=FALSE,
  sort_intersections=FALSE)
upset_gene

# save
path <- paste0("../../results/", tool, 
               "/upset/ADvsControl_gene_bt_sexes_FDRq0.05")
saveToPDF(paste0(path, ".pdf"), width = 5, height = 4)

write.table(
  data,
  paste0("../../results/",
  tool,
  "/upset/", 
  "ADvsControl_gene_bt_sexes_list_binary_results.txt"),
  sep = "\t",
  quote = FALSE
)
```

### AD vs Control with sex as a covariate
```{r}
list_input <- list("sex covariate down-regulated" = ADvsControl_down$gene_name,
                   "sex covariate up-regulated" = ADvsControl_up$gene_name,
                   "female down-regulated" = ADvsControl_XX_females_down$gene_name,
                   "female up-regulated" = ADvsControl_XX_females_up$gene_name,
                   "male down-regulated" = ADvsControl_XY_males_down$gene_name,
                   "male up-regulated" = ADvsControl_XY_males_up$gene_name)
data <- fromList(list_input)

upset_gene <- upset(data, set_sizes = FALSE,
      c('sex covariate down-regulated',
        'female down-regulated',
        'male down-regulated',
        'sex covariate up-regulated',
        'female up-regulated',
        'male up-regulated'),
      themes=upset_modify_themes(
        list('intersections_matrix'=theme(text=element_text(size=10),
                                          plot.margin = margin(0, 0, 0, 0, "cm")),
          'overall_sizes' = theme(axis.text.x = element_text(size =10), 
                                  plot.margin = margin(0, 0, 0, 0, "cm")))),

  queries=list(
    upset_query(set='sex covariate down-regulated', fill='blue'),
    upset_query(set='female down-regulated', fill='blue'),
    upset_query(set='male down-regulated', fill='blue'),
    upset_query(set='sex covariate up-regulated', fill='red'),
    upset_query(set='female up-regulated', fill='red'),
    upset_query(set='male up-regulated', fill='red')
  ),
  intersections = list(c('sex covariate down-regulated','female down-regulated', 'male down-regulated'), 
                       c('sex covariate down-regulated', 'female down-regulated'), 
                       c('sex covariate down-regulated', 'male down-regulated'), 
                       c('female down-regulated', 'male down-regulated'), 
                       'sex covariate down-regulated',
                       'female down-regulated', 
                       'male down-regulated',
                       c('sex covariate up-regulated','female up-regulated', 'male up-regulated'), 
                       c('sex covariate up-regulated', 'female up-regulated'), 
                       c('sex covariate up-regulated', 'male up-regulated'), 
                       c('female up-regulated', 'male up-regulated'), 
                       'sex covariate up-regulated',
                       'female up-regulated', 
                       'male up-regulated',
                       c('female up-regulated', 'male down-regulated'), 
                       c('female down-regulated', 'male up-regulated')
  ),
  base_annotations=list(
    'Intersection size'=(
        intersection_size(
        size=2,
        text = list(size = 3),
        text_mapping = aes(),
        bar_number_threshold=3,  # show all numbers on top of bars
        width=0.3,   # reduce width of the bars
        mapping=aes(fill='bars_color')
      )
      + scale_fill_manual(values=c('grey'), guide='none')
      + scale_y_continuous(expand=expansion(mult=c(0, 0.5)))
      + theme(axis.text.y = element_text(size = 10),
              axis.title.y = element_text(size = 10),
          panel.grid.major=element_blank(),
          panel.grid.minor=element_blank(),
          plot.margin = margin(0, 0, 0, 0, "cm"), 
          axis.line=element_line(colour='black')))),
  matrix=intersection_matrix(
      geom=geom_point(
        shape='circle filled',
        size=2,
        stroke=0.45)) +
        theme(axis.text.y = element_text(size = 10),
              axis.title.y = element_text(size = 10), 
              plot.margin = margin(0, 0, 0, 0, "cm")),
    sort_sets=FALSE,
  sort_intersections=FALSE)
upset_gene

# save
path <- paste0("../../results/", tool, "/upset/ADvsControl_gene_sex_covariate_FDRq0.05")
saveToPDF(paste0(path, ".pdf"), width = 6, height = 4)

upset(data, intersect = c('sex covariate down-regulated',
        'female down-regulated',
        'male down-regulated',
        'sex covariate up-regulated',
        'female up-regulated',
        'male up-regulated'))

path <- paste0("../../results/", tool, "/upset/ADvsControl_gene_sex_covariate_FDRq0.05_simple")
saveToPDF(paste0(path, ".pdf"), width = 9, height = 6)

# Binary table with colnames:
write.table(
  data,
  paste0("../../results/",
  tool,
  "/upset/", 
  "ADvsControl_gene_sex_covariate_list_binary_results.txt"),
  sep = "\t",
  quote = FALSE
)
```
### AD DEGs specific to each sex 
```{r}
# merge the male and female data frames 
# this will get the logFC for the female and male only analysis
AD_FandM <-
  merge(ADvsControl_XX_females,
        ADvsControl_XY_males,
        by = "gene_name",
        all = T)
# remove unnecessary columns 
AD_FandM <- AD_FandM[-c(3:5,7,8,11,12,14:21,24,25,27)]
colnames(AD_FandM) = c("gene_name", "chr", "gene_id", "female_logFC", "female_AveExpr", "female_adj.P.Val", "male_logFC", "male_AveExpr", "male_adj.P.Val")
# uniquely up or down in the females 
# not DE in the male only or sex as a covariate
AD_uniquely_up_females <-
  subset(data,
    `female up-regulated` == 1 &
    `female down-regulated` == 0 &
    `male down-regulated` == 0 &
    `sex covariate down-regulated` == 0 &
    `sex covariate up-regulated` == 0 & 
    `male up-regulated` == 0
  )
AD_uniquely_down_females <-
  subset(data,
    `female down-regulated` == 1 &
    `female up-regulated` == 0 &
    `male down-regulated` == 0 &
    `sex covariate down-regulated` == 0 &
    `sex covariate up-regulated` == 0 & 
    `male up-regulated` == 0
  )

# combine with AD df to get fold change information 
AD_uniquely_up_females_df <-
  subset(AD_FandM, gene_name %in% rownames(AD_uniquely_up_females))

# further sort
# up in females and not also up in males, at least less than logFC of 0.025
AD_uniquely_up_females_df_subset <-
  subset(AD_uniquely_up_females_df, female_logFC > 0.25 & male_logFC <= 0)
write.table(
  AD_uniquely_up_females_df_subset,
  paste0(
    "../../results/",
    tool,
    "/upset/",
    "AD_uniquely_up_females.txt"
  ),
  sep = "\t",
  quote = FALSE,
  row.names = FALSE
)
# repeat for down regulated 
AD_uniquely_down_females_df <-
  subset(AD_FandM, gene_name %in% rownames(AD_uniquely_down_females))
# further sort
AD_uniquely_down_females_df_subset <-
  subset(AD_uniquely_down_females_df, female_logFC < -0.25 & male_logFC >= 0)
write.table(
  AD_uniquely_down_females_df_subset,
  paste0(
    "../../results/",
    tool,
    "/upset/",
    "AD_uniquely_down_females.txt"
  ),
  sep = "\t",
  quote = FALSE,
  row.names = FALSE
)

# repeat for males
AD_uniquely_up_males <-
  subset(data,
    `male up-regulated` == 1 &
    `female down-regulated` == 0 &
    `male down-regulated` == 0 &
    `sex covariate down-regulated` == 0 &
    `sex covariate up-regulated` == 0 & 
    `female up-regulated` == 0
  )
AD_uniquely_down_males <-
  subset(data,
    `male down-regulated` == 1 &
    `female up-regulated` == 0 &
    `female down-regulated` == 0 &
    `sex covariate down-regulated` == 0 &
    `sex covariate up-regulated` == 0 & 
    `male up-regulated` == 0
  )

AD_uniquely_up_males_df <-
  subset(AD_FandM, gene_name %in% rownames(AD_uniquely_up_males))
AD_uniquely_up_males_df_subset <-
  subset(AD_uniquely_up_males_df, male_logFC > 0.25 & female_logFC <= 0)
write.table(
  AD_uniquely_up_males_df_subset,
  paste0(
    "../../results/",
    tool,
    "/upset/",
    "AD_uniquely_up_males.txt"
  ),
  sep = "\t",
  quote = FALSE,
  row.names = FALSE
)

AD_uniquely_down_males_df <-
  subset(AD_FandM, gene_name %in% rownames(AD_uniquely_down_males))
AD_uniquely_down_males_df_subset <-
  subset(AD_uniquely_down_males_df, male_logFC < -0.25 & female_logFC >= 0)
write.table(
  AD_uniquely_down_males_df_subset,
  paste0(
    "../../results/",
    tool,
    "/upset/",
    "AD_uniquely_down_males.txt"
  ),
  sep = "\t",
  quote = FALSE,
  row.names = FALSE
)

remove(data)
```
### PA vs Control bt the sexes 
```{r}
list_input <- list("female down-regulated" = PAvsControl_XX_females_down$gene_name,
                   "female up-regulated" = PAvsControl_XX_females_up$gene_name,
                   "male down-regulated" = PAvsControl_XY_males_down$gene_name,
                   "male up-regulated" = PAvsControl_XY_males_up$gene_name)
data <- fromList(list_input)

upset_gene <- upset(data, set_sizes = FALSE,
      c('female down-regulated',
        'male down-regulated',
        'female up-regulated',
        'male up-regulated'),
      themes=upset_modify_themes(
        list('intersections_matrix'=theme(text=element_text(size=10),
              plot.margin = margin(0, 0, 0, 0, "cm")),
          'overall_sizes' = theme(axis.text.x = element_text(size =10), 
               plot.margin = margin(0, 0, 0, 0, "cm")))),
  queries=list(
    upset_query(set='female down-regulated', fill='blue'),
    upset_query(set='male down-regulated', fill='blue'),
    upset_query(set='female up-regulated', fill='red'),
    upset_query(set='male up-regulated', fill='red'),
    upset_query(intersect = c('female down-regulated','male down-regulated'), 
               fill='blue', only_components = 
                  c('intersections_matrix', 'Intersection size')),
    upset_query(intersect = c('female up-regulated','male up-regulated'), 
                fill='red', only_components = 
                  c('intersections_matrix', 'Intersection size'))
  ),
  intersections = list(c('female down-regulated', 'male down-regulated'), 
                       'female down-regulated', 
                       'male down-regulated',
                       c('female up-regulated', 'male up-regulated'), 
                       'female up-regulated', 
                       'male up-regulated',
                       c('female up-regulated', 'male down-regulated'), 
                       c('female down-regulated', 'male up-regulated')
  ),
  base_annotations=list(
    'Intersection size'=(
        intersection_size(
        size=2,
        text = list(size = 3),
        text_mapping = aes(),
        bar_number_threshold=3,  # show all numbers on top of bars
        width=0.3,   # reduce width of the bars
        mapping=aes(fill='bars_color')
      )
      + scale_fill_manual(values=c('grey'), guide='none')
      + scale_y_continuous(expand=expansion(mult=c(0, 0.5)))
      + theme(axis.text.y = element_text(size = 10),
              axis.title.y = element_text(size = 10),
          panel.grid.major=element_blank(),
          panel.grid.minor=element_blank(),
          plot.margin = margin(0, 0, 0, 0, "cm"), 
          axis.line=element_line(colour='black')))),
  matrix=intersection_matrix(
      geom=geom_point(
        shape='circle filled',
        size=2,
        stroke=0.45)) +
        theme(axis.text.y = element_text(size = 10),
              axis.title.y = element_text(size = 10), 
              plot.margin = margin(0, 0, 0, 0, "cm")),
    sort_sets=FALSE,
  sort_intersections=FALSE)
upset_gene

# save
path <- paste0("../../results/", tool, 
               "/upset/PAvsControl_gene_bt_sexes_FDRq0.05")
saveToPDF(paste0(path, ".pdf"), width = 5, height = 4)

# Binary table with colnames:
write.table(
  data,
  paste0("../../results/",
  tool,
  "/upset/", 
  "PAvsControl_gene_bt_sexes_list_binary_results.txt"),
  sep = "\t",
  quote = FALSE
)
```

### PA vs Control with sex as a covariate 
```{r}
list_input <- list("sex covariate down-regulated" = PAvsControl_down$gene_name,
                   "sex covariate up-regulated" = PAvsControl_up$gene_name,
                   "female down-regulated" = PAvsControl_XX_females_down$gene_name,
                   "female up-regulated" = PAvsControl_XX_females_up$gene_name,
                   "male down-regulated" = PAvsControl_XY_males_down$gene_name,
                   "male up-regulated" = PAvsControl_XY_males_up$gene_name)
data <- fromList(list_input)

upset_gene <- upset(data, set_sizes = FALSE,
      c('sex covariate down-regulated',
        'female down-regulated',
        'male down-regulated',
        'sex covariate up-regulated',
        'female up-regulated',
        'male up-regulated'),
      themes=upset_modify_themes(
        list('intersections_matrix'=theme(text=element_text(size=10),
              plot.margin = margin(0, 0, 0, 0, "cm")),
          'overall_sizes' = theme(axis.text.x = element_text(size =10), 
              plot.margin = margin(0, 0, 0, 0, "cm")))),
  queries=list(
    upset_query(set='sex covariate down-regulated', fill='blue'),
    upset_query(set='female down-regulated', fill='blue'),
    upset_query(set='male down-regulated', fill='blue'),
    upset_query(set='sex covariate up-regulated', fill='red'),
    upset_query(set='female up-regulated', fill='red'),
    upset_query(set='male up-regulated', fill='red')
  ),
  intersections = list(c('sex covariate down-regulated','female down-regulated', 'male down-regulated'), 
                       c('sex covariate down-regulated', 'female down-regulated'), 
                       c('sex covariate down-regulated', 'male down-regulated'), 
                       c('female down-regulated', 'male down-regulated'), 
                       'sex covariate down-regulated',
                       'female down-regulated', 
                       'male down-regulated',
                       c('sex covariate up-regulated','female up-regulated', 'male up-regulated'), 
                       c('sex covariate up-regulated', 'female up-regulated'), 
                       c('sex covariate up-regulated', 'male up-regulated'), 
                       c('female up-regulated', 'male up-regulated'), 
                       'sex covariate up-regulated',
                       'female up-regulated', 
                       'male up-regulated',
                       c('female up-regulated', 'male down-regulated'), 
                       c('female down-regulated', 'male up-regulated')
  ),
  base_annotations=list(
    'Intersection size'=(
        intersection_size(
        size=2,
        text = list(size = 3),
        text_mapping = aes(),
        bar_number_threshold=3,  # show all numbers on top of bars
        width=0.3,   # reduce width of the bars
        mapping=aes(fill='bars_color')
      )
      + scale_fill_manual(values=c('grey'), guide='none')
      + scale_y_continuous(expand=expansion(mult=c(0, 0.5)))
      + theme(axis.text.y = element_text(size = 10),
              axis.title.y = element_text(size = 10),
          panel.grid.major=element_blank(),
          panel.grid.minor=element_blank(),
          plot.margin = margin(0, 0, 0, 0, "cm"), 
          axis.line=element_line(colour='black')))),
  matrix=intersection_matrix(
      geom=geom_point(
        shape='circle filled',
        size=2,
        stroke=0.45)) +
        theme(axis.text.y = element_text(size = 10),
              axis.title.y = element_text(size = 10), 
              plot.margin = margin(0, 0, 0, 0, "cm")),
    sort_sets=FALSE,
  sort_intersections=FALSE)
upset_gene

# save
path <- paste0("../../results/", tool, 
               "/upset/PAvsControl_gene_sex_covariate_FDRq0.05")
saveToPDF(paste0(path, ".pdf"), width = 6, height = 4)

upset(data, intersect = c('sex covariate down-regulated',
        'female down-regulated',
        'male down-regulated',
        'sex covariate up-regulated',
        'female up-regulated',
        'male up-regulated'))

path <- paste0("../../results/", tool,
               "/upset/PAvsControl_gene_sex_covariate_FDRq0.05_simple")
saveToPDF(paste0(path, ".pdf"), width = 9, height = 6)

# Binary table with colnames:
write.table(
  data,
  paste0("../../results/",
  tool,
  "/upset/", 
  "PAvsControl_gene_sex_covariate_list_binary_results.txt"),
  sep = "\t",
  quote = FALSE
)
```

### PA DEGs specific to each sex 
```{r, eval=FALSE}
# merge the male and female data frames 
# this will get the logFC for the female and male only analysis
PA_FandM <-
  merge(PAvsControl_XX_females,
        PAvsControl_XY_males,
        by = "gene_name",
        all = T)
# remove unnecessary columns 
PA_FandM <- PA_FandM[-c(3:5,7,8,11,12,14:21,24,25,27)]
colnames(PA_FandM) = c("gene_name", "chr", "gene_id", "female_logFC", "female_AveExpr", "female_adj.P.Val", "male_logFC", "male_AveExpr", "male_adj.P.Val")
# uniquely up or down in the females 
# not DE in the male only or sex as a covariate
PA_uniquely_up_females <-
  subset(data,
    `female up-regulated` == 1 &
    `female down-regulated` == 0 &
    `male down-regulated` == 0 &
    `sex covariate down-regulated` == 0 &
    `sex covariate up-regulated` == 0 & 
    `male up-regulated` == 0
  )
PA_uniquely_down_females <-
  subset(data,
    `female down-regulated` == 1 &
    `female up-regulated` == 0 &
    `male down-regulated` == 0 &
    `sex covariate down-regulated` == 0 &
    `sex covariate up-regulated` == 0 & 
    `male up-regulated` == 0
  )

# combine with PA df to get fold change information 
PA_uniquely_up_females_df <-
  subset(PA_FandM, gene_name %in% rownames(PA_uniquely_up_females))

# further sort
# up in females and not also up in males, at least less than logFC of 0.025
PA_uniquely_up_females_df_subset <-
  subset(PA_uniquely_up_females_df, female_logFC > 0.25 & male_logFC <= 0)
write.table(
  PA_uniquely_up_females_df_subset,
  paste0(
    "../../results/",
    tool,
    "/upset/",
    "PA_uniquely_up_females.txt"
  ),
  sep = "\t",
  quote = FALSE,
  row.names = FALSE
)
# repeat for down regulated 
PA_uniquely_down_females_df <-
  subset(PA_FandM, gene_name %in% rownames(PA_uniquely_down_females))
# further sort
PA_uniquely_down_females_df_subset <-
  subset(PA_uniquely_down_females_df, female_logFC < -0.25 & male_logFC >= 0)
write.table(
  PA_uniquely_down_females_df_subset,
  paste0(
    "../../results/",
    tool,
    "/upset/",
    "PA_uniquely_down_females.txt"
  ),
  sep = "\t",
  quote = FALSE,
  row.names = FALSE
)

# repeat for males
PA_uniquely_up_males <-
  subset(data,
    `male up-regulated` == 1 &
    `female down-regulated` == 0 &
    `male down-regulated` == 0 &
    `sex covariate down-regulated` == 0 &
    `sex covariate up-regulated` == 0 & 
    `female up-regulated` == 0
  )
PA_uniquely_down_males <-
  subset(data,
    `male down-regulated` == 1 &
    `female up-regulated` == 0 &
    `female down-regulated` == 0 &
    `sex covariate down-regulated` == 0 &
    `sex covariate up-regulated` == 0 & 
    `male up-regulated` == 0
  )

PA_uniquely_up_males_df <-
  subset(PA_FandM, gene_name %in% rownames(PA_uniquely_up_males))
PA_uniquely_up_males_df_subset <-
  subset(PA_uniquely_up_males_df, male_logFC > 0.25 & female_logFC <= 0)
write.table(
  PA_uniquely_up_males_df_subset,
  paste0(
    "../../results/",
    tool,
    "/upset/",
    "PA_uniquely_up_males.txt"
  ),
  sep = "\t",
  quote = FALSE,
  row.names = FALSE
)

PA_uniquely_down_males_df <-
  subset(PA_FandM, gene_name %in% rownames(PA_uniquely_down_males))
PA_uniquely_down_males_df_subset <-
  subset(PA_uniquely_down_males_df, male_logFC < -0.25 & female_logFC >= 0)
write.table(
  PA_uniquely_down_males_df_subset,
  paste0(
    "../../results/",
    tool,
    "/upset/",
    "PA_uniquely_down_males.txt"
  ),
  sep = "\t",
  quote = FALSE,
  row.names = FALSE
)

remove(data)
```


# Correlation plot
### LBD vs control bt the sexes 
```{r}
# table formatting
LBD_FandM[is.na(LBD_FandM)] <- 0
LBD_FandM <- subset(LBD_FandM, female_adj.P.Val <= 0.05 | male_adj.P.Val <= 0.05)
LBD_FandM_goi <- subset(LBD_FandM, 
                               (female_logFC < -0.25 & male_logFC < -0.5) | 
                               (female_logFC > 1 & male_logFC > 0.5) | 
                               (female_logFC > .5 & male_logFC <= 0) |
                              (female_logFC <= 0 & male_logFC > 0.25))

LBD_upfemales_downmales <- subset(LBD_FandM, (female_logFC > 0 & male_logFC <= 0) 
                                  & female_adj.P.Val <= 0.05)
LBD_upmales_downfemales <- subset(LBD_FandM, (female_logFC <= 0 & male_logFC > 0)
                                  & male_adj.P.Val <= 0.05)
LBD_sharedup <- subset(LBD_FandM, female_logFC > 0 & male_logFC > 0)
LBD_shareddown <- subset(LBD_FandM, female_logFC < 0 & male_logFC < 0)

write.table(
  LBD_upfemales_downmales,
  paste0("../../results/",
  tool,
  "/correlation/", 
  "LBDvsControl_upF_downM.txt"),
  sep = "\t",
  quote = FALSE,
  row.names = FALSE
)

write.table(
  LBD_upmales_downfemales,
  paste0("../../results/",
  tool,
  "/correlation/", 
  "LBDvsControl_upM_downF.txt"),
  sep = "\t",
  quote = FALSE,
  row.names = FALSE
)

write.table(
  LBD_sharedup,
  paste0("../../results/",
  tool,
  "/correlation/", 
  "LBDvsControl_shared_bt_sexes_up.txt"),
  sep = "\t",
  quote = FALSE,
  row.names = FALSE
)

write.table(
  LBD_shareddown,
  paste0("../../results/",
  tool,
  "/correlation/", 
  "LBDvsControl_shared_bt_sexes_down.txt"),
  sep = "\t",
  quote = FALSE,
  row.names = FALSE
)

# plot
LBD_corr_plot_adjPval_1 <- ggplot(data = LBD_FandM, 
   aes(x = female_logFC, y = male_logFC, text = paste(gene_name))) +
   annotate(
    "rect",
    xmin = 0,
    xmax = 2.5,
    ymin = 2.5,
    ymax = 0,
    fill = "lightpink3",
    alpha = .5
  ) +  annotate(
    "rect",
    xmin = 0,
    xmax = -2,
    ymin = 0,
    ymax = -2,
    fill = "cadetblue3",
    alpha = .5) +
  geom_abline(color = "gray40") +
    geom_text_repel(
    data = LBD_FandM_goi, 
    aes(
    x = female_logFC, 
    y = male_logFC,
    label = gene_name
    ),
    color = "black",
    fontface = "italic",
    size = 2.5, 
    max.overlaps = getOption("ggrepel.max.overlaps", default = 15)
    ) +
  geom_point(size = 1) + 
  theme_bw() +
  theme(plot.title = element_text(size = 10)) +
  theme(legend.position = "none") +
  theme(axis.title.x = element_text(size = 10),
        axis.text.x = element_text(size = 10)) +
  theme(axis.title.y = element_text(size = 10),
        axis.text.y = element_text(size = 10)) +
  labs(
  title = "DEGs shared and unique between the sexes",
  x = expression(paste("XX female ", log[2](LBD/control))),
  y = expression(paste("XY male ", log[2](LBD/control))))+
  scale_y_continuous(breaks = seq(-1.75, 2.25, by = .5), 
                     limits = c(-2, 2.5), expand = c(0,0)) +
  scale_x_continuous(breaks = seq(-2, 2.5, by = .5), 
                     limits = c(-2, 2.5), expand = c(0,0))
LBD_corr_plot_adjPval_1 

LBD_corr_plot_adjPval_1
path <-
  paste0(
    "../../results/",
    tool,
    "/correlation/",
    "LBDvsControl_bt_sexes"
  )
saveToPDF(paste0(path, ".pdf"), width = 6.25, height = 4.5)

# Scatter plot with correlation coefficient
sp <- ggscatter(LBD_FandM, x = "female_logFC", y = "male_logFC",
   add = "reg.line",  # Add regressin line
   add.params = list(color = "blue", fill = "lightgray"), # Customize reg. line
   conf.int = TRUE # Add confidence interval
   )
# Add correlation coefficient
sp + stat_cor(method = "pearson", label.x = -1.25, label.y = 1)
path <-
  paste0(
    "../../results/",
    tool,
    "/correlation/",
    "LBDvsControl_bt_sexes_corr_pval"
  )
saveToPDF(paste0(path, ".pdf"), width = 6.25, height = 4.5)
```
#### DEGs specific to each sex
###### correlation
```{r}
# Uniquely DE in XX females
LBD_female_DEGs <- c(rownames(LBD_uniquely_up_females), rownames(LBD_uniquely_down_females))
LBD_female_DEGs <- subset(LBD_FandM, gene_name %in% LBD_female_DEGs)
LBD_female_DEGs[is.na(LBD_female_DEGs)] <- 0
LBD_female_DEGs_goi <- subset(LBD_female_DEGs, 
                        (female_logFC < -0.25 & male_logFC <= 0) | 
                          (female_logFC > .5 & male_logFC > 0.5) | 
                          (female_logFC > .5 & male_logFC <= 0) |
                          (female_logFC <= 0 & male_logFC > 0.25))

LBD_corr_female <- ggplot(data = LBD_female_DEGs, 
aes(x = female_logFC, y = male_logFC, text = paste(gene_name))) +
  annotate(
    "rect",
    xmin = 0,
    xmax = 1,
    ymin = 1,
    ymax = 0,
    fill = "lightpink3",
    alpha = .5
  ) +  annotate(
    "rect",
    xmin = 0,
    xmax = -1,
    ymin = 0,
    ymax = -1,
    fill = "cadetblue3",
    alpha = .5) +
  geom_abline(color = "gray40") +
  geom_text_repel(
    data = LBD_female_DEGs_goi, 
    aes(
      x = female_logFC, 
      y = male_logFC,
      label = gene_name
    ),
    color = "black",
    fontface = "italic",
    size = 2.5, 
    max.overlaps = getOption("ggrepel.max.overlaps", default = 20)
  ) +
  geom_point(size = 1) + 
  theme_bw() +
  geom_smooth(method = "lm") +
  theme(plot.title = element_text(size = 10)) +
  theme(legend.position = "none") +
  theme(axis.title.x = element_text(size = 10),
        axis.text.x = element_text(size = 10)) +
  theme(axis.title.y = element_text(size = 10),
        axis.text.y = element_text(size = 10)) +
  labs(
    title = "DEGs unique to XX female",
    x = expression(paste("XX female ", log[2](LBD/control))),
    y = expression(paste("XY male ", log[2](LBD/control))))+
  scale_y_continuous(breaks = seq(-1, 1, by = .5), 
                     limits = c(-1, 1), expand = c(0,0)) +
  scale_x_continuous(breaks = seq(-1, 1, by = .5), 
                     limits = c(-1, 1), expand = c(0,0)) 
LBD_corr_female

sp <- ggscatter(LBD_female_DEGs, x = "female_logFC", y = "male_logFC",
                add = "reg.line",  # Add regressin line
                add.params = list(color = "blue", fill = "lightgray"), # Customize reg. line
                conf.int = TRUE # Add confidence interval
)
# Add correlation coefficient
sp + stat_cor(method = "pearson", label.x = -.5, label.y = .5)

```
###### heatmap
```{r}
LBD_female_DEGs$difference <- LBD_female_DEGs$female_logFC - LBD_female_DEGs$male_logFC
LBD_female_DEGs <- subset(LBD_female_DEGs, difference > .5 | difference < -.5)
LBD_female_DEGs <- LBD_female_DEGs[order(-LBD_female_DEGs$difference),]
LBD_female_DEGs_melt <- reshape2::melt(LBD_female_DEGs)
data <- subset(LBD_female_DEGs_melt, variable == "female_logFC" | variable == "male_logFC")
data$gene_name <- factor(data$gene_name , levels = unique(data$gene_name))
data$gene_name <- fct_rev(data$gene_name)

ggplot(data = data) +
  geom_tile(aes(x = variable, y =gene_name, fill = value)) +
  scale_fill_gradient2(
    low = "blue",
    mid = "white",
    high = "red",
    midpoint = 0,
    space = "rgb",
    guide = "colourbar",
    breaks = c(-1, 0, 1),
    name = expression(log[2](CPM))
  ) +
  scale_x_discrete(expand = c(0,0)) +
  theme_bw() +
  theme(
    strip.text = element_text(size = 10),
    legend.position = "none",
    panel.border = element_blank(),
    panel.background = element_blank(),
    plot.margin = margin(0, 0.2, 0, 0.2, "cm"), 
    panel.spacing = unit(0,'lines'), 
    plot.title = element_text(size = 10, vjust = -1, hjust = 0),
    axis.title.x=element_blank(),
   # axis.text.x = element_blank(), 
    axis.ticks.x=element_blank(), 
    axis.title.y = element_blank(), 
    axis.text.y = element_text(size = 10, margin = margin(r = -2)),
    axis.ticks.y=element_blank()) +
  ggtitle("DEGs unique to XX females") 

path <-
  paste0(
    "../../results/",
    tool,
    "/heatmap/",
    "LBDvsControl_DEGs_unique_to_XX_female"
  )
saveToPDF(paste0(path, ".pdf"), width = 4, height = 7)
```
### AD vs control bt the sexes 
```{r}
AD_FandM[is.na(AD_FandM)] <- 0
AD_FandM <- subset(AD_FandM, female_adj.P.Val <= 0.05 | male_adj.P.Val <= 0.05)
AD_FandM_goi <- subset(AD_FandM, 
                        (female_logFC < -0.25 & male_logFC < -0.5) | 
                          (female_logFC > 1 & male_logFC > 0.5) | 
                          (female_logFC > .5 & male_logFC <= 0) |
                          (female_logFC <= 0 & male_logFC > 0.25))

AD_upfemales_downmales <- subset(AD_FandM, (female_logFC > 0 & male_logFC <= 0) 
                                  & female_adj.P.Val <= 0.05)
AD_upmales_downfemales <- subset(AD_FandM, (female_logFC <= 0 & male_logFC > 0)
                                  & male_adj.P.Val <= 0.05)
AD_sharedup <- subset(AD_FandM, female_logFC > 0 & male_logFC > 0)
AD_shareddown <- subset(AD_FandM, female_logFC < 0 & male_logFC < 0)

write.table(
  AD_upfemales_downmales,
  paste0("../../results/",
         tool,
         "/correlation/", 
         "ADvsControl_upF_downM.txt"),
  sep = "\t",
  quote = FALSE,
  row.names = FALSE
)

write.table(
  AD_upmales_downfemales,
  paste0("../../results/",
         tool,
         "/correlation/", 
         "ADvsControl_upM_downF.txt"),
  sep = "\t",
  quote = FALSE,
  row.names = FALSE
)

write.table(
  AD_sharedup,
  paste0("../../results/",
         tool,
         "/correlation/", 
         "ADvsControl_shared_bt_sexes_up.txt"),
  sep = "\t",
  quote = FALSE,
  row.names = FALSE
)

write.table(
  AD_shareddown,
  paste0("../../results/",
         tool,
         "/correlation/", 
         "ADvsControl_shared_bt_sexes_down.txt"),
  sep = "\t",
  quote = FALSE,
  row.names = FALSE
)

AD_corr_plot_adjPval_1 <- ggplot(data = AD_FandM, 
  aes(x = female_logFC, y = male_logFC, text = paste(gene_name))) +
  annotate(
    "rect",
    xmin = 0,
    xmax = 2.75,
    ymin = 2.75,
    ymax = 0,
    fill = "lightpink3",
    alpha = .5
  ) +  annotate(
    "rect",
    xmin = 0,
    xmax = -2,
    ymin = 0,
    ymax = -2,
    fill = "cadetblue3",
    alpha = .5) +
  geom_abline(color = "gray40") +
  geom_text_repel(
    data = AD_FandM_goi, 
    aes(
      x = female_logFC, 
      y = male_logFC,
      label = gene_name
    ),
    color = "black",
    fontface = "italic",
    size = 2.5, 
    max.overlaps = getOption("ggrepel.max.overlaps", default = 15)
  ) +
  geom_point(size = 1) + 
  theme_bw() +
  theme(plot.title = element_text(size = 10)) +
  theme(legend.position = "none") +
  theme(axis.title.x = element_text(size = 10),
        axis.text.x = element_text(size = 10)) +
  theme(axis.title.y = element_text(size = 10),
        axis.text.y = element_text(size = 10)) +
  labs(
    title = "DEGs shared and unique between the sexes",
    x = expression(paste("XX female ", log[2](AD/control))),
    y = expression(paste("XY male ", log[2](AD/control))))+
  scale_y_continuous(breaks = seq(-1.75, 2.725, by = .5), 
                     limits = c(-2, 2.75), expand = c(0,0)) +
  scale_x_continuous(breaks = seq(-2, 2.75, by = .5), 
                     limits = c(-2, 2.75), expand = c(0,0))
AD_corr_plot_adjPval_1 

path <-
  paste0(
    "../../results/",
    tool,
    "/correlation/",
    "ADvsControl_bt_sexes"
  )
saveToPDF(paste0(path, ".pdf"), width = 6.25, height = 4.5)

# Scatter plot with correlation coefficient
sp <- ggscatter(AD_FandM, x = "female_logFC", y = "male_logFC",
                add = "reg.line",  # Add regressin line
                add.params = list(color = "blue", fill = "lightgray"), # Customize reg. line
                conf.int = TRUE # Add confidence interval
)
# Add correlation coefficient
sp + stat_cor(method = "pearson", label.x = -1.25, label.y = .75)

path <-
  paste0(
    "../../results/",
    tool,
    "/correlation/",
    "ADvsControl_bt_sexes_corr_pval"
  )
saveToPDF(paste0(path, ".pdf"), width = 6.25, height = 4.5)
```
### PA vs control bt the sexes
```{r}
# table formatting
PA_FandM[is.na(PA_FandM)] <- 0
PA_FandM <- subset(PA_FandM, female_adj.P.Val <= 0.05 | male_adj.P.Val <= 0.05)
PA_FandM_goi <- subset(PA_FandM, 
                               (female_logFC < -0.25 & male_logFC < -0.5) | 
                               (female_logFC > 1 & male_logFC > 0.5) | 
                               (female_logFC > .5 & male_logFC <= 0) |
                              (female_logFC <= 0 & male_logFC > 0.25))

PA_upfemales_downmales <- subset(PA_FandM, (female_logFC > 0 & male_logFC <= 0) 
                                  & female_adj.P.Val <= 0.05)
PA_upmales_downfemales <- subset(PA_FandM, (female_logFC <= 0 & male_logFC > 0)
                                  & male_adj.P.Val <= 0.05)
PA_sharedup <- subset(PA_FandM, female_logFC > 0 & male_logFC > 0)
PA_shareddown <- subset(PA_FandM, female_logFC < 0 & male_logFC < 0)

write.table(
  PA_upfemales_downmales,
  paste0("../../results/",
  tool,
  "/correlation/", 
  "PAvsControl_upF_downM.txt"),
  sep = "\t",
  quote = FALSE,
  row.names = FALSE
)

write.table(
  PA_upmales_downfemales,
  paste0("../../results/",
  tool,
  "/correlation/", 
  "PAvsControl_upM_downF.txt"),
  sep = "\t",
  quote = FALSE,
  row.names = FALSE
)

write.table(
  PA_sharedup,
  paste0("../../results/",
  tool,
  "/correlation/", 
  "PAvsControl_shared_bt_sexes_up.txt"),
  sep = "\t",
  quote = FALSE,
  row.names = FALSE
)

write.table(
  PA_shareddown,
  paste0("../../results/",
  tool,
  "/correlation/", 
  "PAvsControl_shared_bt_sexes_down.txt"),
  sep = "\t",
  quote = FALSE,
  row.names = FALSE
)

# plot
PA_corr_plot_adjPval_1 <- ggplot(data = PA_FandM, 
   aes(x = female_logFC, y = male_logFC, text = paste(gene_name))) +
   annotate(
    "rect",
    xmin = 0,
    xmax = 3.25,
    ymin = 3.25,
    ymax = 0,
    fill = "lightpink3",
    alpha = .5
  ) +  annotate(
    "rect",
    xmin = 0,
    xmax = -2,
    ymin = 0,
    ymax = -2,
    fill = "cadetblue3",
    alpha = .5) +
  geom_abline(color = "gray40") +
    geom_text_repel(
    data = PA_FandM_goi, 
    aes(
    x = female_logFC, 
    y = male_logFC,
    label = gene_name
    ),
    color = "black",
    fontface = "italic",
    size = 2.5, 
    max.overlaps = getOption("ggrepel.max.overlaps", default = 15)
    ) +
  geom_point(size = 1) + 
  theme_bw() +
  theme(plot.title = element_text(size = 10)) +
  theme(legend.position = "none") +
  theme(axis.title.x = element_text(size = 10),
        axis.text.x = element_text(size = 10)) +
  theme(axis.title.y = element_text(size = 10),
        axis.text.y = element_text(size = 10)) +
  labs(
  title = "DEGs shared and unique between the sexes",
  x = expression(paste("XX female ", log[2](PA/control))),
  y = expression(paste("XY male ", log[2](PA/control))))+
  scale_y_continuous(breaks = seq(-1.75, 3.25, by = .5), 
                     limits = c(-2, 3.25), expand = c(0,0)) +
  scale_x_continuous(breaks = seq(-2, 3.25, by = .5), 
                     limits = c(-2, 3.25), expand = c(0,0))
PA_corr_plot_adjPval_1 

PA_corr_plot_adjPval_1
path <-
  paste0(
    "../../results/",
    tool,
    "/correlation/",
    "PAvsControl_bt_sexes"
  )
saveToPDF(paste0(path, ".pdf"), width = 6.25, height = 4.5)

# Scatter plot with correlation coefficient
sp <- ggscatter(PA_FandM, x = "female_logFC", y = "male_logFC",
   add = "reg.line",  # Add regressin line
   add.params = list(color = "blue", fill = "lightgray"), # Customize reg. line
   conf.int = TRUE # Add confidence interval
   )
# Add correlation coefficient
sp + stat_cor(method = "pearson", label.x = -1.25, label.y = 1)
path <-
  paste0(
    "../../results/",
    tool,
    "/correlation/",
    "PAvsControl_bt_sexes_corr_pval"
  )
saveToPDF(paste0(path, ".pdf"), width = 6.25, height = 4.5)
```
### LBD vs AD 
##### XX females
```{r}
ADandLBD_XX_females <-
  merge(ADvsControl_XX_females,
        LBDvsControl_XX_females,
        by = "gene_name",
        all = T)
ADandLBD_XX_females <- ADandLBD_XX_females[-c(3:5,7,10,11,13:19,22,23,25)]
colnames(ADandLBD_XX_females) = c("gene_name", "chr", "gene_id", "AD_female_logFC", "AD_female_AveExpr", "AD_female_adj.P.Val", "LBD_female_logFC", "LBD_female_AveExpr", "LBD_female_adj.P.Val")

ADandLBD_XX_females[is.na(ADandLBD_XX_females)] <- 0
ADandLBD_XX_females <- subset(ADandLBD_XX_females, AD_female_adj.P.Val <= 0.05 | LBD_female_adj.P.Val <= 0.05)
ADandLBD_XX_females_goi <- subset(ADandLBD_XX_females, 
                        (AD_female_logFC < -0.15 & LBD_female_logFC < -0.15) | 
                          (AD_female_logFC > .5 & LBD_female_logFC > 0.5) | 
                          (AD_female_logFC > .15 & LBD_female_logFC <= 0) |
                          (AD_female_logFC <= 0 & LBD_female_logFC > 0.15))

ADandLBD_XX_females_upAD_downLBD <- subset(ADandLBD_XX_females, (AD_female_logFC > 0 & LBD_female_logFC <= 0) & AD_female_adj.P.Val <= 0.05)
ADandLBD_XX_females_downAD_upLBD <- subset(ADandLBD_XX_females, (AD_female_logFC <= 0 & LBD_female_logFC > 0) & LBD_female_adj.P.Val <= 0.05)
ADandLBD_XX_females_sharedup <- subset(ADandLBD_XX_females, AD_female_logFC > 0 & LBD_female_logFC > 0)
ADandLBD_XX_females_shareddown <- subset(ADandLBD_XX_females, AD_female_logFC < 0 & LBD_female_logFC < 0)

write.table(
  ADandLBD_XX_females_upAD_downLBD,
  paste0("../../results/",
         tool,
         "/correlation/", 
         "ADandLBD_XX_females_upAD_downLBD.txt"),
  sep = "\t",
  quote = FALSE,
  row.names = FALSE
)

write.table(
  ADandLBD_XX_females_downAD_upLBD,
  paste0("../../results/",
         tool,
         "/correlation/", 
         "ADandLBD_XX_females_downAD_upLBD.txt"),
  sep = "\t",
  quote = FALSE,
  row.names = FALSE
)

write.table(
  ADandLBD_XX_females_sharedup,
  paste0("../../results/",
         tool,
         "/correlation/", 
         "ADandLBD_XX_females_shared_bt_pathologies_up.txt"),
  sep = "\t",
  quote = FALSE,
  row.names = FALSE
)

write.table(
  ADandLBD_XX_females_shareddown,
  paste0("../../results/",
         tool,
         "/correlation/", 
         "ADandLBD_XX_females_shared_bt_pathologies_down.txt"),
  sep = "\t",
  quote = FALSE,
  row.names = FALSE
)

ADandLBD_XX_females_corr_plot <- ggplot(data = ADandLBD_XX_females, 
  aes(x = AD_female_logFC, y = LBD_female_logFC, text = paste(gene_name))) +
  annotate(
    "rect",
    xmin = 0,
    xmax = 2.75,
    ymin = 2.75,
    ymax = 0,
    fill = "lightpink3",
    alpha = .5
  ) +  annotate(
    "rect",
    xmin = 0,
    xmax = -2,
    ymin = 0,
    ymax = -2,
    fill = "cadetblue3",
    alpha = .5) +
  geom_abline(color = "gray40") +
  geom_text_repel(
    data = ADandLBD_XX_females_goi, 
    aes(
      x = AD_female_logFC, 
      y = LBD_female_logFC,
      label = gene_name
    ),
    color = "black",
    fontface = "italic",
    size = 2.5, 
    max.overlaps = getOption("ggrepel.max.overlaps", default = 40)
  ) +
  geom_point(size = 1) + 
  theme_bw() +
  theme(plot.title = element_text(size = 10)) +
  theme(legend.position = "none") +
  theme(axis.title.x = element_text(size = 10),
        axis.text.x = element_text(size = 10)) +
  theme(axis.title.y = element_text(size = 10),
        axis.text.y = element_text(size = 10)) +
  labs(
    title = "DEGs shared and unique between LBD and AD within XX females",
    x = expression(paste("XX female ", log[2](AD/control))),
    y = expression(paste("XX female ", log[2](LBD/control))))+
  scale_y_continuous(breaks = seq(-1.75, 2.725, by = .5), 
                     limits = c(-2, 2.75), expand = c(0,0)) +
  scale_x_continuous(breaks = seq(-2, 2.75, by = .5), 
                     limits = c(-2, 2.75), expand = c(0,0))
ADandLBD_XX_females_corr_plot

path <-
  paste0(
    "../../results/",
    tool,
    "/correlation/",
    "ADandLBD_XX_females"
  )
saveToPDF(paste0(path, ".pdf"), width = 6.25, height = 4.5)

# Scatter plot with correlation coefficient
sp <- ggscatter(ADandLBD_XX_females, x = "AD_female_logFC", y = "LBD_female_logFC",
                add = "reg.line",  # Add regressin line
                add.params = list(color = "blue", fill = "lightgray"), 
                conf.int = TRUE)
# Add correlation coefficient
sp + stat_cor(method = "pearson", label.x = -1.25, label.y = 1)
path <-
  paste0(
    "../../results/",
    tool,
    "/correlation/",
    "ADandLBD_XX_females_corr_pval"
  )
saveToPDF(paste0(path, ".pdf"), width = 6.25, height = 4.5)
```
#### XY males
```{r}
ADandLBD_XY_males <-
  merge(ADvsControl_XY_males,
        LBDvsControl_XY_males,
        by = "gene_name",
        all = T)
ADandLBD_XY_males <- ADandLBD_XY_males[-c(3:5,7,10,11,13:19,22,23,25)]
colnames(ADandLBD_XY_males) = c("gene_name", "chr", "gene_id", "AD_male_logFC", "AD_male_AveExpr", "AD_male_adj.P.Val", "LBD_male_logFC", "LBD_male_AveExpr", "LBD_male_adj.P.Val")

ADandLBD_XY_males[is.na(ADandLBD_XY_males)] <- 0
ADandLBD_XY_males <- subset(ADandLBD_XY_males, AD_male_adj.P.Val <= 0.05 | LBD_male_adj.P.Val <= 0.05)
ADandLBD_XY_males_goi <- subset(ADandLBD_XY_males, 
                        (AD_male_logFC < -0.15 & LBD_male_logFC < -0.15) | 
                          (AD_male_logFC > .5 & LBD_male_logFC > 0.5) | 
                          (AD_male_logFC > .15 & LBD_male_logFC <= 0) |
                          (AD_male_logFC <= 0 & LBD_male_logFC > 0.15))

ADandLBD_XY_males_upAD_downLBD <- subset(ADandLBD_XY_males, (AD_male_logFC > 0 & LBD_male_logFC <= 0) & AD_male_adj.P.Val <= 0.05)
ADandLBD_XY_males_downAD_upLBD <- subset(ADandLBD_XY_males, (AD_male_logFC <= 0 & LBD_male_logFC > 0) & LBD_male_adj.P.Val <= 0.05)
ADandLBD_XY_males_sharedup <- subset(ADandLBD_XY_males, AD_male_logFC > 0 & LBD_male_logFC > 0)
ADandLBD_XY_males_shareddown <- subset(ADandLBD_XY_males, AD_male_logFC < 0 & LBD_male_logFC < 0)

write.table(
  ADandLBD_XY_males_upAD_downLBD,
  paste0("../../results/",
         tool,
         "/correlation/", 
         "ADandLBD_XY_males_upAD_downLBD.txt"),
  sep = "\t",
  quote = FALSE,
  row.names = FALSE
)

write.table(
  ADandLBD_XY_males_downAD_upLBD,
  paste0("../../results/",
         tool,
         "/correlation/", 
         "ADandLBD_XY_males_downAD_upLBD.txt"),
  sep = "\t",
  quote = FALSE,
  row.names = FALSE
)

write.table(
  ADandLBD_XY_males_sharedup,
  paste0("../../results/",
         tool,
         "/correlation/", 
         "ADandLBD_XY_males_shared_bt_pathologies_up.txt"),
  sep = "\t",
  quote = FALSE,
  row.names = FALSE
)

write.table(
  ADandLBD_XY_males_shareddown,
  paste0("../../results/",
         tool,
         "/correlation/", 
         "ADandLBD_XY_males_shared_bt_pathologies_down.txt"),
  sep = "\t",
  quote = FALSE,
  row.names = FALSE
)

ADandLBD_XY_males_corr_plot <- ggplot(data = ADandLBD_XY_males, 
  aes(x = AD_male_logFC, y = LBD_male_logFC, text = paste(gene_name))) +
  annotate(
    "rect",
    xmin = 0,
    xmax = 2.75,
    ymin = 2.75,
    ymax = 0,
    fill = "lightpink3",
    alpha = .5
  ) +  annotate(
    "rect",
    xmin = 0,
    xmax = -2,
    ymin = 0,
    ymax = -2,
    fill = "cadetblue3",
    alpha = .5) +
  geom_abline(color = "gray40") +
  geom_text_repel(
    data = ADandLBD_XY_males_goi, 
    aes(
      x = AD_male_logFC, 
      y = LBD_male_logFC,
      label = gene_name
    ),
    color = "black",
    fontface = "italic",
    size = 2.5, 
    max.overlaps = getOption("ggrepel.max.overlaps", default = 40)
  ) +
  geom_point(size = 1) + 
  theme_bw() +
  theme(plot.title = element_text(size = 10)) +
  theme(legend.position = "none") +
  theme(axis.title.x = element_text(size = 10),
        axis.text.x = element_text(size = 10)) +
  theme(axis.title.y = element_text(size = 10),
        axis.text.y = element_text(size = 10)) +
  labs(
    title = "DEGs shared and unique between LBD and AD within XY males",
    x = expression(paste("XY male ", log[2](AD/control))),
    y = expression(paste("XY male ", log[2](LBD/control))))+
  scale_y_continuous(breaks = seq(-1.75, 2.725, by = .5), 
                     limits = c(-2, 2.75), expand = c(0,0)) +
  scale_x_continuous(breaks = seq(-2, 2.75, by = .5), 
                     limits = c(-2, 2.75), expand = c(0,0))
ADandLBD_XY_males_corr_plot

path <-
  paste0(
    "../../results/",
    tool,
    "/correlation/",
    "ADandLBD_XY_males"
  )
saveToPDF(paste0(path, ".pdf"), width = 6.25, height = 4.5)

# Scatter plot with correlation coefficient
sp <- ggscatter(ADandLBD_XY_males, x = "AD_male_logFC", y = "LBD_male_logFC",
                add = "reg.line",  # Add regressin line
                add.params = list(color = "blue", fill = "lightgray"), 
                conf.int = TRUE)
# Add correlation coefficient
sp + stat_cor(method = "pearson", label.x = -1.25, label.y = 1)
path <-
  paste0(
    "../../results/",
    tool,
    "/correlation/",
    "ADandLBD_XY_males_corr_pval"
  )
saveToPDF(paste0(path, ".pdf"), width = 6.25, height = 4.5)
```
#### Sex as a covariate
```{r}
ADandLBD <-
  merge(ADvsControl,
        LBDvsControl,
        by = "gene_name",
        all = T)
ADandLBD <- ADandLBD[c(1,2,9,16,17,20,36,37,40)]
colnames(ADandLBD) = c("gene_name", "chr", "gene_id", "ADvsControl_logFC", "ADvsControl_AveExpr", "ADvsControl_adj.P.Val", "LBDvsControl_logFC", "LBDvsControl_AveExpr", "LBDvsControl_adj.P.Val")


ADandLBD[is.na(ADandLBD)] <- 0
ADandLBD <- subset(ADandLBD, ADvsControl_adj.P.Val <= 0.05 | LBDvsControl_adj.P.Val <= 0.05)
ADandLBD_goi <- subset(ADandLBD, 
                        (ADvsControl_logFC < -0.5 & LBDvsControl_logFC < -0.5) | 
                          (ADvsControl_logFC > .5 & LBDvsControl_logFC > 0.5) | 
                          (ADvsControl_logFC > .5 & LBDvsControl_logFC <= 0) |
                          (ADvsControl_logFC <= 0 & LBDvsControl_logFC > 0.5))

ADandLBD_upAD_downLBD <- subset(ADandLBD, (ADvsControl_logFC > 0 & LBDvsControl_logFC <= 0) 
                                  & ADvsControl_adj.P.Val <= 0.05)
ADandLBD_downAD_upLBD <- subset(ADandLBD, (ADvsControl_logFC <= 0 & LBDvsControl_logFC > 0)
                                  & LBDvsControl_adj.P.Val <= 0.05)
ADandLBD_sharedup <- subset(ADandLBD, ADvsControl_logFC > 0 & LBDvsControl_logFC > 0)
ADandLBD_shareddown <- subset(ADandLBD, ADvsControl_logFC < 0 & LBDvsControl_logFC < 0)

write.table(
  ADandLBD_upAD_downLBD,
  paste0("../../results/",
         tool,
         "/correlation/", 
         "ADandLBD_upAD_downLBD.txt"),
  sep = "\t",
  quote = FALSE,
  row.names = FALSE
)

write.table(
  ADandLBD_downAD_upLBD,
  paste0("../../results/",
         tool,
         "/correlation/", 
         "ADandLBD_downAD_upLBD.txt"),
  sep = "\t",
  quote = FALSE,
  row.names = FALSE
)

write.table(
  ADandLBD_sharedup,
  paste0("../../results/",
         tool,
         "/correlation/", 
         "ADandLBD_shared_up.txt"),
  sep = "\t",
  quote = FALSE,
  row.names = FALSE
)

write.table(
  ADandLBD_shareddown,
  paste0("../../results/",
         tool,
         "/correlation/", 
         "ADandLBD_shared_down.txt"),
  sep = "\t",
  quote = FALSE,
  row.names = FALSE
)

ADandLBD_corr_plot <- ggplot(data = ADandLBD, 
  aes(x = ADvsControl_logFC, y = LBDvsControl_logFC, text = paste(gene_name))) +
  annotate(
    "rect",
    xmin = 0,
    xmax = 2.75,
    ymin = 2.75,
    ymax = 0,
    fill = "lightpink3",
    alpha = .5
  ) +  annotate(
    "rect",
    xmin = 0,
    xmax = -2,
    ymin = 0,
    ymax = -2,
    fill = "cadetblue3",
    alpha = .5) +
  geom_abline(color = "gray40") +
  geom_text_repel(
    data = ADandLBD_goi, 
    aes(
      x = ADvsControl_logFC, 
      y = LBDvsControl_logFC,
      label = gene_name
    ),
    color = "black",
    fontface = "italic",
    size = 2.5, 
    max.overlaps = getOption("ggrepel.max.overlaps", default = 30)
  ) +
  geom_point(size = 1) + 
  theme_bw() +
  theme(plot.title = element_text(size = 10)) +
  theme(legend.position = "none") +
  theme(axis.title.x = element_text(size = 10),
        axis.text.x = element_text(size = 10)) +
  theme(axis.title.y = element_text(size = 10),
        axis.text.y = element_text(size = 10)) +
  labs(
    title = "DEGs shared and unique between LBD and AD within ",
    x = expression(paste("sex as a covariate ", log[2](AD/control))),
    y = expression(paste("sex as a covariate ", log[2](LBD/control))))+
  scale_y_continuous(breaks = seq(-1.75, 2.725, by = .5), 
                     limits = c(-2, 2.75), expand = c(0,0)) +
  scale_x_continuous(breaks = seq(-2, 2.75, by = .5), 
                     limits = c(-2, 2.75), expand = c(0,0))
ADandLBD_corr_plot

path <-
  paste0(
    "../../results/",
    tool,
    "/correlation/",
    "ADandLBD_sex_covariate"
  )
saveToPDF(paste0(path, ".pdf"), width = 6.25, height = 4.5)

# Scatter plot with correlation coefficient
sp <- ggscatter(ADandLBD, x = "ADvsControl_logFC", y = "LBDvsControl_logFC",
                add = "reg.line",  # Add regressin line
                add.params = list(color = "blue", fill = "lightgray"), 
                conf.int = TRUE)
# Add correlation coefficient
sp + stat_cor(method = "pearson", label.x = -1.25, label.y = 1)
path <-
  paste0(
    "../../results/",
    tool,
    "/correlation/",
    "ADandLBD_sex_covariate_corr_pval"
  )
saveToPDF(paste0(path, ".pdf"), width = 6.25, height = 4.5)
```
