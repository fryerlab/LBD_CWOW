---
title: "Create rObject of RNAseq counts data - LBD sub types"
author: "Kimberly Olney, Ph.D."
date: "09/30/2022"
output:
  html_document:
    df_print: paged
  pdf_document: default
params:
  args: myarg
---
# Setup
```{r setup}
knitr::opts_knit$set(root.dir = ".")
```
# User defined variables
```{r set_variables}
source(here::here("scripts/R", "file_paths_and_colours.R"))
#source(here::here("scripts/R", "gtf_path.R"))
condition <- c("LBD.type.") # change condition for file naming 
tool = c("star_LBD_sub_type") # change condition for folder naming 
typeOfCount <-  c(".bamReadsPerGene.out.tab")
```
# Read in DGE object
```{r}
dge <- readRDS(paste0("../../rObjects/dge.filtered.norm.rds"))
```
# MDS - normalized counts
multidimensional scaling
```{r MDS_norm}
lcpm <- edgeR::cpm(dge$counts, log = TRUE)
cpm <- edgeR::cpm(dge$counts, log = FALSE)

# LBD type colors 
dge$samples$LBD.type <- as.factor(dge$samples$LBD.type)
colors <- c(colorbindColors)[dge$samples$LBD.type]

par(bg = 'white')
plotMDS(
  lcpm,
  top = 100, 
  labels = dge$samples$LBD.type,
  cex = .8, 
  dim.plot = c(1,2), 
  plot = TRUE, 
  col = colors, 
  gene.selection = "common"
)
title(expression('Top 100 Genes (Log'[2]~'CPM)'))

path <- paste0("../../results/", tool, "/MDS/", 
               condition,"_dim1&2")
saveToPDF(paste0(path, ".pdf"), width = 5.2, height = 5.2)
```
# DGE object & metadata
```{r dge}
# impute missing values with median
dge$samples$RIN <- impute(dge$samples$RIN, median)
# one sample is missing VaD information
dge$samples$VaD <- impute(dge$samples$VaD, median)
dge$samples$flowcell_and_lane <- factor(dge$samples$flowcell_and_lane)
dge$samples$APOE <- factor(dge$samples$APOE)

info <- as.data.frame(dge$samples) # sample metadata
genes <- dge$genes # gene information 
```

# Add biomarker expression to dge metadata 
```{r biomarker_expression}
biomarkers <- c("ENO2", "GFAP", "OLIG2", "CD34", "P2RY12", "MBP")

for (i in biomarkers) {
  biomarker <- subset(genes, gene_name == i) # gene of interest 
  biomarker_counts <- subset(lcpm, rownames(lcpm) %in% biomarker)
  biomarker_melt <- reshape2::melt(biomarker_counts) # reshape data 
  # rename columns to merge with metadata 
  names(biomarker_melt)[names(biomarker_melt) == "value"] <- i 
  # rename columns to merge with metadata 
  names(biomarker_melt)[names(biomarker_melt) == "Var2"] <- "NPID" 
  names(biomarker_melt)[names(biomarker_melt) == "Var1"] <- "gene_id"
  biomarker_melt$gene_id <- NULL
  assign(paste0(i),biomarker_melt)
}

# add gene expression values into one dataframe 
# put all data frames into list
df_list <- list(ENO2, OLIG2, CD34, P2RY12, GFAP, MBP)

# merge all data frames in list
cell_biomarker_lcpm <- df_list %>% reduce(full_join, by='NPID')
remove(biomarker, biomarker_counts, biomarker_melt, biomarkers,
       ENO2, OLIG2, CD34, P2RY12, GFAP, MBP)
```
```{r}
plot(cell_biomarker_lcpm$ENO2, cell_biomarker_lcpm$MBP)

sp <- ggscatter(cell_biomarker_lcpm, x = "ENO2", y = "MBP",
                add = "reg.line",  # Add regression line
                add.params = list(color = "blue", fill = "lightgray"), 
                conf.int = TRUE)
# Add correlation coefficient
sp + stat_cor(method = "pearson", label.x = 7, label.y = 10)
```
# Scale data
Rescaling a predictor in a regression has absolutely no effect on the magnitude of the relation being studied. The slope itself will not change its steepness, nor will the p-values or variance explained be changed. Rescaling is merely a means of communicating the nature of the regression line in different, hopefully more intuitive language.
```{r scale}
df <- merge(cell_biomarker_lcpm, info, by = "NPID")
scaled.info <-
  df[c(
    "Race_numeric",
    "RIN",
    "Age",
    "PCT_CODING_BASES",
    "PCT_INTERGENIC_BASES",
    "PCT_INTRONIC_BASES",
    "APOE_E4_allele_count", 
    "ENO2", 
    "GFAP", 
    "OLIG2", 
    "CD34", 
    "P2RY12",
    "MBP",
    "Brain.wt"
  )] %>% scale()
scaled.info.df <- as.data.frame(scaled.info)
# remove columns with unscaled data 
df <- (subset(df, select = -c(Race_numeric, RIN, Age, PCT_CODING_BASES, PCT_INTRONIC_BASES, APOE_E4_allele_count, ENO2, GFAP, OLIG2, CD34, P2RY12, MBP, Brain.wt)))
# Add scaled information to the metadata called "info"
info_with_scale <- cbind(df, scaled.info.df)

remove(cell_biomarker_lcpm, cpm, df, df_list, info, scaled.info.df)
```

```{r}
# check that NPIDs match between dataframes
all.equal(dge$samples$NPID, as.character(info_with_scale$NPID))
# replace sample information with the updated info that includes biomakrer expression
dge$samples <- info_with_scale
```
# LBD type refined
```{r}
info_with_scale$LBD.type <-
```
# Voom transform counts
Transform count data to log2-counts per million (logCPM), estimate the mean-variance relationship and use this to compute appropriate observation-level weights. The data are then ready for linear mixed modelling with dream(). This method is the same as limma::voom(), except that it allows random effects in the formula. 
```{r voom, warning=FALSE}
formula <- (~ 0 + LBD.type)
voom_with_weights <-
  variancePartition::voomWithDreamWeights(
    counts = dge$counts,
    formula = formula,
    data = dge$samples,
    BPPARAM = BiocParallel::SnowParam(cores),
    plot = TRUE
  )
path <- paste0("../../results/", tool, "/voom/", condition, ".raw.voom")
saveToPDF(paste0(path, ".pdf"), width = 6, height = 4)
voomCounts <- voom_with_weights$E
```
# Design matrix
```{r design}
design <-
  model.matrix(~ 0 + 
      LBD.type + 
      sex_inferred + 
      flowcell_and_lane + 
      RIN +
      PCT_CODING_BASES +
      PCT_INTERGENIC_BASES + 
      PCT_INTRONIC_BASES +
      ENO2 +
      MBP,
    dge$samples
  )
colnames(design) <-
  c("BLBD",
    "DLBD",
    "no_LBs",
    "TLBD", 
    "sex",
    "Batch1",
    "Batch2",
    "Batch3",
    "Batch4",
    "Batch5",
    "Batch6",
    "Batch7",
    "RIN",
    "PCT_CODING_BASES", 
    "PCT_INTERGENIC_BASES", 
    "PCT_INTRONIC_BASES",
    "ENO2",
    "MBP"
  )
```
# Voom
When the library sizes are quite variable between samples, then the voom approach is theoretically more powerful than limma-trend. 
The voom method estimates the mean-variance relationship of the log-counts.Generates a precision weight for each observation and enters these into the limma empirical Bayes analysis pipeline.
```{r voom_BIC}
form <- (
  ~ 0 +
      LBD.type + 
      sex_inferred + 
      flowcell_and_lane + 
      RIN +
      PCT_CODING_BASES +
      PCT_INTERGENIC_BASES + 
      PCT_INTRONIC_BASES +
      ENO2 + 
      MBP
)

voom_cov <-
  variancePartition::voomWithDreamWeights(
    counts = dge$counts,
    formula = form,
    data = dge$samples,
    BPPARAM = BiocParallel::SnowParam(cores),
    plot = TRUE
  )
path <-
  paste0("../../results/",
         tool,
         "/voom/",
         condition,
         ".voom.finalmodel")
saveToPDF(paste0(path, ".pdf"), width = 6, height = 4)
voomCounts <- voom_cov$E
```
# Contrast 
Overview of steps:/
1.	lmFit computes coefficients, residual variances and standard errors./
2.	contrasts.fit converts the coefficients and standard errors to reflect the contrasts rather than the original design matrix, but does not compute t-statistics or p-values./
3.	eBayes computes t-statistics and p-values from the coefficients and standard errors./
https://support.bioconductor.org/p/117840/ 

```{r contrasts}
# fits linear model for each gene given a series of arrays
fit <- lmFit(voom_cov, design)
coef.fit <- fit$coefficients

contrasts <- makeContrasts(
  DLBDvsTLBD = DLBD - TLBD,
  DLBDvsNoLBs = DLBD - no_LBs, 
  TLBDvsNoLBs = TLBD - no_LBs,
  levels = colnames(design))
head(contrasts)

# save contrast names
allComparisons <- colnames(contrasts)
allComparisons # check

# run contrast analysis
vfit <- contrasts.fit(fit, contrasts = contrasts)
```
# Empirical Bayes
Compute differential expression based on the empirical Bayes moderation of the standard errors towards a common value./
trend - 	logical, should an intensity-dependent trend be allowed for the prior variance? If FALSE then the prior variance is constant. Alternatively, trend can be a row-wise numeric vector, which will be used as the covariate for the prior variance./
robsut - logical, should the estimation of df.prior and var.prior be robustified against outlier sample variances./
```{r ebays}
veBayesFit <- eBayes(vfit, trend = TRUE, robust = TRUE)

plotSA(veBayesFit, main = "Final Model: Mean-variance Trend")
path <-
  paste0("../../results/",
         tool,
         "/voom/",
         condition,
         ".voom.eBayes.finalmodel")
saveToPDF(paste0(path, ".pdf"), width = 9, height = 5)
```

# DEGs summary
```{r DGE_summary}
pval <- 0.05
lfc.cutoff <- 0.25

sumTable <- 
  summary(decideTests(
    veBayesFit,  # object
    adjust.method = "BH", # by default the method = "separate"
    p.value = pval,
    lfc = lfc.cutoff  # numeric, minimum absolute log2-fold change required
  ))

print(paste0(" FDRq < ", pval,
             " & absolute log2-fold change > ", lfc.cutoff))
sumTable
write.table(sumTable, 
            paste0("../../results/", tool, "/DEGs/", condition, ".DEGs.summary.txt"), 
            quote = FALSE, sep = "\t")
```
# Add gene information to DEGs
reformat genes table to only include relevant information
```{r}
genes_relevant <- dplyr::select(genes, 1:4,10:12)
```
Check 
```{r DGE_check, eval=FALSE}
DEGs <- topTable(
  veBayesFit, 
  coef = "DLBDvsTLBD",  
  n = Inf, 
  p.value = 1,
  lfc = 0, 
  sort.by = "P", 
  genelist = genes_relevant, 
  confint = TRUE # column of confidence interval 
    )
```
# Save objects
```{r save_voom}
saveRDS(veBayesFit, file = paste0("../../rObjects/", condition, ".veBayesFit.rds"))
saveRDS(voomCounts, file = paste0("../../rObjects/", condition, ".voomCountsMatrix.rds"))
```
# Output DEG tables
```{r DGE_output}
coef <- 1

for (i in allComparisons) {
  vTopTableAll <- topTable(
    veBayesFit, 
    coef = coef,  
    n = Inf, 
    p.value = 1,
    lfc = 0, 
    sort.by = "P", 
    genelist = genes_relevant, 
    confint = TRUE # column of confidence interval 
    )
    saveRDS(vTopTableAll, file = 
            paste0("../../rObjects/gene_tables/", condition, "_", 
                   i,"_gene_table.rds"))
  path <- paste0("../../results/", tool, "/DEGs/", condition, "_", 
  i, "_gene_DEGs_FDRq1.00.txt", sep = "") 
  write.table(
    vTopTableAll,
    path,
    sep = "\t",
    row.names = FALSE,
    quote = FALSE
  )
  # p < 0.05, log2fc > 0
  vTopTable1 <-
    topTable( 
      veBayesFit,  
      coef = coef,  
      n = Inf, 
      p.value = pval,
      lfc = lfc.cutoff,
      genelist = genes_relevant, 
      confint = TRUE # column of confidence interval 
    )
  path <- paste0("../../results/", tool, "/DEGs/", condition, "_", 
  i, "_gene_DEGs_FDRq0.05_logFC_0.25.txt", sep = "") 
  write.table(
    vTopTable1,
    path,
    sep = "\t",
    row.names = FALSE,
    quote = FALSE
  )
  # increment 
  coef <- coef + 1
}
remove(coef, coef.fit, contrasts, design, fit, scaled.info, veBayesFit, vfit,
       voom_cov, voom_with_weights, voomCounts, vTopTable1, vTopTableAll)
```
# Volcano plots
```{r volcano, warning=FALSE}
for (i in allComparisons) {
  group1_vs_group2 <-
    read.delim(
      paste0(
        "../../results/",
        tool,
        "/DEGs/",
        condition,
        "_",
        i,
        "_gene_DEGs_FDRq1.00.txt"
      )
    )
  color_values <- vector()
  max <- nrow(group1_vs_group2)
  for (row in 1:max) {
    if (group1_vs_group2$adj.P.Val[row] < 0.05) {
      if (group1_vs_group2$logFC [row] > 0.25) {
        color_values <- c(color_values, 1)
      }
      else if (group1_vs_group2$logFC[row] < -.25) {
        color_values <- c(color_values, 2)
      }
      else {
        color_values <- c(color_values, 3)
      }
    }
    else{
      color_values <- c(color_values, 3)
    }
  }
  group1_vs_group2$color_adjpval_0.05 <- factor(color_values)
  data <- group1_vs_group2
  # plot only if there are DEGs with p_val_adj < 0.05
  num <- subset(data, (adj.P.Val < 0.05 & logFC < -.25)  | (adj.P.Val < 0.05 & logFC > .25 ))
  num <- nrow(num)
  if (num != 0) {
    up <- data[data$color_adjpval_0.05 == 1,]
    up10 <- up[1:10,]
    upFold <- subset(up, logFC > 0.5)
    upFold <- upFold[!(upFold$gene_name %in% up10$gene_name),]
    down <- data[data$color_adjpval_0.05 == 2,]
    down10 <- down[1:10,]
    downFold <- subset(down, logFC < -0.5)
    downFold <- downFold[!(downFold$gene_name %in% down10$gene_name),]
    if (!1 %in% unique(data$color_adjpval_0.05)) {
      my_colors <- c("blue", "gray")
    } else if (!2 %in% unique(data$color_adjpval_0.05)) {
      my_colors <- c("red", "gray")
    } else if (!1 %in% unique(data$color_adjpval_0.05) &&
               !2 %in% unique(data$color_adjpval_0.05)) {
      my_colors <- c("gray")
    } else {
      my_colors <- c("red", "blue", "gray")
    }
    hadjpval <- (-log10(max(data$P.Value[data$adj.P.Val < 0.05],
                            na.rm = TRUE)))
    negFC <- c(-.25)
    posFC <- c(.25) 
    i <- gsub("vs", " vs ", i)
    p <-
      ggplot(data = data,
             aes(
               x = logFC,
               y = -log10(P.Value),
               color = color_adjpval_0.05
             )) +
      geom_point(alpha = 0.8, size = 1) +
      theme_bw() +
      theme(legend.position = "none") +
      scale_color_manual(values = my_colors) +
      labs(
        title = "",
        x = expression(log[2](FC)),
        y = expression(-log[10] ~ "(" ~ italic("p") ~ "-value)")
      )  +
      geom_hline(yintercept = hadjpval,
                 #  horizontal line
                 colour = "#000000",
                 linetype = "dashed") +
      geom_vline(xintercept = negFC,
                 #  horizontal line
                 colour = "#000000",
                 linetype = "dashed") +
      geom_vline(xintercept = posFC,
                 #  horizontal line
                 colour = "#000000",
                 linetype = "dashed") +
      ggtitle(paste0(i)) +
      geom_text_repel(
        data = up10,
        aes(
          x = logFC,
          y = -log10(P.Value),
          label = gene_name
        ),
        color = "maroon",
        fontface = "italic",
        size = 3,
        max.overlaps = getOption("ggrepel.max.overlaps", default = 10)
      ) +
      geom_text_repel(
        data = upFold,
        aes(
          x = logFC,
          y = -log10(P.Value),
          label = gene_name
        ),
        color = "maroon",
        fontface = "italic",
        size = 3,
        max.overlaps = getOption("ggrepel.max.overlaps", default = 10)
      ) +
      geom_text_repel(
        data = down10,
        aes(
          x = logFC,
          y = -log10(P.Value),
          label = gene_name
        ),
        color = "navyblue",
        fontface = "italic",
        size = 3,
        max.overlaps = getOption("ggrepel.max.overlaps", default = 10)
      ) +
      geom_text_repel(
        data = downFold,
        aes(
          x = logFC,
          y = -log10(P.Value),
          label = gene_name
        ),
        color = "navyblue",
        fontface = "italic",
        size = 3,
        max.overlaps = getOption("ggrepel.max.overlaps", default = 10)
      )
    p
    i <- gsub(" vs ", "vs", i)
    # save
    path <-
      paste0(
        "../../results/",
        tool,
        "/volcano/",
        condition,
        "_",
        i,
        "_gene_volcano_FDRq0.05"
      )
    pdf(paste0(path, ".pdf"),
        height = 5,
        width = 5)
    print(p)
    dev.off()
    
    print(paste("i =", i))
  }
} 
```

```{r cleanup}
# clean up
remove(up, up10, upFold, group1_vs_group2, down, downFold, down10, data, p)
```
# Make excel table
```{r excel}
# first read in the files
for (i in allComparisons) {
  filepath <- paste0("../../results/",tool,
    "/DEGs/", condition, "_", i,
    "_gene_DEGs_FDRq1.00.txt"
  )
  assign(paste0(i),
         read.delim(
           filepath,
           header = TRUE,
           sep = "\t",
           stringsAsFactors = FALSE
         ))
}
allComparisons
list_of_datasets <- list(
"DLBDvsTLBD" = DLBDvsTLBD,
"DLBDvsNoLBs" = DLBDvsNoLBs,     
"TLBDvsNoLBs" = TLBDvsNoLBs)
write.xlsx(list_of_datasets, file = paste0(
    "../../results/",
    tool,
    "/DEGs/", condition,".DEGs.FDRq1.00.xlsx"))

remove(DLBDvsTLBD, DLBDvsNoLBs, TLBDvsNoLBs, list_of_datasets)
```

# Excel table of significant DEGs
```{r}
# first read in the files
for (i in allComparisons) {
  filepath <- paste0("../../results/",tool,
    "/DEGs/", condition, "_", i,
    "_gene_DEGs_FDRq0.05_logFC_0.25.txt"
  )
  assign(paste0(i),
         tryCatch(
         read.delim(
           filepath,
           header = TRUE,
           sep = "\t",
           stringsAsFactors = FALSE
         ), error=function(e) NULL))
}

list_of_datasets <- list(
"DLBDvsTLBD" = DLBDvsTLBD,
"DLBDvsNoLBs" = DLBDvsNoLBs,     
"TLBDvsNoLBs" = TLBDvsNoLBs)
write.xlsx(list_of_datasets, file = paste0(
    "../../results/",
    tool,
    "/DEGs/", condition,".DEGs.FDRq0.05_logFC_0.25.xlsx"))
```
#-------------------------------------------------------------------------------
# LBD.type DE within each sex 
```{r}
condition <- c("LBD.type.sex") # change condition for file naming 
# add column with LBD.type.sex information
dge$samples$LBD.type_sex <- paste0(dge$samples$LBD.type, "_", dge$samples$sex_inferred)
dge$samples$LBD.type_sex <- factor(dge$samples$LBD.type_sex)
```
# Design matrix
```{r design}
design <-
  model.matrix(~ 0 + 
      LBD.type_sex + 
      flowcell_and_lane + 
      RIN +
      PCT_CODING_BASES +
      PCT_INTERGENIC_BASES + 
      PCT_INTRONIC_BASES +
      ENO2,
    dge$samples
  )
colnames(design) <-
  c("BLBD_male",
    "DLBD_female",
    "DLBD_male",
    "no_LBs_female",
    "no_LBs_male",
    "TLBD_female", 
    "TLBD_male", 
    "Batch1",
    "Batch2",
    "Batch3",
    "Batch4",
    "Batch5",
    "Batch6",
    "Batch7",
    "RIN",
    "PCT_CODING_BASES", 
    "PCT_INTERGENIC_BASES", 
    "PCT_INTRONIC_BASES",
    "ENO2"
  )
```
# Voom
```{r voom}
form <- (
  ~ 0 +
      LBD.type_sex + 
      flowcell_and_lane + 
      RIN +
      PCT_CODING_BASES +
      PCT_INTERGENIC_BASES + 
      PCT_INTRONIC_BASES +
      ENO2
)

voom_cov <-
  variancePartition::voomWithDreamWeights(
    counts = dge$counts,
    formula = form,
    data = dge$samples,
    BPPARAM = BiocParallel::SnowParam(cores),
    plot = TRUE
  )
path <-
  paste0("../../results/",
         tool,
         "/voom/",
         condition,
         ".voom.finalmodel")
saveToPDF(paste0(path, ".pdf"), width = 6, height = 4)
voomCounts <- voom_cov$E
```
# Contrast 
```{r contrasts}
# fits linear model for each gene given a series of arrays
fit <- lmFit(voom_cov, design) #
coef.fit <- fit$coefficients

contrasts <- makeContrasts(
  male_DLBD_vs_male_TLBD = DLBD_male - TLBD_male,
  female_DLBD_vs_female_TLBD = DLBD_female - TLBD_female,
  sex_DLBD = DLBD_female - DLBD_male,
  sex_TLBD = TLBD_female - TLBD_male,
  levels = colnames(design))
head(contrasts)

# save contrast names
allComparisons <- colnames(contrasts)
allComparisons # check

# run contrast analysis
vfit <- contrasts.fit(fit, contrasts = contrasts)
```
# Empirical Bayes
```{r ebays}
veBayesFit <- eBayes(vfit, trend = TRUE, robust = TRUE)

plotSA(veBayesFit, main = "Final Model: Mean-variance Trend")
path <-
  paste0("../../results/",
         tool,
         "/voom/",
         condition,
         ".voom.eBayes.finalmodel")
saveToPDF(paste0(path, ".pdf"), width = 9, height = 5)
```

# DEGs summary
```{r DGE_summary}
pval <- 0.05
lfc.cutoff <- 0.25

sumTable <- 
  summary(decideTests(
    veBayesFit,  # object
    adjust.method = "BH", # by default the method = "separate"
    p.value = pval,
    lfc = lfc.cutoff  # numeric, minimum absolute log2-fold change required
  ))

print(paste0(" FDRq < ", pval,
             " & absolute log2-fold change > ", lfc.cutoff))
sumTable
write.table(sumTable, 
            paste0("../../results/", tool, "/DEGs/", condition, ".DEGs.summary.txt"), 
            quote = FALSE, sep = "\t")
```
# Add gene information to DEGs
reformat genes table to only include relevant information
```{r}
genes_relevant <- dplyr::select(genes, 1:4,10:12)
```
Check 
```{r DGE_check, eval=FALSE}
DEGs <- topTable(
  veBayesFit, 
  coef = "female_DLBD_vs_female_TLBD",  
  n = Inf, 
  p.value = 1,
  lfc = 0, 
  sort.by = "P", 
  genelist = genes_relevant, 
  confint = TRUE # column of confidence interval 
    )
```
# Output DEG tables
```{r DGE_output}
coef <- 1

for (i in allComparisons) {
  vTopTableAll <- topTable(
    veBayesFit, 
    coef = coef,  
    n = Inf, 
    p.value = 1,
    lfc = 0, 
    sort.by = "P", 
    genelist = genes_relevant, 
    confint = TRUE # column of confidence interval 
    )
    saveRDS(vTopTableAll, file = 
            paste0("../../rObjects/gene_tables/", condition, "_", 
                   i,"_gene_table.rds"))
  path <- paste0("../../results/", tool, "/DEGs/", condition, "_", 
  i, "_gene_DEGs_FDRq1.00.txt", sep = "") 
  write.table(
    vTopTableAll,
    path,
    sep = "\t",
    row.names = FALSE,
    quote = FALSE
  )
  # p < 0.05, log2fc > 0
  vTopTable1 <-
    topTable( 
      veBayesFit,  
      coef = coef,  
      n = Inf, 
      p.value = pval,
      lfc = lfc.cutoff,
      genelist = genes_relevant, 
      confint = TRUE # column of confidence interval 
    )
  path <- paste0("../../results/", tool, "/DEGs/", condition, "_", 
  i, "_gene_DEGs_FDRq0.05_logFC_0.25.txt", sep = "") 
  write.table(
    vTopTable1,
    path,
    sep = "\t",
    row.names = FALSE,
    quote = FALSE
  )
  # increment 
  coef <- coef + 1
}
remove(coef, coef.fit, contrasts, design, fit, scaled.info, veBayesFit, vfit,
       voom_cov, voomCounts, vTopTable1, vTopTableAll)
```
# Volcano plots
```{r volcano, warning=FALSE}
for (i in allComparisons) {
  group1_vs_group2 <-
    read.delim(
      paste0(
        "../../results/",
        tool,
        "/DEGs/",
        condition,
        "_",
        i,
        "_gene_DEGs_FDRq1.00.txt"
      )
    )
  color_values <- vector()
  max <- nrow(group1_vs_group2)
  for (row in 1:max) {
    if (group1_vs_group2$adj.P.Val[row] < 0.05) {
      if (group1_vs_group2$logFC [row] > 0.25) {
        color_values <- c(color_values, 1)
      }
      else if (group1_vs_group2$logFC[row] < -.25) {
        color_values <- c(color_values, 2)
      }
      else {
        color_values <- c(color_values, 3)
      }
    }
    else{
      color_values <- c(color_values, 3)
    }
  }
  group1_vs_group2$color_adjpval_0.05 <- factor(color_values)
  data <- group1_vs_group2
  # plot only if there are DEGs with p_val_adj < 0.05
  num <- subset(data, (adj.P.Val < 0.05 & logFC < -.25)  | (adj.P.Val < 0.05 & logFC > .25 ))
  num <- nrow(num)
  if (num != 0) {
    up <- data[data$color_adjpval_0.05 == 1,]
    up10 <- up[1:10,]
    upFold <- subset(up, logFC > 0.5)
    upFold <- upFold[!(upFold$gene_name %in% up10$gene_name),]
    down <- data[data$color_adjpval_0.05 == 2,]
    down10 <- down[1:10,]
    downFold <- subset(down, logFC < -0.5)
    downFold <- downFold[!(downFold$gene_name %in% down10$gene_name),]
    if (!1 %in% unique(data$color_adjpval_0.05)) {
      my_colors <- c("blue", "gray")
    } else if (!2 %in% unique(data$color_adjpval_0.05)) {
      my_colors <- c("red", "gray")
    } else if (!1 %in% unique(data$color_adjpval_0.05) &&
               !2 %in% unique(data$color_adjpval_0.05)) {
      my_colors <- c("gray")
    } else {
      my_colors <- c("red", "blue", "gray")
    }
    hadjpval <- (-log10(max(data$P.Value[data$adj.P.Val < 0.05],
                            na.rm = TRUE)))
    negFC <- c(-.25)
    posFC <- c(.25) 
    i <- gsub("vs", " vs ", i)
    p <-
      ggplot(data = data,
             aes(
               x = logFC,
               y = -log10(P.Value),
               color = color_adjpval_0.05
             )) +
      geom_point(alpha = 0.8, size = 1) +
      theme_bw() +
      theme(legend.position = "none") +
      scale_color_manual(values = my_colors) +
      labs(
        title = "",
        x = expression(log[2](FC)),
        y = expression(-log[10] ~ "(" ~ italic("p") ~ "-value)")
      )  +
      geom_hline(yintercept = hadjpval,
                 #  horizontal line
                 colour = "#000000",
                 linetype = "dashed") +
      geom_vline(xintercept = negFC,
                 #  horizontal line
                 colour = "#000000",
                 linetype = "dashed") +
      geom_vline(xintercept = posFC,
                 #  horizontal line
                 colour = "#000000",
                 linetype = "dashed") +
      ggtitle(paste0(i)) +
      geom_text_repel(
        data = up10,
        aes(
          x = logFC,
          y = -log10(P.Value),
          label = gene_name
        ),
        color = "maroon",
        fontface = "italic",
        size = 3,
        max.overlaps = getOption("ggrepel.max.overlaps", default = 10)
      ) +
      geom_text_repel(
        data = upFold,
        aes(
          x = logFC,
          y = -log10(P.Value),
          label = gene_name
        ),
        color = "maroon",
        fontface = "italic",
        size = 3,
        max.overlaps = getOption("ggrepel.max.overlaps", default = 10)
      ) +
      geom_text_repel(
        data = down10,
        aes(
          x = logFC,
          y = -log10(P.Value),
          label = gene_name
        ),
        color = "navyblue",
        fontface = "italic",
        size = 3,
        max.overlaps = getOption("ggrepel.max.overlaps", default = 10)
      ) +
      geom_text_repel(
        data = downFold,
        aes(
          x = logFC,
          y = -log10(P.Value),
          label = gene_name
        ),
        color = "navyblue",
        fontface = "italic",
        size = 3,
        max.overlaps = getOption("ggrepel.max.overlaps", default = 10)
      )
    p
    i <- gsub(" vs ", "vs", i)
    # save
    path <-
      paste0(
        "../../results/",
        tool,
        "/volcano/",
        condition,
        "_",
        i,
        "_gene_volcano_FDRq0.05"
      )
    pdf(paste0(path, ".pdf"),
        height = 5,
        width = 5)
    print(p)
    dev.off()
    
    print(paste("i =", i))
  }
} 
```

```{r cleanup}
# clean up
remove(up, up10, upFold, group1_vs_group2, down, downFold, down10, data, p)
```
# Make excel table
```{r excel}
# first read in the files
for (i in allComparisons) {
  filepath <- paste0("../../results/",tool,
    "/DEGs/", condition, "_", i,
    "_gene_DEGs_FDRq1.00.txt"
  )
  assign(paste0(i),
         read.delim(
           filepath,
           header = TRUE,
           sep = "\t",
           stringsAsFactors = FALSE
         ))
}
allComparisons
list_of_datasets <- list(
"female_DLBD_vs_female_TLBD" = female_DLBD_vs_female_TLBD,
"male_DLBDvsTLBD" = male_DLBD_vs_male_TLBD,
"bt_sexes_DLBD" = sex_DLBD,     
"bt_sexes_TLBD" = sex_TLBD)
write.xlsx(list_of_datasets, file = paste0(
    "../../results/",
    tool,
    "/DEGs/", condition,".DEGs.FDRq1.00.xlsx"))

remove(male_DLBD_vs_male_TLBD, female_DLBD_vs_female_TLBD, sex_DLBD, sex_TLBD)
```

#-------------------------------------------------------------------------------
# LBD.types with tau 
```{r}
condition <- c("LBD.type.tau") # change condition for file naming 

dge$samples$LBD.type_Tau <- paste0(dge$samples$LBD.type, "_", dge$samples$MF.Tau)
dge$samples$LBD.type_Tau <- factor(dge$samples$LBD.type_Tau)

dge$samples$group <-
  ifelse(
    dge$samples$LBD.type_Tau  == "DLBD_0",
    "DLBD_NoTau",
    ifelse(
      dge$samples$LBD.type_Tau == "TLBD_0",
      "TLBD",
      ifelse(dge$samples$LBD.type_Tau == "BLBD_0", 
        "BLBD",
       ifelse(dge$samples$LBD.type_Tau == "no LBs_0", 
         "no_LBs",
        ifelse(dge$samples$LBD.type_Tau == "no LBs_1", 
         "no_LBs",
         ifelse(
           dge$samples$LBD.type_Tau == "TLBD_1",
           "TLBD", "DLBD_Tau"))))))

dge$samples$group <- factor(dge$samples$group)

dge$samples$Tau_status <-
  ifelse(
    dge$samples$MF.Tau  == "0",
    "NoTau", "Tau")

```
# Design matrix
```{r design}
design <-
  model.matrix(~ 0 + 
      group + 
      sex_inferred + 
      flowcell_and_lane + 
      RIN +
      PCT_CODING_BASES +
      PCT_INTERGENIC_BASES + 
      PCT_INTRONIC_BASES +
      ENO2,
    dge$samples
  )
colnames(design) <-
  c("BLBD",
    "DLBD_NoTau",
    "DLBD_Tau",
    "no_LBs",
    "TLBD", 
    "sex",
    "Batch1",
    "Batch2",
    "Batch3",
    "Batch4",
    "Batch5",
    "Batch6",
    "Batch7",
    "RIN",
    "PCT_CODING_BASES", 
    "PCT_INTERGENIC_BASES", 
    "PCT_INTRONIC_BASES",
    "ENO2"
  )
```
# Voom
```{r voom}
form <- (
  ~ 0 +
      group + 
      sex_inferred +
      flowcell_and_lane + 
      RIN +
      PCT_CODING_BASES +
      PCT_INTERGENIC_BASES + 
      PCT_INTRONIC_BASES +
      ENO2
)

voom_cov <-
  variancePartition::voomWithDreamWeights(
    counts = dge$counts,
    formula = form,
    data = dge$samples,
    BPPARAM = BiocParallel::SnowParam(cores),
    plot = TRUE
  )
path <-
  paste0("../../results/",
         tool,
         "/voom/",
         condition,
         ".voom.finalmodel")
saveToPDF(paste0(path, ".pdf"), width = 6, height = 4)
voomCounts <- voom_cov$E
```
# Contrast 
```{r contrasts}
# fits linear model for each gene given a series of arrays
fit <- lmFit(voom_cov, design)
coef.fit <- fit$coefficients

contrasts <- makeContrasts(
  #DLBDvsTLBD = (DLBD_NoTau + DLBD_Tau)/2 - TLBD,
  DLBD_Tau_vs_DLBD_NoTau = DLBD_Tau - DLBD_NoTau,
  DLBD_Tau_vs_TLBD = DLBD_Tau - TLBD, 
  DLBD_NoTau_vs_TLBD = DLBD_NoTau - TLBD, 
  levels = colnames(design))
head(contrasts)

# save contrast names
allComparisons <- colnames(contrasts)
allComparisons # check

# run contrast analysis
vfit <- contrasts.fit(fit, contrasts = contrasts)
```
# Empirical Bayes
```{r ebays}
veBayesFit <- eBayes(vfit, trend = TRUE, robust = TRUE)

plotSA(veBayesFit, main = "Final Model: Mean-variance Trend")
path <-
  paste0("../../results/",
         tool,
         "/voom/",
         condition,
         ".voom.eBayes.finalmodel")
saveToPDF(paste0(path, ".pdf"), width = 9, height = 5)

o <- order(veBayesFit$p.value[,3]) # 3rd column, for DEGs bt Tau and no Tau with DLBD
coolmap( lcpm[o[1:100],] )
```

# DEGs summary
```{r DGE_summary}
pval <- 0.05
lfc.cutoff <- 0.25

sumTable <- 
  summary(decideTests(
    veBayesFit,  # object
    adjust.method = "BH", # by default the method = "separate"
    p.value = pval,
    lfc = lfc.cutoff  # numeric, minimum absolute log2-fold change required
  ))

print(paste0(" FDRq < ", pval,
             " & absolute log2-fold change > ", lfc.cutoff))
sumTable
write.table(sumTable, 
            paste0("../../results/", tool, "/DEGs/", condition, ".DEGs.summary.txt"), 
            quote = FALSE, sep = "\t")
```
# Add gene information to DEGs
reformat genes table to only include relevant information
```{r}
genes_relevant <- dplyr::select(genes, 1:4,10:12)
```
Check 
```{r DGE_check, eval=FALSE}
DEGs <- topTable(
  veBayesFit, 
  coef = "DLBD_Tau_vs_DLBD_NoTau",  
  n = Inf, 
  p.value = 1,
  lfc = 0, 
  sort.by = "P", 
  genelist = genes_relevant, 
  confint = TRUE # column of confidence interval 
    )
```
# Output DEG tables
```{r DGE_output}
coef <- 1

for (i in allComparisons) {
  vTopTableAll <- topTable(
    veBayesFit, 
    coef = coef,  
    n = Inf, 
    p.value = 1,
    lfc = 0, 
    sort.by = "P", 
    genelist = genes_relevant, 
    confint = TRUE # column of confidence interval 
    )
    saveRDS(vTopTableAll, file = 
            paste0("../../rObjects/gene_tables/", condition, "_", 
                   i,"_gene_table.rds"))
  path <- paste0("../../results/", tool, "/DEGs/", condition, "_", 
  i, "_gene_DEGs_FDRq1.00.txt", sep = "") 
  write.table(
    vTopTableAll,
    path,
    sep = "\t",
    row.names = FALSE,
    quote = FALSE
  )
  # p < 0.05, log2fc > 0
  vTopTable1 <-
    topTable( 
      veBayesFit,  
      coef = coef,  
      n = Inf, 
      p.value = pval,
      lfc = lfc.cutoff,
      genelist = genes_relevant, 
      confint = TRUE # column of confidence interval 
    )
  path <- paste0("../../results/", tool, "/DEGs/", condition, "_", 
  i, "_gene_DEGs_FDRq0.05_logFC_0.25.txt", sep = "") 
  write.table(
    vTopTable1,
    path,
    sep = "\t",
    row.names = FALSE,
    quote = FALSE
  )
  # increment 
  coef <- coef + 1
}
remove(coef, coef.fit, contrasts, design, fit, veBayesFit, vfit,
       voom_cov, voomCounts, vTopTable1, vTopTableAll)
```
# Volcano plots
```{r volcano, warning=FALSE}
for (i in allComparisons) {
  group1_vs_group2 <-
    read.delim(
      paste0(
        "../../results/",
        tool,
        "/DEGs/",
        condition,
        "_",
        i,
        "_gene_DEGs_FDRq1.00.txt"
      )
    )
  color_values <- vector()
  max <- nrow(group1_vs_group2)
  for (row in 1:max) {
    if (group1_vs_group2$adj.P.Val[row] < 0.05) {
      if (group1_vs_group2$logFC [row] > 0.25) {
        color_values <- c(color_values, 1)
      }
      else if (group1_vs_group2$logFC[row] < -.25) {
        color_values <- c(color_values, 2)
      }
      else {
        color_values <- c(color_values, 3)
      }
    }
    else{
      color_values <- c(color_values, 3)
    }
  }
  group1_vs_group2$color_adjpval_0.05 <- factor(color_values)
  data <- group1_vs_group2
  # plot only if there are DEGs with p_val_adj < 0.05
  num <- subset(data, (adj.P.Val < 0.05 & logFC < -.25)  | (adj.P.Val < 0.05 & logFC > .25 ))
  num <- nrow(num)
  if (num != 0) {
    up <- data[data$color_adjpval_0.05 == 1,]
    up10 <- up[1:10,]
    upFold <- subset(up, logFC > 0.5)
    upFold <- upFold[!(upFold$gene_name %in% up10$gene_name),]
    down <- data[data$color_adjpval_0.05 == 2,]
    down10 <- down[1:10,]
    downFold <- subset(down, logFC < -0.5)
    downFold <- downFold[!(downFold$gene_name %in% down10$gene_name),]
    if (!1 %in% unique(data$color_adjpval_0.05)) {
      my_colors <- c("blue", "gray")
    } else if (!2 %in% unique(data$color_adjpval_0.05)) {
      my_colors <- c("red", "gray")
    } else if (!1 %in% unique(data$color_adjpval_0.05) &&
               !2 %in% unique(data$color_adjpval_0.05)) {
      my_colors <- c("gray")
    } else {
      my_colors <- c("red", "blue", "gray")
    }
    hadjpval <- (-log10(max(data$P.Value[data$adj.P.Val < 0.05],
                            na.rm = TRUE)))
    negFC <- c(-.25)
    posFC <- c(.25) 
    i <- gsub("vs", " vs ", i)
    i <- gsub("_", " ", i)
    p <-
      ggplot(data = data,
             aes(
               x = logFC,
               y = -log10(P.Value),
               color = color_adjpval_0.05
             )) +
      geom_point(alpha = 0.8, size = 1) +
      theme_bw() +
      theme(legend.position = "none") +
      scale_color_manual(values = my_colors) +
      labs(
        title = "",
        x = expression(log[2](FC)),
        y = expression(-log[10] ~ "(" ~ italic("p") ~ "-value)")
      )  +
      geom_hline(yintercept = hadjpval,
                 #  horizontal line
                 colour = "#000000",
                 linetype = "dashed") +
      geom_vline(xintercept = negFC,
                 #  horizontal line
                 colour = "#000000",
                 linetype = "dashed") +
      geom_vline(xintercept = posFC,
                 #  horizontal line
                 colour = "#000000",
                 linetype = "dashed") +
      ggtitle(paste0(i)) +
      geom_text_repel(
        data = up10,
        aes(
          x = logFC,
          y = -log10(P.Value),
          label = gene_name
        ),
        color = "maroon",
        fontface = "italic",
        size = 3,
        max.overlaps = getOption("ggrepel.max.overlaps", default = 10)
      ) +
      geom_text_repel(
        data = upFold,
        aes(
          x = logFC,
          y = -log10(P.Value),
          label = gene_name
        ),
        color = "maroon",
        fontface = "italic",
        size = 3,
        max.overlaps = getOption("ggrepel.max.overlaps", default = 10)
      ) +
      geom_text_repel(
        data = down10,
        aes(
          x = logFC,
          y = -log10(P.Value),
          label = gene_name
        ),
        color = "navyblue",
        fontface = "italic",
        size = 3,
        max.overlaps = getOption("ggrepel.max.overlaps", default = 10)
      ) +
      geom_text_repel(
        data = downFold,
        aes(
          x = logFC,
          y = -log10(P.Value),
          label = gene_name
        ),
        color = "navyblue",
        fontface = "italic",
        size = 3,
        max.overlaps = getOption("ggrepel.max.overlaps", default = 10)
      )
    p
    i <- gsub(" vs ", "vs", i)
    i <- gsub(" ", "_", i)
    # save
    path <-
      paste0(
        "../../results/",
        tool,
        "/volcano/",
        condition,
        "_",
        i,
        "_gene_volcano_FDRq0.05"
      )
    pdf(paste0(path, ".pdf"),
        height = 5,
        width = 5)
    print(p)
    dev.off()
    
    print(paste("i =", i))
  }
} 
```

```{r cleanup}
# clean up
remove(up, up10, upFold, group1_vs_group2, down, downFold, down10, data, p)
```
# Make excel table
```{r excel}
# first read in the files
for (i in allComparisons) {
  filepath <- paste0("../../results/",tool,
    "/DEGs/", condition, "_", i,
    "_gene_DEGs_FDRq1.00.txt"
  )
  assign(paste0(i),
         read.delim(
           filepath,
           header = TRUE,
           sep = "\t",
           stringsAsFactors = FALSE
         ))
}
allComparisons
list_of_datasets <- list(
"DLBD_Tau_vs_DLBD_NoTau" = DLBD_Tau_vs_DLBD_NoTau,
"DLBD_Tau_vs_TLBD" = DLBD_Tau_vs_TLBD,
"DLBD_NoTau_vs_TLBD" = DLBD_NoTau_vs_TLBD)
write.xlsx(list_of_datasets, file = paste0(
    "../../results/",
    tool,
    "/DEGs/", condition,".DEGs.FDRq1.00.xlsx"))

remove(DLBD_Tau_vs_DLBD_NoTau, DLBD_Tau_vs_TLBD, DLBD_NoTau_vs_TLBD)
```
# Excel table of significant DEGs
```{r}
# first read in the files
for (i in allComparisons) {
  filepath <- paste0("../../results/",tool,
    "/DEGs/", condition, "_", i,
    "_gene_DEGs_FDRq0.05_logFC_0.25.txt"
  )
  assign(paste0(i),
         tryCatch(
         read.delim(
           filepath,
           header = TRUE,
           sep = "\t",
           stringsAsFactors = FALSE
         ), error=function(e) NULL))
}

list_of_datasets <- list(
"DLBD_Tau_vs_DLBD_NoTau" = DLBD_Tau_vs_DLBD_NoTau,
"DLBD_Tau_vs_TLBD" = DLBD_Tau_vs_TLBD,
"DLBD_NoTau_vs_TLBD" = DLBD_NoTau_vs_TLBD)
write.xlsx(list_of_datasets, file = paste0(
    "../../results/",
    tool,
    "/DEGs/", condition,".DEGs.FDRq0.05_logFC_0.25.xlsx"))
```
#------------------------------------------------------------------------------
# Function to create tables
```{r}
fromList <- function (input) {
  # Same as original fromList()...
  elements <- unique(unlist(input))
  data <- unlist(lapply(input, function(x) {
      x <- as.vector(match(elements, x))
      }))
  data[is.na(data)] <- as.integer(0)
  data[data != 0] <- as.integer(1)
  data <- data.frame(matrix(data, ncol = length(input), byrow = F))
  data <- data[which(rowSums(data) != 0), ]
  names(data) <- names(input)
  # ... Except now it conserves your original value names!
  row.names(data) <- elements
  return(data)
}

makePaddedDataFrame <- function(l, ...) {
  maxlen <- max(sapply(l, length))
  data.frame(lapply(l, na.pad, len = maxlen), ...)
}
```
# Upset
```{r}
condition <- "LBD.type"

allComparisons <- c("DLBDvsTLBD")
# first read in the files
for (i in allComparisons) {
  filepath <- paste0("../../results/",tool,
    "/DEGs/", condition, "_", i,
    "_gene_DEGs_FDRq1.00.txt"
  )
  assign(paste0(i),
         read.delim(
           filepath,
           header = TRUE,
           sep = "\t",
           stringsAsFactors = FALSE
         ))
}

condition <- "LBD.type.tau"
allComparisons <- c("DLBD_Tau_vs_DLBD_NoTau", "DLBD_Tau_vs_TLBD", "DLBD_NoTau_vs_TLBD")
# first read in the files
for (i in allComparisons) {
  filepath <- paste0("../../results/",tool,
    "/DEGs/", condition, "_", i,
    "_gene_DEGs_FDRq1.00.txt"
  )
  assign(paste0(i),
         read.delim(
           filepath,
           header = TRUE,
           sep = "\t",
           stringsAsFactors = FALSE
         ))
}

DLBD_vs_TLBD_up <- subset(DLBDvsTLBD, logFC > 0.25 & adj.P.Val <= 0.05)
DLBD_vs_TLBD_down <- subset(DLBDvsTLBD, logFC < -0.25 & adj.P.Val <= 0.05)

DLBD_NoTau_vs_TLBD_up <- subset(DLBD_NoTau_vs_TLBD, logFC > 0.25 & adj.P.Val <= 0.05)
DLBD_NoTau_vs_TLBD_down <- subset(DLBD_NoTau_vs_TLBD, logFC < -0.25 & adj.P.Val <= 0.05)

DLBD_Tau_vs_TLBD_up <- subset(DLBD_Tau_vs_TLBD, logFC > 0.25 & adj.P.Val <= 0.05)
DLBD_Tau_vs_TLBD_down <- subset(DLBD_Tau_vs_TLBD, logFC < -0.25 & adj.P.Val <= 0.05)

# DLBD vs. TLBD
list_input <- list("DLBD Tau vs TLBD up-regulated" = DLBD_Tau_vs_TLBD_up$gene_name,
                   "DLBD Tau vs TLBD down-regulated" = DLBD_Tau_vs_TLBD_down$gene_name,
                   "DLBD vs TLBD up-regulated" = DLBD_vs_TLBD_up$gene_name,
                   "DLBD vs TLBD down-regulated" = DLBD_vs_TLBD_down$gene_name,
                   "DLBD No Tau vs TLBD up-regulated" = DLBD_NoTau_vs_TLBD_up$gene_name,
                   "DLBD No Tau vs TLBD down-regulated" = DLBD_NoTau_vs_TLBD_down$gene_name)
data <- fromList(list_input)
upset(data, nsets = 6)
path <- paste0("../../results/", tool,
               "/upset/DLBD_vs_TLBD_FDRq0.05_logFC_0.25_simple")
saveToPDF(paste0(path, ".pdf"), width = 9, height = 6)

# Binary table with colnames:
write.table(
  data,
  paste0("../../results/",
  tool,
  "/upset/DLBD_vs_TLBD_upset_binary.txt"),
  sep = "\t",
  quote = FALSE
)

# Tau vs. No Tau
list_input <- list("DLBD No Tau vs TLBD up-regulated" = DLBD_NoTau_vs_TLBD_up$gene_name,
                   "DLBD No Tau vs TLBD down-regulated" = DLBD_NoTau_vs_TLBD_down$gene_name,
                   "DLBD Tau vs TLBD up-regulated" = DLBD_Tau_vs_TLBD_up$gene_name,
                   "DLBD Tau vs TLBD down-regulated" = DLBD_Tau_vs_TLBD_down$gene_name)
data <- fromList(list_input)
upset(data)
path <- paste0("../../results/", tool,
               "/upset/DLBD_Tau_FDRq0.05_logFC_0.25_simple")
saveToPDF(paste0(path, ".pdf"), width = 9, height = 6)

# Binary table with colnames:
write.table(
  data,
  paste0("../../results/",
  tool,
  "/upset/DLBD_Tau_upset_binary.txt"),
  sep = "\t",
  quote = FALSE
)
```

```{r}
# first read in the files
for (i in allComparisons) {
  filepath <- paste0("../../results/",tool,
    "/DEGs/", condition, "_", i,
    "_gene_DEGs_FDRq1.00.txt"
  )
  assign(paste0(i),
         read.delim(
           filepath,
           header = TRUE,
           sep = "\t",
           stringsAsFactors = FALSE
         ))
}
allComparisons
DLBD_NoTau_vs_TLBD_up <- subset(DLBD_NoTau_vs_TLBD, logFC > 0.25 & adj.P.Val <= 0.05)
DLBD_NoTau_vs_TLBD_down <- subset(DLBD_NoTau_vs_TLBD, logFC < -0.25 & adj.P.Val <= 0.05)

DLBD_Tau_vs_TLBD_up <- subset(DLBD_Tau_vs_TLBD, logFC > 0.25 & adj.P.Val <= 0.05)
DLBD_Tau_vs_TLBD_down <- subset(DLBD_Tau_vs_TLBD, logFC < -0.25 & adj.P.Val <= 0.05)

list_input <- list("DLBD No Tau vs TLBD up-regulated" = DLBD_NoTau_vs_TLBD_up$gene_name,
                   "DLBD No Tau vs TLBD down-regulated" = DLBD_NoTau_vs_TLBD_down$gene_name,
                   "DLBD Tau vs TLBD up-regulated" = DLBD_Tau_vs_TLBD_up$gene_name,
                   "DLBD Tau vs TLBD down-regulated" = DLBD_Tau_vs_TLBD_down$gene_name)
data <- fromList(list_input)
upset(data)
path <- paste0("../../results/", tool,
               "/upset/", condition, "_all_types_FDRq0.05_logFC_0.25_simple")
saveToPDF(paste0(path, ".pdf"), width = 9, height = 6)

# Binary table with colnames:
write.table(
  data,
  paste0("../../results/",
  tool,
  "/upset/", condition, 
  "_upset_binary.txt"),
  sep = "\t",
  quote = FALSE
)
```
# Correlation
```{r}
DLBD_Tau_NoTau_vs_TLBD <-
  merge(DLBD_NoTau_vs_TLBD,
        DLBD_Tau_vs_TLBD,
        by = "gene_name",
        all = T)
DLBD_Tau_NoTau_vs_TLBD <- DLBD_Tau_NoTau_vs_TLBD[c(1,2,6,7,8:15,22:29)]
colnames(DLBD_Tau_NoTau_vs_TLBD) = c("gene_name", "chr", "gene_id","gene_type", "NoTau_logFC", "NoTau_CI.L", "NoTau_CI.R", "NoTau_AveExpr", "NoTau_t","NoTau_P.val", "NoTau_adj.P.Val", "NoTau_B", "Tau_logFC", "Tau_CI.L", "Tau_CI.R", "Tau_AveExpr", "Tau_t","Tau_P.val", "Tau_adj.P.Val", "Tau_B")

# significant in either 
DLBD_Tau_NoTau_vs_TLBD <- subset(DLBD_Tau_NoTau_vs_TLBD, (NoTau_logFC < -.25 & NoTau_adj.P.Val < 0.05) | (NoTau_logFC > 0.25 & NoTau_adj.P.Val < 0.05) |
(Tau_logFC < -.25 & Tau_adj.P.Val < 0.05) | 
(Tau_logFC > 0.25 & Tau_adj.P.Val < 0.05) )
DLBD_Tau_NoTau_vs_TLBD_goi <- subset(DLBD_Tau_NoTau_vs_TLBD, 
                        (NoTau_logFC < -0.5 & Tau_logFC < -0.5) | # down in both
                          (NoTau_logFC > .5 & Tau_logFC > 0.5) | # up in both
                          (NoTau_logFC > .5 & Tau_logFC < 0) | # up in NoTau, down in Tau
                          (NoTau_logFC < -.5 & Tau_logFC > 0)) # up in Tau, down in NoTau

corr_plot <- ggplot(data = DLBD_Tau_NoTau_vs_TLBD, 
  aes(x = NoTau_logFC, y = Tau_logFC, text = paste(gene_name))) +
  annotate(
    "rect",
    xmin = 0,
    xmax = 1.75,
    ymin = 1.75,
    ymax = 0,
    fill = "lightpink3",
    alpha = .5
  ) +  annotate(
    "rect",
    xmin = 0,
    xmax = -1.75,
    ymin = 0,
    ymax = -1.75,
    fill = "cadetblue3",
    alpha = .5) +
  geom_abline(color = "gray40") +
  geom_text_repel(
    data = DLBD_Tau_NoTau_vs_TLBD_goi, 
    aes(
      x = NoTau_logFC, 
      y = Tau_logFC,
      label = gene_name
    ),
    color = "black",
    fontface = "italic",
    size = 2.5, 
    max.overlaps = getOption("ggrepel.max.overlaps", default = 20)
  ) +
  geom_point(size = 1) + 
  theme_bw() +
  theme(plot.title = element_text(size = 10)) +
  theme(legend.position = "none") +
  theme(axis.title.x = element_text(size = 10),
        axis.text.x = element_text(size = 10)) +
  theme(axis.title.y = element_text(size = 10),
        axis.text.y = element_text(size = 10)) +
  labs(
    title = "DEGs shared and unique between 
DLBD No Tau vs. TLBD
DLBD Tau vs. TLBD",
    x = expression(paste("  ", log[2]("DLBD No Tau/TLBD"))),
    y = expression(paste("  ", log[2]("DLBD Tau/TLBD"))))+
  scale_y_continuous(breaks = seq(-1.75, 1.75, by = .5), 
                     limits = c(-1.75, 1.75), expand = c(0,0)) +
  scale_x_continuous(breaks = seq(-1.75, 1.75, by = .5), 
                     limits = c(-1.75, 1.75), expand = c(0,0))
corr_plot

path <-
  paste0(
    "../../results/",
    tool,
    "/correlation/",
    condition, 
    "DLBDvsTLBD_NoTau_Tau_sig_genes_only"
  )
saveToPDF(paste0(path, ".pdf"), width = 6.25, height = 4.5)

# Scatter plot with correlation coefficient
sp <- ggscatter(DLBD_Tau_NoTau_vs_TLBD, x = "NoTau_logFC", y = "Tau_logFC",
                add = "reg.line",  # Add regression line
                add.params = list(color = "blue", fill = "lightgray"), 
                conf.int = TRUE)
# Add correlation coefficients with p-values to a scatter plot. 
#Can be also used to add 'R2'.
sp + stat_cor(method = "pearson", label.x = -1.25, label.y = 1)
help(stat_cor)
path <-
  paste0(
    "../../results/",
    tool,
    "/correlation/",
    condition, 
    "DLBDvsTLBD_NoTau_Tau_corr_pval_sig_genes_only"
  )
saveToPDF(paste0(path, ".pdf"), width = 6.25, height = 4.5)
```


