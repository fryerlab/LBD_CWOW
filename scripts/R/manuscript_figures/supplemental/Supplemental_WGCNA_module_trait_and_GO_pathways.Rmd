---
title: "Figure 4 - gene networks"
author: "Kimberly Olney"
date: "2023-07-13"
output: html_document
---
# Setup
```{r setup}
knitr::opts_knit$set(root.dir = ".")
```
# User defined variables
```{r set_variables}
source(here::here("scripts/R", "file_paths_and_colours.R"))
library("readxl")
library(WGCNA)
library(anRichmentMethods)
library(tidyverse)
library(CorLevelPlot)
library(gridExtra)
library("limmaDE2")

condition <- c("TYPE")
tool <- "star"

addSmallLegend <- function(myPlot, pointSize = 4, textSize = 7, spaceLegend = .5) {
    myPlot +
        guides(shape = guide_legend(override.aes = list(size = pointSize)),
               color = guide_legend(override.aes = list(size = pointSize))) +
        theme(legend.title = element_text(size = textSize), 
              legend.text  = element_text(size = textSize),
              legend.key.size = unit(spaceLegend, "lines"))
}
```
# Read in data
```{r}
voomCounts <- readRDS(paste0("../../../rObjects/", condition, ".voomCountsMatrix.rds"))
load("../../../rObjects/bwnet.Rdata")
load("../../../rObjects/WGCNA_allSampleInput.RData")
module_eigengenes <- bwnet$MEs
head(module_eigengenes) # inspect 
ngenes_per_module <- table(bwnet$colors) # number of genes in each module 

dge.filtered.norm <- readRDS(paste0("../../../rObjects/dge.filtered.norm.rds"))
info <- as.data.frame(dge.filtered.norm$samples)
genes <- as.data.frame(dge.filtered.norm$genes)

info$lib.size.1 <- NULL
info$norm.factors.1 <- NULL
# 109 sex numeric 
# 29 Age
# 24 brain weight 
# 108 APOE E4 count <- check 
# 16 Cing LB <- replace NA with zero 
# 12 Thal 
# 11 Braak 

# replace NA with zero 
info$Cing.LB[is.na(info$Cing.LB)] <- 0

# keep only the columns that hold information we need. 
dataTraits <- info[, c(6,109, 29, 24, 108, 16, 12, 11)] # Keep 11:19,21,22,24,29,28, 37,108,109,114,117:124
dim(dataTraits)
# disease type isn't numeric, make numeric as this is required down stream
numeric_traits <- sapply(dataTraits, as.numeric)
numeric_traits <- as.data.frame(numeric_traits) # save as data frame
rownames(numeric_traits) <- rownames(dataTraits) # add NPID as row names
```
# Plot dendrogram
This function plots a hierarchical clustering dendrogram and color annotation(s) of objects in the dendrogram underneath.
guideHang - fraction of the dendrogram height to leave between the top end of the guide line and the dendrogram merge height. 
```{r plot_dendrogram}
plotDendroAndColors(bwnet$dendrograms[[1]], cbind(bwnet$unmergedColors, bwnet$colors), 
                    c("unmerged", "merged"), 
                    dendroLabels = FALSE, 
                    addGuide = TRUE, 
                    hang = 0.03,
                    guideHang = 0.05)

path <- paste0("../../../results/manuscript_figures/Figure_4_dendrogram")
saveToPDF(paste0(path, ".pdf"), width = 6, height = 4)

```
# Association between modules and traits
Which modules are associated with our traits

binarizeCategoricalColumns - Given a data frame with (some) categorical columns, this function creates a set of indicator variables for the various possible sets of levels.

includePairwise - logical should pairwise binary indicators be included? For each pair of levels, the indicator is val1 for the lower level (earlier in levelOrder), val2 for the higher level and NA otherwise.
includeLevelVsAll - Logical: should binary indicators for each level be included? The indicator is val2 where x equals the level and val1 otherwise.
minCount - 	Levels of x for which there are fewer than minCount elements will be ignored.
```{r binary_traits}
controlvsdisease <- binarizeCategoricalColumns(dataTraits$TYPE, 
                           includePairwise = TRUE, 
                           includeLevelVsAll = TRUE, 
                           minCount = 1)
# remove data. from column names
names(controlvsdisease) <- gsub(x = names(controlvsdisease), 
                                pattern = "data.", replacement = "")  
traits <- cbind(numeric_traits, controlvsdisease) # column combine with dataTraits
# disease type isn't numeric, make numeric as this is required down stream
numeric_traits <- sapply(traits, as.numeric) # make sure all are numeric 
numeric_traits <- as.data.frame(numeric_traits) # save as data frame
rownames(numeric_traits) <- rownames(dataTraits) # add NPID as row names
```
# Correlation
Add multiple test correction - BH 
```{r correlation}
nSamples <- nrow(counts) # number of samples
nGenes <- ncol(counts) # number of genes

# correlation between modules and traits 
module_trait_corr <- cor(module_eigengenes, numeric_traits, use = 'p')
# get the pval
# Calculates Student asymptotic p-value for given correlations.
module_trait_corr_pval <- corPvalueStudent(module_trait_corr, nSamples)
module_trait_corr_pval
module_trait_corr_pval_df <- as.data.frame(module_trait_corr_pval)

# check for p-value and adjusted BH p-value 
#unadjust <- module_trait_corr_pval_df$AD.vs.CONTROL
#adjust <- p.adjust(module_trait_corr_pval_df$AD.vs.CONTROL, method = p.adjust.methods, n = length(module_trait_corr_pval_df$AD.vs.CONTROL))

library(magrittr)
module_trait_corr_pval_fdr <- module_trait_corr_pval %>% 
     as.vector %>% 
     p.adjust(method='fdr') %>% # FDR is Benjamini & Hochberg
     matrix(ncol=17)

colnames(module_trait_corr_pval_fdr) <- colnames(module_trait_corr_pval)
rownames(module_trait_corr_pval_fdr) <- rownames(module_trait_corr_pval)
```
# Heatmap
```{r heatmap}
heatmap.data <- merge(module_eigengenes, numeric_traits, by = "row.names")
heatmap.data <- heatmap.data %>%
  column_to_rownames(var = 'Row.names')

# some data has missing values with na, such as lewy body count. 
# Replace na with zero 
#heatmap.data["Cing.LB"][is.na(heatmap.data["Cing.LB"])] <- 0
#heatmap.data["Cing.Synuclein"][is.na(heatmap.data["Cing.Synuclein"])] <- 0
plot_colors <- names(heatmap.data)[1:15]
plot_colors <- gsub("ME", "", plot_colors)

#par(mar= c(5, 5, 3, 3)) # bottom, left, top and right 
cor_disease_plot <- CorLevelPlot(heatmap.data, 
             x = c(names(heatmap.data)[17:26], names(heatmap.data)[29]), # which traits
             y = names(heatmap.data)[1:15], # gene modules 
             col = c("blue1", "skyblue", "white", "pink", "red"),
             rotLabX = 45, 
             colLabY = c("black"), #plot_colors
            # main = "Module-trait relationships", 
            # cexMain = 1, 
             fontLabX = 1,
             fontLabY = 1) # color scale
cor_disease_plot
```
# Pretty heatmap correlation
```{r}
numeric_traits_selective <- numeric_traits[, c(2:11,14)] # Keep
module_trait_corr_selective <- module_trait_corr[, c(2:11,14)] # Keep
module_trait_corr_pval_selective <- module_trait_corr_pval_fdr[, c(2:11,14)] # Keep
#Print correlation heatmap between modules and traits
textMatrix= paste(signif(module_trait_corr_selective, 2), "\n(",
                        signif(module_trait_corr_pval_selective, 1), ")", sep= "")

data  <- melt(module_trait_corr_selective)
#data$Var2 <- as.factor(data$Var2)
#data_levels <- levels(data$Var2)
data$Var2 <-
      gsub(
       ".vs.",
        " vs ",
        data$Var2
      )
data$Var2 <-
      gsub(
       "CONTROL",
        "Control",
        data$Var2
      )
data$Var2 <-
      gsub(
       "sex_numeric",
        "sex",
        data$Var2
      )
#data$Var2 <- factor(data$Var2, levels = c("PA vs Control",  "AD vs Control", "LBD vs Control", "LBD vs AD"))
#data$Var2 <- factor(data$Var2, levels = data_levels)

FDRq <- melt(module_trait_corr_pval_selective)
data$stars <- ifelse(FDRq$value < .0001, "***", ifelse(FDRq$value < .01, "**", ifelse(FDRq$value < .05, "*", " ")))
data$sig <- paste0(round(data$value, digits = 2), data$stars)

data$Var2 <- factor(data$Var2, levels = unique(data$Var2))
ME_heatmap <- ggplot(data = data) +
  geom_tile(aes(x = Var2, y = Var1, fill = value)) +
  geom_text(aes(x = Var2, y = Var1, label = sig), size = 2.8) +
  #scale_color_manual(values = c('black' = 'black', 'white' = 'white'), guide = "none") +
  scale_fill_gradientn(colours = c("blue","white","red"), 
                         values = rescale(c(-.3,.3)),
                         guide = "colorbar", limits=c(-.35, .35),
                         breaks = c(-.35, 0, .35), name = "Pearson's r") +
  scale_x_discrete(expand = c(0,0)) +
 theme_bw() +
    theme(strip.text = element_text(size = 8), 
          axis.text.y = element_text(size = 8, margin = margin(t = 0, r = 10, b = 0, l = 0)),
          axis.title.y = element_blank(), 
          axis.text.x = element_text(size = 8, color = "black", angle = 45, vjust = 1, hjust=1), 
          axis.title.x = element_blank(), 
          legend.text = element_text(size = 8),
          legend.title = element_text(size = 8),
          legend.margin=margin(0,0.5,0,0),
          legend.box.margin=margin(-10,-2,-10,-7.5), 
          plot.margin = margin(0.1, 0.3, 0.2, 0.3, "cm"), #t,r,b,l
          plot.title = element_text(size = 8, margin = margin(.1,.1,.4,0))) +
  ggtitle("Module-trait relationships") +
    theme(
    legend.position = "right", 
    legend.text = element_text(size =6), 
    legend.title = element_text (size = 8), 
    legend.margin=margin(0,0,1,0),
    legend.key.size = unit(0.5, "cm"))
ME_heatmap <- addSmallLegend(ME_heatmap)
ME_heatmap

path <- paste0("../../../results/manuscript_figures/Supplemental_Figure_5_WGCNA_module_trait_relationship_FDRq")
saveToPDF(paste0(path, ".pdf"), width = 8.5, height = 6)
```

# Metascape
#### 2 greenyellow
```{r}
greenyellow_enrich_results <-
  read_excel(
    paste0(
      "../../../results/",
      tool,
      "/WGCNA/metascape/greenyellow/metascape_result.xlsx"
    ), sheet = 2
  )


GO_ID_greenyellow <- c(
    "1_Summary",
    "2_Summary",
    "3_Summary",
    "4_Summary",
    "5_Summary",
    "6_Summary",
    "7_Summary",
    "8_Summary",
    "9_Summary",
    "11_Summary"

)


greenyellow_enrich_results_subset <-
  greenyellow_enrich_results[greenyellow_enrich_results$GroupID %in% GO_ID_greenyellow, ]
greenyellow_enrich_results_subset$Cluster <- c("greenyellow")
greenyellow_enrich_results_subset$Description <-
  factor(greenyellow_enrich_results_subset$Description,
         levels = greenyellow_enrich_results_subset$Description)
greenyellow_enrich_results_subset$Description <-
  fct_rev(greenyellow_enrich_results_subset$Description)

greenyellow_gene_count <-
  strsplit(as.character(greenyellow_enrich_results_subset$InTerm_InList),
           "/",
           fixed = T)
greenyellow_gene_count_df <-
  data.frame(matrix(
    unlist(greenyellow_gene_count),
    nrow = length(greenyellow_gene_count),
    byrow = TRUE
  ), stringsAsFactors = FALSE)
greenyellow_enrich_results_subset$InTerm <- as.numeric(greenyellow_gene_count_df$X1)
greenyellow_enrich_results_subset$Description <-
      gsub(
       "regulation of transcription from RNA polymerase II promoter in response to stress",
        "reg RNA polymerase II promoter, stress",
        greenyellow_enrich_results_subset$Description
      )

greenyellow_enrich_results_subset$Description <-
      gsub(
       "pteridine−containing compound metabolic process",
        "pteridine compound metabolic process",
        greenyellow_enrich_results_subset$Description
      )

greenyellow_enrich_results_subset$Description <- factor(greenyellow_enrich_results_subset$Description, levels = greenyellow_enrich_results_subset$Description)

greenyellow_enrich_results_subset$Description <- factor(greenyellow_enrich_results_subset$Description, levels = rev(greenyellow_enrich_results_subset$Description))

greenyellow_enrich_plot <-
  ggplot(data = greenyellow_enrich_results_subset, aes(x = InTerm, y = Description)) +
  ggplot2::facet_grid(~ Cluster) +
  geom_bar(stat = "identity", aes(fill = LogP), width = .65) +
  theme_bw() +
  scale_y_discrete(expand = c(0, 0)) +
  labs(x = "Gene count", y = "") +
  guides(fill = guide_legend(
    size = 1,
    title = expression(log[10] ~ "(" ~ italic("p") ~ "-value)")
  )) +
  scale_fill_gradientn(
    colours = c("green", "greenyellow"), # midnightblue
    guide = "legend",
    limits = c(-12,-1)
  ) + theme(strip.text = element_text(size = 8), 
          axis.text.y = element_text(size = 8),
          axis.text.x = element_text(size = 8), 
          axis.title.x = element_text(size = 8), 
          legend.text = element_text(size = 8),
          legend.title = element_text(size = 8),
          legend.margin=margin(0,0.5,0,0),
          legend.box.margin=margin(-10,-2,-10,-7.5), 
          plot.margin = margin(0.1, 0.3, 0.3, 0.1, "cm"), 
          plot.title = element_text(size = 8, hjust = -2.25, vjust=0, margin = margin(0,0,0,0)))
 #  theme(aspect.ratio = 1.5) # to reduce the size of the boxes 
addSmallLegend <- function(greenyellow_enrich_plot, pointSize = 3, textSize = 6, spaceLegend = .5) {
    greenyellow_enrich_plot +
        guides(shape = guide_legend(override.aes = list(size = pointSize)),
               color = guide_legend(override.aes = list(size = pointSize))) +
        theme(legend.title = element_text(size = textSize), 
              legend.position = "right",
              legend.text  = element_text(size = textSize),
              legend.key.size = unit(spaceLegend, "lines"))
}
# Apply on original plot
greenyellow_enrich_plot <- addSmallLegend(greenyellow_enrich_plot)
greenyellow_enrich_plot
```
### 3 blue
```{r}
blue_enrich_results <-
  read_excel(
    paste0(
      "../../../results/",
      tool,
      "/WGCNA/metascape/blue/metascape_result.xlsx"
    ), sheet = 2
  )


GO_ID_blue <- c(
    "1_Summary",
    "2_Summary",
    "3_Summary",
    "4_Summary",
    "5_Summary",
    "6_Summary",
    "7_Summary",
    "8_Summary",
    "9_Summary",
    "10_Summary",
    "11_Summary",
    "12_Summary",
    "13_Summary",
    "14_Summary",
    "15_Summary",
    "16_Summary",
    "17_Summary",
    "18_Summary",
    "19_Summary",    
    "20_Summary"

)

blue_enrich_results_subset <-
  blue_enrich_results[blue_enrich_results$GroupID %in% GO_ID_blue, ]
blue_enrich_results_subset$Cluster <- c("blue")
blue_enrich_results_subset$Description <-
  factor(blue_enrich_results_subset$Description,
         levels = blue_enrich_results_subset$Description)
blue_enrich_results_subset$Description <-
  fct_rev(blue_enrich_results_subset$Description)

blue_gene_count <-
  strsplit(as.character(blue_enrich_results_subset$InTerm_InList),
           "/",
           fixed = T)
blue_gene_count_df <-
  data.frame(matrix(
    unlist(blue_gene_count),
    nrow = length(blue_gene_count),
    byrow = TRUE
  ), stringsAsFactors = FALSE)
blue_enrich_results_subset$InTerm <- as.numeric(blue_gene_count_df$X1)

blue_enrich_results_subset$Description <-
      gsub(
       "Fatty Acids and Lipoproteins Transport in Hepatocytes",
        "Fatty Acids & Lipoproteins Transport in Hepatocytes",
        blue_enrich_results_subset$Description
      )

blue_enrich_results_subset$Description <-
      gsub(
       "negative regulation of cellular component organization",
        "neg reg of cellular component organization",
        blue_enrich_results_subset$Description
      )
blue_enrich_results_subset$Description <- factor(blue_enrich_results_subset$Description, levels = blue_enrich_results_subset$Description)

blue_enrich_results_subset$Description <- factor(blue_enrich_results_subset$Description, levels = rev(blue_enrich_results_subset$Description))

blue_enrich_plot <-
  ggplot(data = blue_enrich_results_subset, aes(x = InTerm, y = Description)) +
  ggplot2::facet_grid(~ Cluster) +
  geom_bar(stat = "identity", aes(fill = LogP), width = .65) +
  theme_bw() +
  scale_y_discrete(expand = c(0, 0)) +
  labs(x = "Gene count", y = "") +
  guides(fill = guide_legend(
    size = 1,
    title = expression(log[10] ~ "(" ~ italic("p") ~ "-value)")
  )) +
  scale_fill_gradientn(
    colours = c("blue", "gray"), # midnightblue
    guide = "legend",
    limits = c(-27,-1)
  ) + theme(strip.text = element_text(size = 8), 
          axis.text.y = element_text(size = 8),
          axis.text.x = element_text(size = 8), 
          axis.title.x = element_text(size = 8), 
          legend.text = element_text(size = 8),
          legend.title = element_text(size = 8),
          legend.margin=margin(0,0.5,0,0),
          legend.box.margin=margin(-10,-2,-10,-7.5), 
          plot.margin = margin(0.1, 0.3, 0.3, 0.1, "cm"), 
          plot.title = element_text(size = 8, hjust = -2.25, vjust=0, margin = margin(0,0,0,0)))
 #  theme(aspect.ratio = 1.5) # to reduce the size of the boxes 
addSmallLegend <- function(blue_enrich_plot, pointSize = 3, textSize = 6, spaceLegend = .5) {
    blue_enrich_plot +
        guides(shape = guide_legend(override.aes = list(size = pointSize)),
               color = guide_legend(override.aes = list(size = pointSize))) +
        theme(legend.title = element_text(size = textSize), 
              legend.position = "right",
              legend.text  = element_text(size = textSize),
              legend.key.size = unit(spaceLegend, "lines"))
}
# Apply on original plot
blue_enrich_plot <- addSmallLegend(blue_enrich_plot)
blue_enrich_plot
```
### 4 cyan
```{r}
cyan_enrich_results <-
  read_excel(
    paste0(
      "../../../results/",
      tool,
      "/WGCNA/metascape/cyan/metascape_result.xlsx"
    ), sheet = 2
  )


GO_ID_cyan <- c(
    "1_Summary",
    "2_Summary",
    "3_Summary",
    "4_Summary",
    "5_Summary",
    "6_Summary",
    "7_Summary",
    "8_Summary",
    "9_Summary",
    "10_Summary",
    "11_Summary",
    "12_Summary",
    "13_Summary",
    "14_Summary",
    "15_Summary",
    "16_Summary",
    "17_Summary",
    "18_Summary",
    "19_Summary",    
    "20_Summary"

)

cyan_enrich_results_subset <-
  cyan_enrich_results[cyan_enrich_results$GroupID %in% GO_ID_cyan, ]
cyan_enrich_results_subset$Cluster <- c("cyan")
cyan_enrich_results_subset$Description <-
  factor(cyan_enrich_results_subset$Description,
         levels = cyan_enrich_results_subset$Description)
cyan_enrich_results_subset$Description <-
  fct_rev(cyan_enrich_results_subset$Description)

cyan_gene_count <-
  strsplit(as.character(cyan_enrich_results_subset$InTerm_InList),
           "/",
           fixed = T)
cyan_gene_count_df <-
  data.frame(matrix(
    unlist(cyan_gene_count),
    nrow = length(cyan_gene_count),
    byrow = TRUE
  ), stringsAsFactors = FALSE)
cyan_enrich_results_subset$InTerm <- as.numeric(cyan_gene_count_df$X1)
cyan_enrich_results_subset$Description <-
      gsub(
       "regulation of cysteine-type endopeptidase activity involved in apoptotic process",
        "reg cysteine endopeptidase activity, apoptotic process",
        cyan_enrich_results_subset$Description
      )

cyan_enrich_results_subset$Description <-
      gsub(
       "HSP90 chaperone cycle for steroid hormone receptors (SHR) in the presence of ligand",
       "HSP90 chaperone cycle for steroid hormone receptors",
        cyan_enrich_results_subset$Description
      )
cyan_enrich_results_subset$Description[3] <- "HSP90 chaperone cycle for steroid hormone receptors"
cyan_enrich_results_subset$Description <- factor(cyan_enrich_results_subset$Description, levels = cyan_enrich_results_subset$Description)

cyan_enrich_results_subset$Description <- factor(cyan_enrich_results_subset$Description, levels = rev(cyan_enrich_results_subset$Description))


cyan_enrich_plot <-
  ggplot(data = cyan_enrich_results_subset, aes(x = InTerm, y = Description)) +
  ggplot2::facet_grid(~ Cluster) +
  geom_bar(stat = "identity", aes(fill = LogP), width = .65) +
  theme_bw() +
  scale_y_discrete(expand = c(0, 0)) +
  labs(x = "Gene count", y = "") +
  guides(fill = guide_legend(
    size = 1,
    title = expression(log[10] ~ "(" ~ italic("p") ~ "-value)")
  )) +
  scale_fill_gradientn(
    colours = c("cyan", "gray"), # midnightcyan
    guide = "legend",
    limits = c(-33,-1)
  ) + theme(strip.text = element_text(size = 8), 
          axis.text.y = element_text(size = 8),
          axis.text.x = element_text(size = 8), 
          axis.title.x = element_text(size = 8), 
          legend.text = element_text(size = 8),
          legend.title = element_text(size = 8),
          legend.margin=margin(0,0.5,0,0),
          legend.box.margin=margin(-10,-2,-10,-7.5), 
          plot.margin = margin(0.1, 0.3, 0.3, 0.1, "cm"), 
          plot.title = element_text(size = 8, hjust = -2.25, vjust=0, margin = margin(0,0,0,0)))
 #  theme(aspect.ratio = 1.5) # to reduce the size of the boxes 
addSmallLegend <- function(cyan_enrich_plot, pointSize = 3, textSize = 6, spaceLegend = .5) {
    cyan_enrich_plot +
        guides(shape = guide_legend(override.aes = list(size = pointSize)),
               color = guide_legend(override.aes = list(size = pointSize))) +
        theme(legend.title = element_text(size = textSize), 
              legend.position = "right",
              legend.text  = element_text(size = textSize),
              legend.key.size = unit(spaceLegend, "lines"))
}
# Apply on original plot
cyan_enrich_plot <- addSmallLegend(cyan_enrich_plot)
cyan_enrich_plot
```
#### 5 salmon
```{r}
salmon_enrich_results <-
  read_excel(
    paste0(
      "../../../results/",
      tool,
      "/WGCNA/metascape/salmon/metascape_result.xlsx"
    ), sheet = 2
  )


GO_ID_salmon <- c(
    "1_Summary",
    "2_Summary",
    "3_Summary",
    "4_Summary",
    "5_Summary",
    "7_Summary",
    "8_Summary",
    "9_Summary"
)

salmon_enrich_results_subset <-
  salmon_enrich_results[salmon_enrich_results$GroupID %in% GO_ID_salmon, ]
salmon_enrich_results_subset$Cluster <- c("salmon")
salmon_enrich_results_subset$Description <-
  factor(salmon_enrich_results_subset$Description,
         levels = salmon_enrich_results_subset$Description)
salmon_enrich_results_subset$Description <-
  fct_rev(salmon_enrich_results_subset$Description)

salmon_gene_count <-
  strsplit(as.character(salmon_enrich_results_subset$InTerm_InList),
           "/",
           fixed = T)
salmon_gene_count_df <-
  data.frame(matrix(
    unlist(salmon_gene_count),
    nrow = length(salmon_gene_count),
    byrow = TRUE
  ), stringsAsFactors = FALSE)
salmon_enrich_results_subset$InTerm <- as.numeric(salmon_gene_count_df$X1)

#salmon_enrich_results_subset$Description <-
#      gsub(
#       "regulation of cysteine-type endopeptidase activity involved in apoptotic process",
#        "reg cysteine endopeptidase in apoptotic process",
#        salmon_enrich_results_subset$Description
#      )
#
salmon_enrich_results_subset$Description <- factor(salmon_enrich_results_subset$Description, levels = salmon_enrich_results_subset$Description)

salmon_enrich_results_subset$Description <- factor(salmon_enrich_results_subset$Description, levels = rev(salmon_enrich_results_subset$Description))

salmon_enrich_plot <-
  ggplot(data = salmon_enrich_results_subset, aes(x = InTerm, y = Description)) +
  ggplot2::facet_grid(~ Cluster) +
  geom_bar(stat = "identity", aes(fill = LogP), width = .65) +
  theme_bw() +
  scale_y_discrete(expand = c(0, 0)) +
  labs(x = "Gene count", y = "") +
  guides(fill = guide_legend(
    size = 1,
    title = expression(log[10] ~ "(" ~ italic("p") ~ "-value)")
  )) +
  scale_fill_gradientn(
    colours = c("#800026FF","#FD8D3CFF", "salmon"), # midnightblue
    guide = "legend",
    limits = c(-100,-2)
  ) + theme(strip.text = element_text(size = 8), 
          axis.text.y = element_text(size = 8),
          axis.text.x = element_text(size = 8), 
          axis.title.x = element_text(size = 8), 
          legend.text = element_text(size = 8),
          legend.title = element_text(size = 8),
          legend.margin=margin(0,0.5,0,0),
          legend.box.margin=margin(-10,-2,-10,-7.5), 
          plot.margin = margin(0.1, 0.3, 0.3, 0.1, "cm"), 
          plot.title = element_text(size = 8, hjust = -2.25, vjust=0, margin = margin(0,0,0,0)))
 #  theme(aspect.ratio = 1.5) # to reduce the size of the boxes 
addSmallLegend <- function(salmon_enrich_plot, pointSize = 3, textSize = 6, spaceLegend = .5) {
    salmon_enrich_plot +
        guides(shape = guide_legend(override.aes = list(size = pointSize)),
               color = guide_legend(override.aes = list(size = pointSize))) +
        theme(legend.title = element_text(size = textSize), 
              legend.position = "right",
              legend.text  = element_text(size = textSize),
              legend.key.size = unit(spaceLegend, "lines"))
}
# Apply on original plot
salmon_enrich_plot <- addSmallLegend(salmon_enrich_plot)
salmon_enrich_plot
```
### 6 red
```{r}
red_enrich_results <-
  read_excel(
    paste0(
      "../../../results/",
      tool,
      "/WGCNA/metascape/red/metascape_result.xlsx"
    ), sheet = 2
  )


GO_ID_red <- c(
    "1_Summary",
    "2_Summary",
    "3_Summary",
    "4_Summary",
    "5_Summary",
    "6_Summary",
    "7_Summary",
    "8_Summary",
    "9_Summary",
    "10_Summary",
    "11_Summary",
    "12_Summary",
    "13_Summary",
    "14_Summary",
    "15_Summary",
    "16_Summary",
    "17_Summary",
    "18_Summary",
    "19_Summary",    
    "20_Summary"

)

red_enrich_results_subset <-
  red_enrich_results[red_enrich_results$GroupID %in% GO_ID_red, ]
red_enrich_results_subset$Cluster <- c("red")
red_enrich_results_subset$Description <-
  factor(red_enrich_results_subset$Description,
         levels = red_enrich_results_subset$Description)
red_enrich_results_subset$Description <-
  fct_rev(red_enrich_results_subset$Description)

red_gene_count <-
  strsplit(as.character(red_enrich_results_subset$InTerm_InList),
           "/",
           fixed = T)
red_gene_count_df <-
  data.frame(matrix(
    unlist(red_gene_count),
    nrow = length(red_gene_count),
    byrow = TRUE
  ), stringsAsFactors = FALSE)
red_enrich_results_subset$InTerm <- as.numeric(red_gene_count_df$X1)
red_enrich_results_subset$Description <-
      gsub(
       "Signaling by Rho GTPases, Miro GTPases and RHOBTB3",
        "Rho GTPases, Miro GTPases and RHOBTB3",
        red_enrich_results_subset$Description
      )

red_enrich_results_subset$Description <- factor(red_enrich_results_subset$Description, levels = red_enrich_results_subset$Description)

red_enrich_results_subset$Description <- factor(red_enrich_results_subset$Description, levels = rev(red_enrich_results_subset$Description))

red_enrich_plot <-
  ggplot(data = red_enrich_results_subset, aes(x = InTerm, y = Description)) +
  ggplot2::facet_grid(~ Cluster) +
  geom_bar(stat = "identity", aes(fill = LogP), width = .65) +
  theme_bw() +
  scale_y_discrete(expand = c(0, 0)) +
  labs(x = "Gene count", y = "") +
  guides(fill = guide_legend(
    size = 1,
    title = expression(log[10] ~ "(" ~ italic("p") ~ "-value)")
  )) +
  scale_fill_gradientn(
    colours = c("red", "gray"), # midnightred
    guide = "legend",
    limits = c(-16,-1)
  ) + theme(strip.text = element_text(size = 8), 
          axis.text.y = element_text(size = 8),
          axis.text.x = element_text(size = 8), 
          axis.title.x = element_text(size = 8), 
          legend.text = element_text(size = 8),
          legend.title = element_text(size = 8),
          legend.margin=margin(0,0.5,0,0),
          legend.box.margin=margin(-10,-2,-10,-7.5), 
          plot.margin = margin(0.1, 0.3, 0.3, 0.1, "cm"), 
          plot.title = element_text(size = 8, hjust = -2.25, vjust=0, margin = margin(0,0,0,0)))
 #  theme(aspect.ratio = 1.5) # to reduce the size of the boxes 
addSmallLegend <- function(red_enrich_plot, pointSize = 3, textSize = 6, spaceLegend = .5) {
    red_enrich_plot +
        guides(shape = guide_legend(override.aes = list(size = pointSize)),
               color = guide_legend(override.aes = list(size = pointSize))) +
        theme(legend.title = element_text(size = textSize), 
              legend.position = "right",
              legend.text  = element_text(size = textSize),
              legend.key.size = unit(spaceLegend, "lines"))
}
# Apply on original plot
red_enrich_plot <- addSmallLegend(red_enrich_plot)
red_enrich_plot
```
#### 7 magenta
```{r}
magenta_enrich_results <-
  read_excel(
    paste0(
      "../../../results/",
      tool,
      "/WGCNA/metascape/magenta/metascape_result.xlsx"
    ), sheet = 2
  )


GO_ID_magenta <- c(
    "1_Summary",
    "2_Summary",
    "3_Summary",
    "4_Summary",
    "5_Summary",
    "6_Summary",
    "7_Summary",
    "8_Summary",
    "9_Summary",
    "10_Summary",
    "11_Summary",
    "12_Summary",
    "13_Summary",
    "14_Summary",
    "15_Summary",
    "16_Summary",
    "17_Summary",
    "18_Summary",
    "19_Summary",    
    "20_Summary"

)

magenta_enrich_results_subset <-
  magenta_enrich_results[magenta_enrich_results$GroupID %in% GO_ID_magenta, ]
magenta_enrich_results_subset$Cluster <- c("magenta")
magenta_enrich_results_subset$Description <-
  factor(magenta_enrich_results_subset$Description,
         levels = magenta_enrich_results_subset$Description)
magenta_enrich_results_subset$Description <-
  fct_rev(magenta_enrich_results_subset$Description)

magenta_gene_count <-
  strsplit(as.character(magenta_enrich_results_subset$InTerm_InList),
           "/",
           fixed = T)
magenta_gene_count_df <-
  data.frame(matrix(
    unlist(magenta_gene_count),
    nrow = length(magenta_gene_count),
    byrow = TRUE
  ), stringsAsFactors = FALSE)
magenta_enrich_results_subset$InTerm <- as.numeric(magenta_gene_count_df$X1)

magenta_enrich_results_subset$Description <-
      gsub(
       "regulation of myeloid leukocyte mediated immunity",
        "reg of myeloid leukocyte mediated immunity",
        magenta_enrich_results_subset$Description
      )

magenta_enrich_results_subset$Description <- factor(magenta_enrich_results_subset$Description, levels = magenta_enrich_results_subset$Description)

magenta_enrich_results_subset$Description <- factor(magenta_enrich_results_subset$Description, levels = rev(magenta_enrich_results_subset$Description))

magenta_enrich_plot <-
  ggplot(data = magenta_enrich_results_subset, aes(x = InTerm, y = Description)) +
  ggplot2::facet_grid(~ Cluster) +
  geom_bar(stat = "identity", aes(fill = LogP), width = .65) +
  theme_bw() +
  scale_y_discrete(expand = c(0, 0)) +
  labs(x = "Gene count", y = "") +
  guides(fill = guide_legend(
    size = 1,
    title = expression(log[10] ~ "(" ~ italic("p") ~ "-value)")
  )) +
  scale_fill_gradientn(
    colours = c("magenta", "gray"), # midnightblue
    guide = "legend",
    limits = c(-32,-2)
  ) + theme(strip.text = element_text(size = 8), 
          axis.text.y = element_text(size = 8),
          axis.text.x = element_text(size = 8), 
          axis.title.x = element_text(size = 8), 
          legend.text = element_text(size = 8),
          legend.title = element_text(size = 8),
          legend.margin=margin(0,0.5,0,0),
          legend.box.margin=margin(-10,-2,-10,-7.5), 
          plot.margin = margin(0.1, 0.3, 0.3, 0.1, "cm"), 
          plot.title = element_text(size = 8, hjust = -2.25, vjust=0, margin = margin(0,0,0,0)))
 #  theme(aspect.ratio = 1.5) # to reduce the size of the boxes 
addSmallLegend <- function(magenta_enrich_plot, pointSize = 3, textSize = 6, spaceLegend = .5) {
    magenta_enrich_plot +
        guides(shape = guide_legend(override.aes = list(size = pointSize)),
               color = guide_legend(override.aes = list(size = pointSize))) +
        theme(legend.title = element_text(size = textSize), 
              legend.position = "right",
              legend.text  = element_text(size = textSize),
              legend.key.size = unit(spaceLegend, "lines"))
}
# Apply on original plot
magenta_enrich_plot <- addSmallLegend(magenta_enrich_plot)
magenta_enrich_plot
```
### 8 black
```{r}
black_enrich_results <-
  read_excel(
    paste0(
      "../../../results/",
      tool,
      "/WGCNA/metascape/black/metascape_result.xlsx"
    ), sheet = 2
  )


GO_ID_black <- c(
    "1_Summary",
    "2_Summary",
    "3_Summary",
    "4_Summary",
    "5_Summary",
    "6_Summary",
    "7_Summary",
    "8_Summary",
    "9_Summary",
    "10_Summary",
    "11_Summary",
    "12_Summary",
    "13_Summary",
    "14_Summary",
    "15_Summary",
    "16_Summary",
    "17_Summary",
    "18_Summary",
    "19_Summary",    
    "20_Summary"

)

black_enrich_results_subset <-
  black_enrich_results[black_enrich_results$GroupID %in% GO_ID_black, ]
black_enrich_results_subset$Cluster <- c("black")
black_enrich_results_subset$Description <-
  factor(black_enrich_results_subset$Description,
         levels = black_enrich_results_subset$Description)
black_enrich_results_subset$Description <-
  fct_rev(black_enrich_results_subset$Description)

black_gene_count <-
  strsplit(as.character(black_enrich_results_subset$InTerm_InList),
           "/",
           fixed = T)
black_gene_count_df <-
  data.frame(matrix(
    unlist(black_gene_count),
    nrow = length(black_gene_count),
    byrow = TRUE
  ), stringsAsFactors = FALSE)
black_enrich_results_subset$InTerm <- as.numeric(black_gene_count_df$X1)

black_enrich_results_subset$Description <-
      gsub(
       "negative regulation of response to external stimulus",
        "neg reg of response to external stimulus",
        black_enrich_results_subset$Description
      )

black_enrich_results_subset$Description <-
      gsub(
       "NOTCH1 regulation of endothelial cell calcification",
        "NOTCH1 reg of endothelial cell calcification",
        black_enrich_results_subset$Description
      )
black_enrich_results_subset$Description <-
      gsub(
       "NOTCH1 regulation of endothelial cell calcification",
        "NOTCH1 reg of endothelial cell calcification",
        black_enrich_results_subset$Description
      )

black_enrich_results_subset$Description <-
      gsub(
       "NRP1-triggered signaling pathways in pancreatic cancer",
        "NRP1-triggered signal path in pancreatic cancer",
        black_enrich_results_subset$Description
      )

black_enrich_results_subset$Description <- factor(black_enrich_results_subset$Description, levels = black_enrich_results_subset$Description)

black_enrich_results_subset$Description <- factor(black_enrich_results_subset$Description, levels = rev(black_enrich_results_subset$Description))

black_enrich_plot <-
  ggplot(data = black_enrich_results_subset, aes(x = InTerm, y = Description)) +
  ggplot2::facet_grid(~ Cluster) +
  geom_bar(stat = "identity", aes(fill = LogP), width = .65) +
  theme_bw() +
  scale_y_discrete(expand = c(0, 0)) +
  labs(x = "Gene count", y = "") +
  guides(fill = guide_legend(
    size = 1,
    title = expression(log[10] ~ "(" ~ italic("p") ~ "-value)")
  )) +
  scale_fill_gradientn(
    colours = c("black", "gray"), # midnightblack
    guide = "legend",
    limits = c(-14,-1)
  ) + theme(strip.text = element_text(size = 8), 
          axis.text.y = element_text(size = 8),
          axis.text.x = element_text(size = 8), 
          axis.title.x = element_text(size = 8), 
          legend.text = element_text(size = 8),
          legend.title = element_text(size = 8),
          legend.margin=margin(0,0.5,0,0),
          legend.box.margin=margin(-10,-2,-10,-7.5), 
          plot.margin = margin(0.1, 0.3, 0.3, 0.1, "cm"), 
          plot.title = element_text(size = 8, hjust = -2.25, vjust=0, margin = margin(0,0,0,0)))
 #  theme(aspect.ratio = 1.5) # to blackuce the size of the boxes 
addSmallLegend <- function(black_enrich_plot, pointSize = 3, textSize = 6, spaceLegend = .5) {
    black_enrich_plot +
        guides(shape = guide_legend(override.aes = list(size = pointSize)),
               color = guide_legend(override.aes = list(size = pointSize))) +
        theme(legend.title = element_text(size = textSize), 
              legend.position = "right",
              legend.text  = element_text(size = textSize),
              legend.key.size = unit(spaceLegend, "lines"))
}
# Apply on original plot
black_enrich_plot <- addSmallLegend(black_enrich_plot)
black_enrich_plot
```
### 9 yellow
```{r}
yellow_enrich_results <-
  read_excel(
    paste0(
      "../../../results/",
      tool,
      "/WGCNA/metascape/yellow/metascape_result.xlsx"
    ), sheet = 2
  )


GO_ID_yellow <- c(
    "1_Summary",
    "2_Summary",
    "3_Summary",
    "4_Summary",
    "5_Summary",
    "6_Summary",
    "7_Summary",
    "8_Summary",
    "9_Summary",
    "10_Summary",
    "11_Summary",
    "12_Summary",
    "13_Summary",
    "14_Summary",
    "15_Summary",
    "16_Summary",
    "17_Summary",
    "18_Summary",
    "19_Summary",    
    "20_Summary"

)

yellow_enrich_results_subset <-
  yellow_enrich_results[yellow_enrich_results$GroupID %in% GO_ID_yellow, ]
yellow_enrich_results_subset$Cluster <- c("yellow")
yellow_enrich_results_subset$Description <-
  factor(yellow_enrich_results_subset$Description,
         levels = yellow_enrich_results_subset$Description)
yellow_enrich_results_subset$Description <-
  fct_rev(yellow_enrich_results_subset$Description)

yellow_gene_count <-
  strsplit(as.character(yellow_enrich_results_subset$InTerm_InList),
           "/",
           fixed = T)
yellow_gene_count_df <-
  data.frame(matrix(
    unlist(yellow_gene_count),
    nrow = length(yellow_gene_count),
    byrow = TRUE
  ), stringsAsFactors = FALSE)
yellow_enrich_results_subset$InTerm <- as.numeric(yellow_gene_count_df$X1)
yellow_enrich_results_subset$Description <-
      gsub(
       "cellular component assembly involved in morphogenesis",
        "cellular component assembly in morphogenesis",
        yellow_enrich_results_subset$Description
      )
yellow_enrich_results_subset$Description <-
      gsub(
       "regulation of cellular response to growth factor stimulus",
        "reg of cellular response to growth factor stimulus",
        yellow_enrich_results_subset$Description
      )

yellow_enrich_results_subset$Description <- factor(yellow_enrich_results_subset$Description, levels = yellow_enrich_results_subset$Description)

yellow_enrich_results_subset$Description <- factor(yellow_enrich_results_subset$Description, levels = rev(yellow_enrich_results_subset$Description))

yellow_enrich_plot <-
  ggplot(data = yellow_enrich_results_subset, aes(x = InTerm, y = Description)) +
  ggplot2::facet_grid(~ Cluster) +
  geom_bar(stat = "identity", aes(fill = LogP), width = .65) +
  theme_bw() +
  scale_y_discrete(expand = c(0, 0)) +
  labs(x = "Gene count", y = "") +
  guides(fill = guide_legend(
    size = 1,
    title = expression(log[10] ~ "(" ~ italic("p") ~ "-value)")
  )) +
  scale_fill_gradientn(
    colours = c("yellow", "gray"), # midnightyellow
    guide = "legend",
    limits = c(-13,-1)
  ) + theme(strip.text = element_text(size = 8), 
          axis.text.y = element_text(size = 8),
          axis.text.x = element_text(size = 8), 
          axis.title.x = element_text(size = 8), 
          legend.text = element_text(size = 8),
          legend.title = element_text(size = 8),
          legend.margin=margin(0,0.5,0,0),
          legend.box.margin=margin(-10,-2,-10,-7.5), 
          plot.margin = margin(0.1, 0.3, 0.3, 0.1, "cm"), 
          plot.title = element_text(size = 8, hjust = -2.25, vjust=0, margin = margin(0,0,0,0)))
 #  theme(aspect.ratio = 1.5) # to yellowuce the size of the boxes 
addSmallLegend <- function(yellow_enrich_plot, pointSize = 3, textSize = 6, spaceLegend = .5) {
    yellow_enrich_plot +
        guides(shape = guide_legend(override.aes = list(size = pointSize)),
               color = guide_legend(override.aes = list(size = pointSize))) +
        theme(legend.title = element_text(size = textSize), 
              legend.position = "right",
              legend.text  = element_text(size = textSize),
              legend.key.size = unit(spaceLegend, "lines"))
}
# Apply on original plot
yellow_enrich_plot <- addSmallLegend(yellow_enrich_plot)
yellow_enrich_plot
```
### 10 pink
```{r}
pink_enrich_results <-
  read_excel(
    paste0(
      "../../../results/",
      tool,
      "/WGCNA/metascape/pink/metascape_result.xlsx"
    ), sheet = 2
  )


GO_ID_pink <- c(
    "1_Summary",
    "2_Summary",
    "3_Summary",
    "4_Summary",
    "5_Summary",
    "6_Summary",
    "7_Summary",
    "8_Summary",
    "9_Summary",
    "10_Summary",
    "11_Summary",
    "12_Summary",
    "13_Summary",
    "14_Summary",
    "15_Summary",
    "16_Summary",
    "17_Summary",
    "18_Summary",
    "19_Summary",    
    "20_Summary"

)

pink_enrich_results_subset <-
  pink_enrich_results[pink_enrich_results$GroupID %in% GO_ID_pink, ]
pink_enrich_results_subset$Cluster <- c("pink")
pink_enrich_results_subset$Description <-
  factor(pink_enrich_results_subset$Description,
         levels = pink_enrich_results_subset$Description)
pink_enrich_results_subset$Description <-
  fct_rev(pink_enrich_results_subset$Description)

pink_gene_count <-
  strsplit(as.character(pink_enrich_results_subset$InTerm_InList),
           "/",
           fixed = T)
pink_gene_count_df <-
  data.frame(matrix(
    unlist(pink_gene_count),
    nrow = length(pink_gene_count),
    byrow = TRUE
  ), stringsAsFactors = FALSE)
pink_enrich_results_subset$InTerm <- as.numeric(pink_gene_count_df$X1)

pink_enrich_results_subset$Description <-
      gsub(
       "Hair follicle development: cytodifferentiation - part 3 of 3",
        "Hair follicle development: cytodifferentiation",
        pink_enrich_results_subset$Description
      )

pink_enrich_results_subset$Description <- factor(pink_enrich_results_subset$Description, levels = pink_enrich_results_subset$Description)

pink_enrich_results_subset$Description <- factor(pink_enrich_results_subset$Description, levels = rev(pink_enrich_results_subset$Description))

pink_enrich_plot <-
  ggplot(data = pink_enrich_results_subset, aes(x = InTerm, y = Description)) +
  ggplot2::facet_grid(~ Cluster) +
  geom_bar(stat = "identity", aes(fill = LogP), width = .65) +
  theme_bw() +
  scale_y_discrete(expand = c(0, 0)) +
  labs(x = "Gene count", y = "") +
  guides(fill = guide_legend(
    size = 1,
    title = expression(log[10] ~ "(" ~ italic("p") ~ "-value)")
  )) +
  scale_fill_gradientn(
    colours = c("pink", "gray"), # midnightpink
    guide = "legend",
    limits = c(-12,-1)
  ) + theme(strip.text = element_text(size = 8), 
          axis.text.y = element_text(size = 8),
          axis.text.x = element_text(size = 8), 
          axis.title.x = element_text(size = 8), 
          legend.text = element_text(size = 8),
          legend.title = element_text(size = 8),
          legend.margin=margin(0,0.5,0,0),
          legend.box.margin=margin(-10,-2,-10,-7.5), 
          plot.margin = margin(0.1, 0.3, 0.3, 0.1, "cm"), 
          plot.title = element_text(size = 8, hjust = -2.25, vjust=0, margin = margin(0,0,0,0)))
 #  theme(aspect.ratio = 1.5) # to pinkuce the size of the boxes 
addSmallLegend <- function(pink_enrich_plot, pointSize = 3, textSize = 6, spaceLegend = .5) {
    pink_enrich_plot +
        guides(shape = guide_legend(override.aes = list(size = pointSize)),
               color = guide_legend(override.aes = list(size = pointSize))) +
        theme(legend.title = element_text(size = textSize), 
              legend.position = "right",
              legend.text  = element_text(size = textSize),
              legend.key.size = unit(spaceLegend, "lines"))
}
# Apply on original plot
pink_enrich_plot <- addSmallLegend(pink_enrich_plot)
pink_enrich_plot
```



#### 11 green
```{r}
green_enrich_results <-
  read_excel(
    paste0(
      "../../../results/",
      tool,
      "/WGCNA/metascape/green/metascape_result.xlsx"
    ), sheet = 2
  )


GO_ID_green <- c(
    "1_Summary",
    "2_Summary",
    "3_Summary",
    "4_Summary",
    "5_Summary",
    "6_Summary",
    "7_Summary",
    "8_Summary",
    "9_Summary",
    "11_Summary"

)

green_enrich_results_subset <-
  green_enrich_results[green_enrich_results$GroupID %in% GO_ID_green, ]
green_enrich_results_subset$Cluster <- c("green")
green_enrich_results_subset$Description <-
  factor(green_enrich_results_subset$Description,
         levels = green_enrich_results_subset$Description)
green_enrich_results_subset$Description <-
  fct_rev(green_enrich_results_subset$Description)

green_gene_count <-
  strsplit(as.character(green_enrich_results_subset$InTerm_InList),
           "/",
           fixed = T)
green_gene_count_df <-
  data.frame(matrix(
    unlist(green_gene_count),
    nrow = length(green_gene_count),
    byrow = TRUE
  ), stringsAsFactors = FALSE)
green_enrich_results_subset$InTerm <- as.numeric(green_gene_count_df$X1)

green_enrich_results_subset$Description <-
      gsub(
       "Diseases of signal transduction by growth factor receptors and second messenger",
        "Diseases of signal transduction",
        green_enrich_results_subset$Description
      )

green_enrich_results_subset$Description <-
      gsub(
       "Epithelial to mesenchymal transition in colorectal cancer",
        "Epithelial to mesenchymal transition",
        green_enrich_results_subset$Description
      )
green_enrich_results_subset$Description <- factor(green_enrich_results_subset$Description, levels = green_enrich_results_subset$Description)

green_enrich_results_subset$Description <- factor(green_enrich_results_subset$Description, levels = rev(green_enrich_results_subset$Description))

green_enrich_plot <-
  ggplot(data = green_enrich_results_subset, aes(x = InTerm, y = Description)) +
  ggplot2::facet_grid(~ Cluster) +
  geom_bar(stat = "identity", aes(fill = LogP), width = .65) +
  theme_bw() +
  scale_y_discrete(expand = c(0, 0)) +
  labs(x = "Gene count", y = "") +
  guides(fill = guide_legend(
    size = 1,
    title = expression(log[10] ~ "(" ~ italic("p") ~ "-value)")
  )) +
  scale_fill_gradientn(
    colours = c("green", "gray"), # midnightblue
    guide = "legend",
    limits = c(-9,-1)
  ) + theme(strip.text = element_text(size = 8), 
          axis.text.y = element_text(size = 8),
          axis.text.x = element_text(size = 8), 
          axis.title.x = element_text(size = 8), 
          legend.text = element_text(size = 8),
          legend.title = element_text(size = 8),
          legend.margin=margin(0,0.5,0,0),
          legend.box.margin=margin(-10,-2,-10,-7.5), 
          plot.margin = margin(0.1, 0.3, 0.3, 0.1, "cm"), 
          plot.title = element_text(size = 8, hjust = -2.25, vjust=0, margin = margin(0,0,0,0)))
 #  theme(aspect.ratio = 1.5) # to reduce the size of the boxes 
addSmallLegend <- function(green_enrich_plot, pointSize = 3, textSize = 6, spaceLegend = .5) {
    green_enrich_plot +
        guides(shape = guide_legend(override.aes = list(size = pointSize)),
               color = guide_legend(override.aes = list(size = pointSize))) +
        theme(legend.title = element_text(size = textSize), 
              legend.position = "right",
              legend.text  = element_text(size = textSize),
              legend.key.size = unit(spaceLegend, "lines"))
}
# Apply on original plot
green_enrich_plot <- addSmallLegend(green_enrich_plot)
green_enrich_plot
```
### 12 purple 
```{r}
purple_enrich_results <-
  read_excel(
    paste0(
      "../../../results/",
      tool,
      "/WGCNA/metascape/purple/metascape_result.xlsx"
    ), sheet = 2
  )


GO_ID_purple <- c(
    "1_Summary",
    "2_Summary",
    "3_Summary",
    "4_Summary",
    "5_Summary",
    "6_Summary",
    "7_Summary",
    "8_Summary",
    "9_Summary",
    "10_Summary",
    "11_Summary",
    "12_Summary",
    "13_Summary",
    "14_Summary",
    "15_Summary",
    "16_Summary",
    "17_Summary",
    "18_Summary",
    "19_Summary",    
    "20_Summary"

)

purple_enrich_results_subset <-
  purple_enrich_results[purple_enrich_results$GroupID %in% GO_ID_purple, ]
purple_enrich_results_subset$Cluster <- c("purple")
purple_enrich_results_subset$Description <-
  factor(purple_enrich_results_subset$Description,
         levels = purple_enrich_results_subset$Description)
purple_enrich_results_subset$Description <-
  fct_rev(purple_enrich_results_subset$Description)

purple_gene_count <-
  strsplit(as.character(purple_enrich_results_subset$InTerm_InList),
           "/",
           fixed = T)
purple_gene_count_df <-
  data.frame(matrix(
    unlist(purple_gene_count),
    nrow = length(purple_gene_count),
    byrow = TRUE
  ), stringsAsFactors = FALSE)
purple_enrich_results_subset$InTerm <- as.numeric(purple_gene_count_df$X1)

purple_enrich_results_subset$Description <-
      gsub(
       "cellular response to transforming growth factor beta stimulus",
        "cellular response: growth factor beta stimulus",
        purple_enrich_results_subset$Description
      )


purple_enrich_results_subset$Description <- factor(purple_enrich_results_subset$Description, levels = purple_enrich_results_subset$Description)

purple_enrich_results_subset$Description <- factor(purple_enrich_results_subset$Description, levels = rev(purple_enrich_results_subset$Description))

purple_enrich_plot <-
  ggplot(data = purple_enrich_results_subset, aes(x = InTerm, y = Description)) +
  ggplot2::facet_grid(~ Cluster) +
  geom_bar(stat = "identity", aes(fill = LogP), width = .65) +
  theme_bw() +
  scale_y_discrete(expand = c(0, 0)) +
  labs(x = "Gene count", y = "") +
  guides(fill = guide_legend(
    size = 1,
    title = expression(log[10] ~ "(" ~ italic("p") ~ "-value)")
  )) +
  scale_fill_gradientn(
    colours = c("purple", "gray"), # midnightpurple
    guide = "legend",
    limits = c(-8,-1)
  ) + theme(strip.text = element_text(size = 8), 
          axis.text.y = element_text(size = 8),
          axis.text.x = element_text(size = 8), 
          axis.title.x = element_text(size = 8), 
          legend.text = element_text(size = 8),
          legend.title = element_text(size = 8),
          legend.margin=margin(0,0.5,0,0),
          legend.box.margin=margin(-10,-2,-10,-7.5), 
          plot.margin = margin(0.1, 0.3, 0.3, 0.1, "cm"), 
          plot.title = element_text(size = 8, hjust = -2.25, vjust=0, margin = margin(0,0,0,0)))
 #  theme(aspect.ratio = 1.5) # to purpleuce the size of the boxes 
addSmallLegend <- function(purple_enrich_plot, pointSize = 3, textSize = 6, spaceLegend = .5) {
    purple_enrich_plot +
        guides(shape = guide_legend(override.aes = list(size = pointSize)),
               color = guide_legend(override.aes = list(size = pointSize))) +
        theme(legend.title = element_text(size = textSize), 
              legend.position = "right",
              legend.text  = element_text(size = textSize),
              legend.key.size = unit(spaceLegend, "lines"))
}
# Apply on original plot
purple_enrich_plot <- addSmallLegend(purple_enrich_plot)
purple_enrich_plot
```
### 13 turquoise - NA
### 14 tan 
```{r}
tan_enrich_results <-
  read_excel(
    paste0(
      "../../../results/",
      tool,
      "/WGCNA/metascape/tan/metascape_result.xlsx"
    ), sheet = 2
  )


GO_ID_tan <- c(
    "1_Summary",
    "2_Summary",
    "3_Summary",
    "4_Summary",
    "5_Summary",
    "6_Summary",
    "7_Summary",
    "8_Summary",
    "9_Summary",
    "10_Summary",
    "11_Summary",
    "12_Summary",
    "13_Summary",
    "14_Summary",
    "15_Summary",
    "16_Summary",
    "17_Summary",
    "18_Summary",
    "19_Summary",    
    "20_Summary"

)

tan_enrich_results_subset <-
  tan_enrich_results[tan_enrich_results$GroupID %in% GO_ID_tan, ]
tan_enrich_results_subset$Cluster <- c("tan")
tan_enrich_results_subset$Description <-
  factor(tan_enrich_results_subset$Description,
         levels = tan_enrich_results_subset$Description)
tan_enrich_results_subset$Description <-
  fct_rev(tan_enrich_results_subset$Description)

tan_gene_count <-
  strsplit(as.character(tan_enrich_results_subset$InTerm_InList),
           "/",
           fixed = T)
tan_gene_count_df <-
  data.frame(matrix(
    unlist(tan_gene_count),
    nrow = length(tan_gene_count),
    byrow = TRUE
  ), stringsAsFactors = FALSE)
tan_enrich_results_subset$InTerm <- as.numeric(tan_gene_count_df$X1)
tan_enrich_results_subset$Description <-
      gsub(
       "regulation of proteolysis involved in protein catabolic process",
        "reg proteolysis involved in protein catabolic proces",
        tan_enrich_results_subset$Description
      )

tan_enrich_results_subset$Description <-
      gsub(
        "Electron transport chain: OXPHOS system in mitochondria",
        "Electron transport chain: OXPHOS sym, mitochondria",
        tan_enrich_results_subset$Description
      )

tan_enrich_results_subset$Description <- factor(tan_enrich_results_subset$Description, levels = tan_enrich_results_subset$Description)

tan_enrich_results_subset$Description <- factor(tan_enrich_results_subset$Description, levels = rev(tan_enrich_results_subset$Description))

tan_enrich_plot <-
  ggplot(data = tan_enrich_results_subset, aes(x = InTerm, y = Description)) +
  ggplot2::facet_grid(~ Cluster) +
  geom_bar(stat = "identity", aes(fill = LogP), width = .65) +
  theme_bw() +
  scale_y_discrete(expand = c(0, 0)) +
  labs(x = "Gene count", y = "") +
  guides(fill = guide_legend(
    size = 1,
    title = expression(log[10] ~ "(" ~ italic("p") ~ "-value)")
  )) +
  scale_fill_gradientn(
    colours = c("#A75502", "tan"), # midnighttan
    guide = "legend",
    limits = c(-30,-1)
  ) + theme(strip.text = element_text(size = 8), 
          axis.text.y = element_text(size = 8),
          axis.text.x = element_text(size = 8), 
          axis.title.x = element_text(size = 8), 
          legend.text = element_text(size = 8),
          legend.title = element_text(size = 8),
          legend.margin=margin(0,0.5,0,0),
          legend.box.margin=margin(-10,-2,-10,-7.5), 
          plot.margin = margin(0.1, 0.3, 0.3, 0.1, "cm"), 
          plot.title = element_text(size = 8, hjust = -2.25, vjust=0, margin = margin(0,0,0,0)))
 #  theme(aspect.ratio = 1.5) # to tanuce the size of the boxes 
addSmallLegend <- function(tan_enrich_plot, pointSize = 3, textSize = 6, spaceLegend = .5) {
    tan_enrich_plot +
        guides(shape = guide_legend(override.aes = list(size = pointSize)),
               color = guide_legend(override.aes = list(size = pointSize))) +
        theme(legend.title = element_text(size = textSize), 
              legend.position = "right",
              legend.text  = element_text(size = textSize),
              legend.key.size = unit(spaceLegend, "lines"))
}
# Apply on original plot
tan_enrich_plot <- addSmallLegend(tan_enrich_plot)
tan_enrich_plot
```

#### 15 brown
```{r}
brown_enrich_results <-
  read_excel(
    paste0(
      "../../../results/",
      tool,
      "/WGCNA/metascape/brown/metascape_result.xlsx"
    ), sheet = 2
  )


GO_ID_brown <- c(
    "1_Summary",
    "2_Summary",
    "3_Summary",
    "4_Summary",
    "5_Summary",
    "6_Summary",
    "7_Summary",
    "8_Summary",
    "9_Summary",
    "10_Summary",
    "11_Summary",
    "12_Summary",
    "13_Summary",
    "14_Summary",
    "15_Summary",
    "16_Summary",
    "17_Summary",
    "18_Summary",
    "19_Summary",    
    "20_Summary"

)

brown_enrich_results_subset <-
  brown_enrich_results[brown_enrich_results$GroupID %in% GO_ID_brown, ]
brown_enrich_results_subset$Cluster <- c("brown")
brown_enrich_results_subset$Description <-
  factor(brown_enrich_results_subset$Description,
         levels = brown_enrich_results_subset$Description)
brown_enrich_results_subset$Description <-
  fct_rev(brown_enrich_results_subset$Description)

brown_gene_count <-
  strsplit(as.character(brown_enrich_results_subset$InTerm_InList),
           "/",
           fixed = T)
brown_gene_count_df <-
  data.frame(matrix(
    unlist(brown_gene_count),
    nrow = length(brown_gene_count),
    byrow = TRUE
  ), stringsAsFactors = FALSE)
brown_enrich_results_subset$InTerm <- as.numeric(brown_gene_count_df$X1)

brown_enrich_results_subset$Description <-
      gsub(
       "regulation of plasma membrane bounded cell projection organization",
        "reg of plasma membrane bounded cell projection",
        brown_enrich_results_subset$Description
      )

brown_enrich_results_subset$Description <- factor(brown_enrich_results_subset$Description, levels = brown_enrich_results_subset$Description)

brown_enrich_results_subset$Description <- factor(brown_enrich_results_subset$Description, levels = rev(brown_enrich_results_subset$Description))

brown_enrich_plot <-
  ggplot(data = brown_enrich_results_subset, aes(x = InTerm, y = Description)) +
  ggplot2::facet_grid(~ Cluster) +
  geom_bar(stat = "identity", aes(fill = LogP), width = .65) +
  theme_bw() +
  scale_y_discrete(expand = c(0, 0)) +
  labs(x = "Gene count", y = "") +
  guides(fill = guide_legend(
    size = 1,
    title = expression(log[10] ~ "(" ~ italic("p") ~ "-value)")
  )) +
  scale_fill_gradientn(
    colours = c("brown", "gray"), # midnightblue
    guide = "legend",
    limits = c(-30,-5)
  ) + theme(strip.text = element_text(size = 8), 
          axis.text.y = element_text(size = 8),
          axis.text.x = element_text(size = 8), 
          axis.title.x = element_text(size = 8), 
          legend.text = element_text(size = 8),
          legend.title = element_text(size = 8),
          legend.margin=margin(0,0.5,0,0),
          legend.box.margin=margin(-10,-2,-10,-7.5), 
          plot.margin = margin(0.1, 0.3, 0.3, 0.1, "cm"), 
          plot.title = element_text(size = 8, hjust = -2.25, vjust=0, margin = margin(0,0,0,0)))
 #  theme(aspect.ratio = 1.5) # to reduce the size of the boxes 
addSmallLegend <- function(brown_enrich_plot, pointSize = 3, textSize = 6, spaceLegend = .5) {
    brown_enrich_plot +
        guides(shape = guide_legend(override.aes = list(size = pointSize)),
               color = guide_legend(override.aes = list(size = pointSize))) +
        theme(legend.title = element_text(size = textSize), 
              legend.position = "right",
              legend.text  = element_text(size = textSize),
              legend.key.size = unit(spaceLegend, "lines"))
}
# Apply on original plot
brown_enrich_plot <- addSmallLegend(brown_enrich_plot)
brown_enrich_plot
```



# Gene-level combine all plots 
```{r}
combined <-
  ggarrange(
    greenyellow_enrich_plot,
    blue_enrich_plot,
    cyan_enrich_plot,
    salmon_enrich_plot,
    red_enrich_plot,
    magenta_enrich_plot,
    black_enrich_plot,
    yellow_enrich_plot,
    pink_enrich_plot,
    green_enrich_plot,
    purple_enrich_plot,
    tan_enrich_plot,
    brown_enrich_plot,
    ncol = 1, 
    nrow = 13,
    labels = c("a)", "b)", "c)", "d)",
               "e)", "f)", "g)", "h)",
               "i)", "j)", "k)", "l)",
               "m)"),
    heights = c(1, 1.5, 1, 1, 1.5, 1.5, 1.5, 1.5, 1.5, 1, 1.5, 1, 1.5),
    font.label = list(size = 8)
  )
combined
path <- paste0("../../../results/manuscript_figures/Supplemental_Figure_WGNCA_GO_terms_ALL")
saveToPDF(paste0(path, ".pdf"), width = 7, height = 30)

combined1 <-
  ggarrange(
    greenyellow_enrich_plot,
    blue_enrich_plot,
    cyan_enrich_plot,
    red_enrich_plot,
    ncol = 1, 
    nrow = 4,
    labels = c("a)", "b)", "c)", "d)"),
    heights = c(.9, 1.3, .9, 1.3),
    font.label = list(size = 8)
  )
combined1
path <- paste0("../../../results/manuscript_figures/Supplemental_Figure_WGNCA_GO_terms_1")
saveToPDF(paste0(path, ".pdf"), width = 7, height = 11)

combined2 <-
  ggarrange(
    black_enrich_plot,
    yellow_enrich_plot,
    pink_enrich_plot,
    ncol = 1, 
    nrow = 3,
    labels = c("a)", "b)", "c)"),
    heights = c(1, 1, 1),
    font.label = list(size = 8)
  )
combined2
path <- paste0("../../../results/manuscript_figures/Supplemental_Figure_WGNCA_GO_terms_2")
saveToPDF(paste0(path, ".pdf"), width = 7, height = 11)

combined3 <-
  ggarrange(
    purple_enrich_plot,
    tan_enrich_plot,
    ncol = 1, 
    nrow = 2,
    labels = c("a)", "b)"),
    heights = c(1, .7),
    font.label = list(size = 8)
  )
combined3
path <- paste0("../../../results/manuscript_figures/Supplemental_Figure_WGNCA_GO_terms_3")
saveToPDF(paste0(path, ".pdf"), width = 7, height = 7)
```
```{r}
```
